var Shogiground=function(){"use strict";const e=["sente","gote"],o=["1","2","3","4","5","6","7","8","9"],t=["a","b","c","d","e","f","g","h","i"],n=Array.prototype.concat(...o.map((e=>t.map((o=>e+o))))),r=e=>n[9*e[0]+e[1]],s=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];const i=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const o=performance.now()-e;return e=void 0,o}}},a=e=>"sente"===e?"gote":"sente",c=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},d=(e,o)=>e.role===o.role&&e.color===o.color,l=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],u=(e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>l(o,e,r,t,n)},p=(e,o,t=!0)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) ${t?"scale(0.5)":""}`},f=(e,o,t=!0)=>{const n=t?1:2;e.style.transform=`translate(${n*o[0]}%,${n*o[1]}%) ${t?"scale(0.5)":""}`},g=(e,o)=>{e.style.visibility=o?"visible":"hidden"},h=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},v=e=>2===e.buttons||2===e.button,m=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t};function b(e,o,t,n){const r=s(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function w(e,o){return Math.abs(e-o)}const y=(e,o,t,n)=>w(e,t)===w(o,n),k=(e,o,t,n)=>e===t||o===n,C=(e,o,t,n)=>w(e,t)<2&&w(o,n)<2;const M=(e,o,t,n)=>C(e,o,t,n)||y(e,o,t,n),S=(e,o,t,n)=>C(e,o,t,n)||k(e,o,t,n),P=n.map(s);function L(e,o,t){const n=e.get(o);if(!n)return[];const i=s(o),a=n.role,c="pawn"===a?(d=n.color,(e,o,t,n)=>"sente"===d?e===t&&o-1===n:e===t&&o+1===n):"knight"===a?function(e){return(o,t,n,r)=>1===w(o,n)&&2===w(t,r)&&("sente"===e?r<t:r>t)}(n.color):"bishop"===a?y:"rook"===a?k:"king"===a?C:"silver"===a?function(e){return(o,t,n,r)=>w(o,n)<2&&w(t,r)<2&&t!==r&&("sente"===e?o!==n||r<t:o!==n||r>t)}(n.color):"lance"===a?function(e){return(o,t,n,r)=>"sente"===e?o===n&&r<t:o===n&&t<r}(n.color):"horse"===a?M:"dragon"===a?S:function(e){return(o,t,n,r)=>w(o,n)<2&&w(t,r)<2&&("sente"===e?r<=t||o===n:r>=t||o===n)}(n.color);var d;return P.filter((e=>(i[0]!==e[0]||i[1]!==e[1])&&c(i[0],i[1],e[0],e[1])&&e[0]<t.files&&e[1]<t.ranks)).map(r)}function x(e,o,t){return"sente"===t?0===o[1]:o[1]===e.ranks-1}function D(e,o,t){const r=o.color,i=o.role;return n.filter((o=>{const n=e.get(o),a=s(o);return(!n||n.color!==r)&&a[0]<t.files&&a[1]<t.ranks&&("pawn"===i||"lance"===i?!x(t,a,r):"knight"!==i||!function(e,o,t){return x(e,o,t)||("sente"===t?1===o[1]:o[1]===e.ranks-2)}(t,a,r))}))}function A(e,...o){e&&setTimeout((()=>e(...o)),1)}function K(e){e.premovable.current&&(e.premovable.current=void 0,A(e.premovable.events.unset))}function $(e){const o=e.predroppable;o.current&&(o.current=void 0,A(o.events.unset))}function O(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);if(o===t||!n)return!1;const s=r&&r.color!==n.color?r:void 0;if(e.hands.enabled&&s){const o=e.hands.captureProcessing(s.role);o&&N(e,{color:a(s.color),role:o})}return t===e.selected&&F(e),A(e.events.move,o,t,s),e.pieces.set(t,n),e.pieces.delete(o),e.lastMove=[o,t],e.check=void 0,A(e.events.change),s||!0}function E(e,o,t,n){if(e.pieces.has(t)){if(!n)return!1;e.pieces.delete(t)}return A(e.events.drop,o,t),e.pieces.set(t,o),e.lastMove=[t],e.check=void 0,A(e.events.change),e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=a(e.turnColor),!0}function H(e,o,t){const n=O(e,o,t);return n&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=a(e.turnColor),e.animation.current=void 0),n}function T(e,o,t,n){const r=e.pieces.get("00");r&&(G(e,o)||t)?(e.pieces.delete("00"),E(e,r,o,t)&&n&&(q(e,r),e.dropmode.active=!1,e.dropmode.piece=void 0),A(e.droppable.events.after,r,o,{premove:!1,predrop:!1})):r&&function(e,o){const t=e.pieces.get("00"),n=e.pieces.get(o);return!!t&&(!n||n.color!==e.activeColor)&&e.predroppable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}(e,o)?function(e,o,t){K(e),e.predroppable.current={role:o,key:t},A(e.predroppable.events.set,o,t)}(e,r.role,o):(K(e),$(e)),e.pieces.delete("00"),F(e)}function B(e,o,t){if(j(e,o,t)){const n=H(e,o,t);if(n){const r=e.hold.stop();F(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),A(e.movable.events.after,o,t,s),!0}}else if(function(e,o,t){return o!==t&&X(e,o)&&L(e.pieces,o,e.dimensions).includes(t)}(e,o,t))return function(e,o,t,n){$(e),e.premovable.current=[o,t],A(e.premovable.events.set,o,t,n)}(e,o,t,{ctrlKey:e.stats.ctrlKey}),F(e),!0;return F(e),!1}function N(e,o,t=1){const n=e.hands.handMap.get(o.color);n&&n.set(o.role,(n.get(o.role)||0)+t)}function q(e,o,t=1){const n=e.hands.handMap.get(o.color),r=null==n?void 0:n.get(o.role);n&&r&&n.set(o.role,Math.max(r-t,0))}function W(e,o,t){if(A(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled)return F(e),void e.hold.cancel();if((e.selectable.enabled||t)&&e.selected!==o&&B(e,e.selected,o))return void(e.stats.dragged=!1)}(z(e,o)||X(e,o))&&(R(e,o),e.hold.start())}function R(e,o){e.selected=o,X(e,o)?e.premovable.dests=L(e.pieces,o,e.dimensions):(e.premovable.dests=void 0,e.predroppable.dropDests=void 0)}function F(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dropDests=void 0,e.hold.cancel()}function z(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function j(e,o,t){var n,r;return o!==t&&z(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function G(e,o){var t,n;const r=e.pieces.get("00");return!!r&&("00"===o||!e.pieces.has(o))&&("both"===e.activeColor||e.activeColor===r.color&&e.turnColor===r.color)&&(e.droppable.free||!!(null===(n=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(r.role))||void 0===n?void 0:n.includes(o)))}function X(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function U(e){var o,t;const n=e.dropmode.active?e.dropmode.piece:null===(o=e.draggable.current)||void 0===o?void 0:o.piece;return!!n&&(e.dropmode.active||"00"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig))&&e.predroppable.enabled&&e.activeColor===n.color&&e.turnColor!==n.color}function Y(e){const o=e.premovable.current;if(!o)return!1;const t=o[0],n=o[1];let r=!1;if(j(e,t,n)){const o=H(e,t,n);if(o){const s={premove:!0};!0!==o&&(s.captured=o),A(e.movable.events.after,t,n,s),r=!0}}return K(e),r}function I(e){K(e),$(e),F(e)}function Q(e){e.activeColor=e.movable.dests=e.droppable.dests=e.animation.current=void 0,I(e)}function V(e,o,t,n){let s=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(s=t.files-1-s);let i=t.ranks-1-Math.floor(t.ranks*(e[1]-n.top)/n.height);return o&&(i=t.ranks-1-i),s>=0&&s<t.files&&i>=0&&i<t.ranks?r([s,i]):void 0}function Z(e){return"sente"===e.orientation}function _(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const J={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function ee(e,o){const t=new Map;let n=o.files-1,s=0;for(let i=0;i<e.length;i++)switch(e[i]){case" ":case"_":return t;case"/":if(++s,s>o.ranks-1)return t;n=o.files-1;break;default:{const o=e[i].charCodeAt(0);if(o<58&&o>47)n-=o-48;else{const o=("+"===e[i]&&e.length>i+1?"+"+e[++i]:e[i]).toLowerCase(),a=_(o);if(n>=0&&a){const c=e[i]===o||"+"+e[i]===o?"gote":"sente";t.set(r([n,s]),{role:a,color:c})}--n}}}return t}function oe(e,o){var t,n,r,s,i;if((null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),te(e,o),null===(s=o.sfen)||void 0===s?void 0:s.board){e.dimensions=function(e){const o=e.split("/"),t=o[0].split("");let n=0,r=0;for(const e of t){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:(n+=r+1,r=0)}return n+=r,{files:n,ranks:o.length}}(o.sfen.board);const t=e.pieces.get("00");e.pieces=ee(o.sfen.board,e.dimensions),t&&e.pieces.set("00",t),e.drawable.shapes=[]}(null===(i=o.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const o=new Map,t=new Map;let n=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)n=10*n+i-48,r=n;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=_(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):t.set(a,(t.get(a)||0)+r)),n=0,r=1}}return new Map([["sente",o],["gote",t]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)}(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&R(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1)}function te(e,o){for(const t in o)ne(e[t])&&ne(o[t])?te(e[t],o[t]):e[t]=o[t]}function ne(e){return"object"==typeof e}function re(e,o){return o.animation.enabled?function(e,o){const t=new Map(o.pieces),r=e(o),s=function(e,o){const t=new Map,r=[],s=new Map,i=[],a=[],c=new Map;let l,u,p;for(const[o,t]of e)c.set(o,ie(o,t));for(const e of n)l=o.pieces.get(e),u=c.get(e),l?u?d(l,u.piece)||(i.push(u),a.push(ie(e,l))):a.push(ie(e,l)):u&&i.push(u);for(const e of a)u=ae(e,i.filter((o=>d(e.piece,o.piece)))),u&&(p=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],t.set(e.key,p.concat(p)),r.push(u.key));for(const e of i)r.includes(e.key)||s.set(e.key,e.piece);return{anims:t,fadings:s}}(t,o);if(s.anims.size||s.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:s},e||ce(o,performance.now())}else o.dom.redraw();return r}(e,o):se(e,o)}function se(e,o){const t=e(o);return o.dom.redraw(),t}function ie(e,o){return{key:e,pos:s(e),piece:o}}function ae(e,o){return o.sort(((o,t)=>c(e.pos,o.pos)-c(e.pos,t.pos)))[0]}function ce(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>ce(e,o)))}var r}const de=["green","red","blue","yellow"];function le(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?F(e):I(e);const t=h(o),n=V(t,Z(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,pos:t,piece:r,brush:he(o)},ue(e))}function ue(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const t=V(o.pos,Z(e),e.dimensions,e.dom.bounds());t!==o.mouseSq&&(o.mouseSq=t,o.dest=t!==o.orig?t:void 0,o.piece=o.dest?void 0:e.drawable.piece,e.dom.redrawNow()),ue(e)}}))}function pe(e,o){e.drawable.current&&(e.drawable.current.pos=h(o))}function fe(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const t=e=>e.orig===o.orig&&e.dest===o.dest,n=e=>e.orig===o.orig&&e.piece&&o.piece&&(e.piece.color!==o.piece.color||e.piece.role!==o.piece.role),r=e.shapes.find(t),s=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!t(e))));r&&r.brush===o.brush&&!s||e.shapes.push(o);!o.piece||r&&r.brush===o.brush&&!s||e.shapes.push({orig:o.orig,brush:o.brush});ve(e)}(e.drawable,o),ge(e))}function ge(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function he(e){var o;const t=(e.shiftKey||e.ctrlKey)&&v(e),n=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return de[(t?1:0)+(n?2:0)]}function ve(e){e.onChange&&e.onChange(e.shapes)}function me(e,o){if(void 0!==o.button&&0!==o.button)return;if(o.touches&&o.touches.length>1)return;const t=e.dom.bounds(),n=h(o),r=V(n,Z(e),e.dimensions,t);if(!r)return;const i=e.pieces.get(r),a=e.selected;var d;a||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(d=e).drawable.shapes.length&&(d.drawable.shapes=[],d.dom.redraw(),ve(d.drawable)),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||i||a||function(e,o){const t=Z(e),n=e.dom.bounds(),r=Math.pow(n.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=b(s,t,e.dimensions,n);if(c(i,o)<=r)return!0}return!1}(e,n))&&o.preventDefault();const l=!!e.premovable.current,f=!!e.predroppable.current||!!e.predroppable.dropDests;e.stats.ctrlKey=o.ctrlKey,e.selected&&j(e,e.selected,r)?re((e=>W(e,r)),e):W(e,r);const v=e.selected===r,m=Se(e,r);if(i&&m&&v&&function(e,o){const t=e.pieces.get(o);return!!t&&e.draggable.enabled&&("both"===e.activeColor||e.activeColor===t.color&&(e.turnColor===t.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:i,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:m,previouslySelected:a,originTarget:o.target},m.sgDragging=!0,m.classList.add("dragging");const c=e.dom.elements.ghost;c&&(c.className=`ghost ${i.color} ${i.role}`,p(c,u(e.dimensions,t)(s(r),Z(e))),g(c,!0)),we(e)}else l&&K(e),f&&$(e);e.dom.redraw()}function be(e,o,t,n,r){const s="00";e.pieces.set(s,o),F(e),e.dom.redraw();const i=h(t);e.draggable.current={orig:s,piece:o,origPos:i,pos:i,started:!0,element:()=>Se(e,s),originTarget:t.target,newPiece:!0,fromHand:n,force:r},U(e)&&(e.predroppable.dropDests=D(e.pieces,o,e.dimensions)),we(e)}function we(e){requestAnimationFrame((()=>{var o;const t=e.draggable.current;if(!t)return;(null===(o=e.animation.current)||void 0===o?void 0:o.plan.anims.has(t.orig))&&(e.animation.current=void 0);const n=e.pieces.get(t.orig);if(n&&d(n,t.piece)){if(!t.started&&c(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.sgDragging=!0,e.classList.add("dragging"),t.element=e}const o=e.dom.bounds();p(t.element,[t.pos[0]-o.left-o.width/(2*e.dimensions.files),t.pos[1]-o.top-o.height/(2*e.dimensions.ranks)])}}else Ce(e);we(e)}))}function ye(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=h(o))}function ke(e,o){const t=e.draggable.current;if(!t)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&t.originTarget!==o.target&&!t.newPiece)return void(e.draggable.current=void 0);K(e),$(e);const n=V(h(o)||t.pos,Z(e),e.dimensions,e.dom.bounds());n&&t.started&&t.orig!==n?t.newPiece?T(e,n,t.force,t.fromHand):(e.stats.ctrlKey=o.ctrlKey,B(e,t.orig,n)&&(e.stats.dragged=!0)):t.newPiece?e.pieces.delete(t.orig):e.draggable.deleteOnDropOff&&!n&&(e.draggable.lastDropOff=t,e.pieces.delete(t.orig),A(e.events.change)),(t.orig!==t.previouslySelected||t.orig!==n&&n)&&e.selectable.enabled||F(e),Me(e),e.draggable.current=void 0,e.dom.redraw()}function Ce(e){const o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,F(e),Me(e),e.dom.redraw())}function Me(e){const o=e.dom.elements;o.ghost&&g(o.ghost,!1)}function Se(e,o){let t=e.dom.elements.board.firstChild;for(;t;){if(t.sgKey===o&&"PIECE"===t.tagName)return t;t=t.nextSibling}}function Pe(e){e.dropmode.active=!1,e.dropmode.piece=void 0}function Le(e,n){function r(){!function(e){e.orientation=a(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),n()}return{set(o){o.orientation&&o.orientation!==e.orientation&&r(),(o.sfen?re:se)((e=>oe(e,o)),e)},state:e,getBoardSfen:()=>function(e,n){const r=o.slice(n.files).reverse();return t.slice(n.ranks).map((o=>r.map((t=>{const n=e.get(t+o);if(n){const e=J[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var t,n;let r="",s="";for(const i of o){const o=null===(t=e.get("sente"))||void 0===t?void 0:t.get(i),a=null===(n=e.get("gote"))||void 0===n?void 0:n.get(i);o&&(r+=o>1?o.toString()+J[i]:J[i]),a&&(s+=a>1?a.toString()+J[i]:J[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.handRoles),toggleOrientation:r,move(o,t){re((e=>O(e,o,t)),e)},drop(o,t){re((e=>E(e,o,t)),e)},setPieces(o){re((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},addToHand(o,t){se((e=>N(e,o,t)),e)},removeFromHand(o,t){se((e=>q(e,o,t)),e)},selectSquare(o,t){o?re((e=>W(e,o,t)),e):e.selected&&(F(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(re(Y,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const o=function(e){const o=e.predroppable.current;let t=!1;if(!o)return!1;if(G(e,o.key)){const n={role:o.role,color:e.activeColor};E(e,n,o.key)&&(A(e.droppable.events.after,n,o.key,{premove:!1,predrop:!0}),t=!0)}return $(e),t}(e);return e.dom.redraw(),o}return!1},cancelPremove(){se(K,e)},cancelPredrop(){se($,e)},cancelMove(){se((e=>{I(e),Ce(e),Pe(e)}),e)},stop(){se((e=>{Q(e),Ce(e),Pe(e)}),e)},setAutoShapes(o){se((e=>e.drawable.autoShapes=o),e)},setShapes(o){se((e=>e.drawable.shapes=o),e)},getKeyAtDomPos:o=>V(o,Z(e),e.dimensions,e.dom.bounds()),redrawAll:n,dragNewPiece(o,t,n,r){be(e,o,t,n,r)},destroy(){Q(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function xe(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function De(e,o,t){const n=e.drawable,r=n.current,s=r&&r.mouseSq?r:void 0,i=new Map,a=e.dom.bounds();for(const e of n.shapes.concat(n.autoShapes).concat(s?[s]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const c=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:Ke(e,i,!1,a)})));s&&c.push({shape:s,current:!0,hash:Ke(s,i,!0,a)});const d=c.map((e=>e.hash)).join(";");if(d===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=d;const l=o.querySelector("defs"),u=o.querySelector("g"),p=t.querySelector("g");!function(e,o,t){const n=new Map;let r;for(const t of o)t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=Ne(r,t.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=t.firstChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextSibling;for(const[e,o]of n.entries())s.has(e)||t.appendChild(He(o))}(n,c,l),Ae(e,c.filter((e=>!e.shape.customSvg)),n.brushes,i,u),Ae(e,c.filter((e=>e.shape.customSvg)),n.brushes,i,p)}function Ae(e,o,t,n,r){const s=e.dom.bounds(),i=new Map,a=[];for(const e of o)i.set(e.hash,!1);let c,d=r.firstChild;for(;d;)c=d.getAttribute("sgHash"),i.has(c)?i.set(c,!0):a.push(d),d=d.nextSibling;for(const e of a)r.removeChild(e);for(const a of o)i.get(a.hash)||r.appendChild(Ee(e,a,t,n,s))}function Ke({orig:e,dest:o,brush:t,piece:n,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,o,t,o&&(i.get(o)||0)>1,n&&$e(n),r&&(d=r,""+(d.lineWidth||"")),s&&Oe(s)].filter((e=>e)).join(",");var d}function $e(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Oe(e){let o=0;for(let t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t)>>>0;return"custom-"+o.toString()}function Ee(e,{shape:o,current:t,hash:n},r,i,a){const c=e.dimensions;let d;if(o.customSvg){const t=Be(s(o.orig),e.orientation,c);d=function(e,o,t,n){const{width:r,height:s}=n,i=r/t.files,a=s/t.ranks,c=o[0]*i,d=(t.ranks-1-o[1])*a,l=Te(xe("g"),{transform:`translate(${c},${d})`}),u=Te(xe("svg"),{width:i,height:i,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(o.customSvg,t,c,a)}else if(o.piece&&!o.dest)d=function(e,o,t,n){const r=Re(e,n,t),s=n.width/t.files*(o.scale||.8),i=Te(xe("foreignObject"),{className:`${o.role} ${o.color}`,x:r[0]-s/2,y:r[1]-s/2,width:s,height:s}),a=m("piece",`${o.color} ${o.role}`);return a.style.width="200%",a.style.height="200%",a.style.margin="-50%",i.append(a),i}(Be(s(o.orig),e.orientation,c),o.piece,c,a);else{const n=Be(s(o.orig),e.orientation,c);if(o.dest){let l=r[o.brush];o.modifiers&&(l=Ne(l,o.modifiers)),d=function(e,o,t,n,r,s,i){const a=function(e,o,t){return(t?20:10)/(55*e.files)*o.width}(s,i,r&&!n),c=Re(o,i,s),d=Re(t,i,s),l=d[0]-c[0],u=d[1]-c[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return Te(xe("line"),{stroke:e.color,"stroke-width":qe(e,s,n,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:We(e,n),x1:c[0],y1:c[1],x2:d[0]-f,y2:d[1]-g})}(l,n,Be(s(o.dest),e.orientation,c),t,(i.get(o.dest)||0)>1,c,a)}else d=function(e,o,t,n,r){const s=Re(o,r,n),i=function(e,o){const t=o.width/(55*e.files);return[3*t,4*t]}(n,r),a=(r.width+r.height)/(4*n.files);return Te(xe("circle"),{stroke:e.color,"stroke-width":i[t?0:1],fill:"none",opacity:We(e,t),cx:s[0],cy:s[1],r:a-i[1]/2})}(r[o.brush],n,t,c,a)}return d.setAttribute("sgHash",n),d}function He(e){const o=Te(xe("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(Te(xe("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("sgKey",e.key),o}function Te(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function Be(e,o,t){return"sente"===o?[t.files-1-e[0],t.ranks-1-e[1]]:e}function Ne(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter((e=>e)).join("")}}function qe(e,o,t,n){return(e.lineWidth||10)*(t?.85:1)/(55*o.files)*n.width}function We(e,o){return(e.opacity||1)*(o?.9:1)}function Re(e,o,t){return[(e[0]+.5)*o.width/t.files,(t.ranks-.5-e[1])*o.height/t.ranks]}function Fe(o,t,n){o.innerHTML="",o.classList.add("sg-wrap",`d-${t.dimensions.files}x${t.dimensions.ranks}`);for(const n of e)o.classList.toggle("orientation-"+n,t.orientation===n);o.classList.toggle("manipulable",!t.viewOnly);const r=m("sg-container");o.appendChild(r);const s=m("sg-board");let i,a,c,d,l;if(r.appendChild(s),t.hands.enabled&&(i=m("sg-hand","hand-top"),a=m("sg-hand","hand-bot"),r.insertBefore(i,s),r.insertBefore(a,s.nextSibling)),t.grid&&r.insertBefore(function(e){const o=90,t=e.files*o,n=e.ranks*o,r=Te(xe("svg"),{class:"sg-grid",viewBox:`0 0 ${t} ${n}`,preserveAspectRatio:"none"});for(let n=0;n<=e.ranks;n++)r.appendChild(Te(xe("line"),{x1:0,x2:t,y1:o*n,y2:o*n}));for(let t=0;t<=e.files;t++)r.appendChild(Te(xe("line"),{x1:o*t,x2:o*t,y1:0,y2:n}));const s=Math.floor((t+n)/o/2),i=Math.floor(e.files/3)*o,a=Math.floor(e.ranks/3)*o;for(const e of[!1,!0])for(const o of[!1,!0])r.appendChild(Te(xe("line"),{x1:e?t-i:i,x2:e?t-i:i,y1:o?n-a:a,y2:o?n-a:a,"stroke-linecap":"round","stroke-width":s}));return r}(t.dimensions),s.nextSibling),t.drawable.visible&&!n&&(c=Te(xe("svg"),{class:"sg-shapes"}),c.appendChild(xe("defs")),c.appendChild(xe("g")),d=Te(xe("svg"),{class:"sg-custom-svgs"}),d.appendChild(xe("g")),r.appendChild(c),r.appendChild(d)),t.coordinates.enabled){const e="gote"===t.orientation?" gote":"",o=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(t.coordinates.notation);r.appendChild(ze(o,"ranks"+e,t.dimensions.ranks)),r.appendChild(ze(["9","8","7","6","5","4","3","2","1"],"files"+e,t.dimensions.files))}return t.draggable.showGhost&&!n&&(l=m("piece","ghost"),g(l,!1),r.appendChild(l)),{board:s,handTop:i,handBot:a,container:r,ghost:l,svg:c,customSvg:d}}function ze(e,o,t){const n=m("coords",o);let r;for(const o of e.slice(-t))r=m("coord"),r.textContent=o,n.appendChild(r);return n}function je(e,o){const t=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(o).observe(t),e.viewOnly)return;const n=function(e){return o=>{e.draggable.current?Ce(e):e.drawable.current?ge(e):o.shiftKey||v(o)?e.drawable.enabled&&le(e,o):e.viewOnly||(e.dropmode.active&&!function(e,o){const t=h(o),n=t&&V(t,Z(e),e.dimensions,e.dom.bounds());return!(!n||!e.pieces.has(n))}(e,o)?function(e,o){if(!e.dropmode.active)return;o.cancelable&&o.preventDefault(),K(e),$(e);const t=e.dropmode.piece;if(t){e.pieces.set("00",t);const n=h(o),r=n&&V(n,Z(e),e.dimensions,e.dom.bounds());r&&(T(e,r,!1,!0),e.dropmode.fromHand&&(e.dropmode.active=!1))}e.dom.redraw()}(e,o):(Pe(e),me(e,o)))}}(e);t.addEventListener("touchstart",n,{passive:!1}),t.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ge(e,o){o.addEventListener("mousedown",Ie(e),{passive:!1}),o.addEventListener("touchstart",Ie(e),{passive:!1}),e.selectable&&(o.addEventListener("mouseup",Qe(e),{passive:!1}),o.addEventListener("touchend",Qe(e),{passive:!1})),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Xe(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function Ue(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function Ye(e){const o=e.dataset.role,t=e.dataset.color;if(o&&t)return{role:o,color:t}}function Ie(e){return o=>{var t;o.preventDefault();const n=Ye(o.target);n&&("both"===e.activeColor||e.activeColor===n.color)&&(null===(t=e.hands.handMap.get(n.color))||void 0===t?void 0:t.get(n.role))&&be(e,n,o,!0,!1)}}function Qe(e){return o=>{var t;const n=Ye(o.target);n&&("both"===e.activeColor||e.activeColor===n.color)&&(null===(t=e.hands.handMap.get(n.color))||void 0===t?void 0:t.get(n.role))&&(!e.draggable.current||Math.abs(e.draggable.current.pos[0]-e.draggable.current.origPos[0])<20&&Math.abs(e.draggable.current.pos[1]-e.draggable.current.origPos[1])<20)&&(e.dropmode.active?Pe(e):function(e,o,t){e.dropmode.active=!0,e.dropmode.piece=o,e.dropmode.fromHand=t,Ce(e),F(e),o&&U(e)&&(e.predroppable.dropDests=D(e.pieces,o,e.dimensions))}(e,n,!0))}}function Ve(e){const o=Z(e),t=e.dom.relative?(S=e.dimensions,(e,o)=>l(e,S,o,50,50)):u(e.dimensions,e.dom.bounds()),n=e.dom.relative?f:p,r=e.dom.elements.board,i=e.dom.elements.handTop,c=e.dom.elements.handBot,d=e.pieces,g=e.animation.current,h=g?g.plan.anims:new Map,v=g?g.plan.fadings:new Map,b=e.draggable.current,w=function(e){var o,t,n,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const o of e.lastMove)o.includes("*")||oo(s,o,"last-move");e.check&&e.highlight.check&&oo(s,e.check,"check");if(e.selected){if(oo(s,e.selected,"selected"),e.movable.showDests){const t=null===(o=e.movable.dests)||void 0===o?void 0:o.get(e.selected);if(t)for(const o of t)oo(s,o,"move-dest"+(e.pieces.has(o)?" oc":""));const n=e.premovable.dests;if(n)for(const o of n)oo(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.dropmode.active||"00"===(null===(t=e.draggable.current)||void 0===t?void 0:t.orig)){const o=e.dropmode.active?e.dropmode.piece:null===(n=e.draggable.current)||void 0===n?void 0:n.piece;if(o&&e.droppable.showDests){const t=null===(r=e.droppable.dests)||void 0===r?void 0:r.get(o.role);if(t)for(const e of t)oo(s,e,"move-dest");const n=e.predroppable.dropDests;if(n&&e.turnColor!==o.color)for(const o of n)oo(s,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)oo(s,e,"current-premove");else e.predroppable.current&&oo(s,e.predroppable.current.key,"current-premove");return s}(e),y=new Set,k=new Set,C=new Map,M=new Map;var S;let P,L,x,D,A,K,$,O,E,H;for(L=r.firstChild;L;){if(P=L.sgKey,Ze(L))if(x=d.get(P),A=h.get(P),K=v.get(P),D=L.sgPiece,!L.sgDragging||b&&b.orig===P||(L.classList.remove("dragging"),n(L,t(s(P),o)),L.sgDragging=!1),!K&&L.sgFading&&(L.sgFading=!1,L.classList.remove("fading")),x){if(A&&L.sgAnimating&&D===eo(x)){const e=s(P);e[0]+=A[2],e[1]+=A[3],L.classList.add("anim"),n(L,t(e,o))}else L.sgAnimating&&(L.sgAnimating=!1,L.classList.remove("anim"),n(L,t(s(P),o)));D!==eo(x)||K&&L.sgFading?K&&D===eo(K)?(L.classList.add("fading"),L.sgFading=!0):ro(C,D,L):y.add(P)}else ro(C,D,L);else if(_e(L)){const e=L.className;w.get(P)===e?k.add(P):ro(M,e,L)}L=L.nextSibling}for(const[e,i]of w)if(!k.has(e)){E=M.get(i),H=E&&E.pop();const a=t(s(e),o);if(H)H.sgKey=e,n(H,a,!1);else{const o=m("square",i);o.sgKey=e,n(o,a,!1),r.insertBefore(o,r.firstChild)}}for(const[e,i]of d)if(A=h.get(e),!y.has(e))if($=C.get(eo(i)),O=$&&$.pop(),O){O.sgKey=e,O.sgFading&&(O.classList.remove("fading"),O.sgFading=!1);const r=s(e);A&&(O.sgAnimating=!0,O.classList.add("anim"),r[0]+=A[2],r[1]+=A[3]),n(O,t(r,o))}else{const a=eo(i),c=m("piece",a),d=s(e);c.sgPiece=a,c.sgKey=e,A&&(c.sgAnimating=!0,d[0]+=A[2],d[1]+=A[3]),n(c,t(d,o)),r.appendChild(c)}e.hands.enabled&&i&&c&&(no(e,a(e.orientation),i),no(e,e.orientation,c));for(const o of C.values())Je(e,o);for(const o of M.values())Je(e,o)}function Ze(e){return"PIECE"===e.tagName}function _e(e){return"SQUARE"===e.tagName}function Je(e,o){for(const t of o)e.dom.elements.board.removeChild(t)}function eo(e){return`${e.color} ${e.role}`}function oo(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function to(e,o){var t;const n=m("piece",eo(e)),r=(null===(t=o.get(e.color))||void 0===t?void 0:t.get(e.role))||0;return n.dataset.role=e.role,n.dataset.color=e.color,n.dataset.nb=r.toString(),n}function no(e,o,t){var n,r;if(t.children.length!==e.hands.handRoles.length){t.innerHTML="";for(const n of e.hands.handRoles)t.appendChild(to({role:n,color:o},e.hands.handMap))}else{let o=t.firstChild;for(;o;){const t=o.dataset.color,s=o.dataset.role,i=(null===(n=e.hands.handMap.get(t))||void 0===n?void 0:n.get(s))||0;o.classList.toggle("selected",e.dropmode.active&&(null===(r=e.dropmode.piece)||void 0===r?void 0:r.color)===t&&e.dropmode.piece.role===s),o.dataset.nb=i.toString(),o=o.nextSibling}}}function ro(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function so(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(e,o){const t={pieces:ee("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",grid:!1,viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,coordinates:{enabled:!0,notation:0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},hands:{handMap:new Map,enabled:!0,handRoles:["rook","bishop","gold","silver","knight","lance","pawn"],captureProcessing:e=>{switch(e){case"tokin":return"pawn";case"promotedlance":return"lance";case"promotedknight":return"knight";case"promotedsilver":return"silver";case"dragon":return"rook";case"horse":return"bishop";case"king":return;default:return e}}},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDropDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,fromHand:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:i()};function n(){const o="dom"in t?t.dom.unbind:void 0,n=t.viewOnly&&!t.drawable.visible,r=Fe(e,t,n),i=function(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}((()=>r.board.getBoundingClientRect())),a=e=>{Ve(d),!e&&r.svg&&r.customSvg&&De(d,r.svg,r.customSvg)},c=()=>{i.clear(),function(e){if(e.dom.relative)return;const o=Z(e),t=u(e.dimensions,e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)Ze(n)&&!n.sgAnimating?p(n,t(s(n.sgKey),o)):_e(n)&&p(n,t(s(n.sgKey),o),!1),n=n.nextSibling}(d),r.svg&&r.customSvg&&De(d,r.svg,r.customSvg)},d=t;var l;return d.dom={elements:r,bounds:i,redraw:so(a),redrawNow:a,unbind:o,relative:n},d.drawable.prevSvgHash="",a(!1),je(d,c),(l=d).hands.enabled&&!l.viewOnly&&l.dom.elements.handTop&&l.dom.elements.handBot&&(Ge(l,l.dom.elements.handBot),Ge(l,l.dom.elements.handTop)),o||(d.dom.unbind=function(e,o){const t=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||t.push(Xe(document.body,"shogiground.resize",o)),!e.viewOnly){const o=Ue(e,ye,pe),n=Ue(e,ke,fe);for(const e of["touchmove","mousemove"])t.push(Xe(document,e,o));for(const e of["touchend","mouseup"])t.push(Xe(document,e,n));const r=()=>e.dom.bounds.clear();t.push(Xe(document,"scroll",r,{capture:!0,passive:!0})),t.push(Xe(window,"resize",r,{passive:!0}))}return()=>t.forEach((e=>e()))}(d,c)),d.events.insert&&d.events.insert(r),d}return oe(t,o||{}),Le(n(),n)}}();
