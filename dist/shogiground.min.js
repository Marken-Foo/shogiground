var Shogiground=function(){"use strict";function e(e){return"PIECE"===e.tagName}function o(e){return"SQ"===e.tagName}const t=["sente","gote"],n=["1","2","3","4","5","6","7","8","9","10","11","12"],r=["a","b","c","d","e","f","g","h","i","j","k","l"],s=Array.prototype.concat(...r.map((e=>n.map((o=>o+e))))),i=e=>s[e[0]+12*e[1]],a=e=>e.length>2?[e.charCodeAt(1)-39,e.charCodeAt(2)-97]:[e.charCodeAt(0)-49,e.charCodeAt(1)-97];function d(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}const c=e=>"sente"===e?"gote":"sente",l=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},u=(e,o)=>e.role===o.role&&e.color===o.color,p=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],f=e=>(o,t)=>p(o,e,t,100,100),g=(e,o,t)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${t}`},h=(e,o,t)=>{e.style.transform=`translate(${o[0]*t}%,${o[1]*t}%) scale(${t})`},m=(e,o)=>{e.style.display=o?"":"none"},v=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},b=e=>2===e.buttons||2===e.button,w=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t};function C(e){return`${e.color} ${e.role}`}function k(e,o,t,n){const r=a(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function y(e,o,t){const n=a(e);let r=t.files-1-n[0]+n[1]*t.files;return o||(r=t.files*t.ranks-1-r),r}function O(e,o){return e.left<=o[0]&&e.top<=o[1]&&e.left+e.width>o[0]&&e.top+e.height>o[1]}function S(e,o,t,n){let r=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(r=t.files-1-r);let s=Math.floor(t.ranks*(e[1]-n.top)/n.height);return o||(s=t.ranks-1-s),r>=0&&r<t.files&&s>=0&&s<t.ranks?i([r,s]):void 0}function M(e,o,n){for(const r of t)for(const t of o){const o={color:r,role:t},s=n.get(C(o));if(s&&O(s,e))return o}}function P(e,o,t,n,r){const s=r.width/n.files,i=r.height/n.ranks;let a=(e-r.left)/s;t&&(a=n.files-1-a);let d=(o-r.top)/i;return t||(d=n.ranks-1-d),[a,d]}function B(e,o){return Math.abs(e-o)}const D=(e,o,t,n)=>B(e,t)===B(o,n),L=(e,o,t,n)=>e===t||o===n,q=(e,o,t,n)=>B(e,t)<2&&B(o,n)<2;const R=(e,o,t,n)=>q(e,o,t,n)||D(e,o,t,n),E=(e,o,t,n)=>q(e,o,t,n)||L(e,o,t,n),A=s.map(a);function x(e,o,t){const n=e.get(o);if(!n)return[];const r=a(o),s=n.role,d="pawn"===s?(c=n.color,(e,o,t,n)=>"sente"===c?e===t&&o-1===n:e===t&&o+1===n):"knight"===s?function(e){return(o,t,n,r)=>1===B(o,n)&&2===B(t,r)&&("sente"===e?r<t:r>t)}(n.color):"bishop"===s?D:"rook"===s?L:"king"===s?q:"silver"===s?function(e){return(o,t,n,r)=>B(o,n)<2&&B(t,r)<2&&t!==r&&("sente"===e?o!==n||r<t:o!==n||r>t)}(n.color):"lance"===s?function(e){return(o,t,n,r)=>"sente"===e?o===n&&r<t:o===n&&t<r}(n.color):"horse"===s?R:"dragon"===s?E:function(e){return(o,t,n,r)=>B(o,n)<2&&B(t,r)<2&&("sente"===e?r<=t||o===n:r>=t||o===n)}(n.color);var c;return A.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&d(r[0],r[1],e[0],e[1])&&e[0]<t.files&&e[1]<t.ranks)).map(i)}function T(e,o,t){return"sente"===t?0===o[1]:o[1]===e.ranks-1}function H(e,o,t){const n=o.color,r=o.role;return s.filter((o=>{const s=e.get(o),i=a(o);return(!s||s.color!==n)&&i[0]<t.files&&i[1]<t.ranks&&("pawn"===r||"lance"===r?!T(t,i,n):"knight"!==r||!function(e,o,t){return T(e,o,t)||("sente"===t?1===o[1]:o[1]===e.ranks-2)}(t,i,n))}))}function $(e,...o){e&&setTimeout((()=>e(...o)),1)}function K(e){e.orientation=c(e.orientation),e.animation.current=e.draggable.current=e.selected=e.selectedPiece=void 0}function N(e){e.lastDests=void 0,e.animation.current=e.draggable.current=void 0,ee(e),F(e),j(e)}function F(e){e.premovable.current&&(e.premovable.current=void 0,$(e.premovable.events.unset))}function j(e){e.predroppable.current&&(e.predroppable.current=void 0,$(e.predroppable.events.unset))}function z(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);if(o===t||!n)return!1;const s=r&&r.color!==n.color?r:void 0;return t===e.selected&&ee(e),$(e.events.move,o,t,s),e.pieces.set(t,n),e.pieces.delete(o),e.lastDests=[o,t],e.check=void 0,$(e.events.change),s||!0}function G(e,o,t){return!(e.pieces.has(t)&&!e.droppable.free)&&($(e.events.drop,o,t),e.pieces.set(t,o),e.lastDests=[t],e.droppable.spare||V(e,o),e.check=void 0,$(e.events.change),!0)}function X(e,o,t){const n=z(e,o,t);return n&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),e.animation.current=void 0),n}function Y(e,o,t){const n=G(e,o,t);return n&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),e.animation.current=void 0),n}function U(e,o,t){if(re(e,o,t)){if(Y(e,o,t))return ee(e),$(e.droppable.events.after,o,t,{premade:!1}),!0}else if(function(e,o,t){const n=e.pieces.get(t);return ie(e,o)&&(!n||n.color!==e.activeColor)&&H(e.pieces,o,e.dimensions).includes(t)}(e,o,t))return function(e,o,t){F(e),e.predroppable.current={piece:o,key:t},$(e.predroppable.events.set,o,t)}(e,o,t),ee(e),!0;return ee(e),!1}function I(e,o,t){if(ne(e,o,t)){const n=X(e,o,t);if(n){ee(e);const r={premade:!1};return!0!==n&&(r.captured=n),$(e.movable.events.after,o,t,r),!0}}else if(function(e,o,t){return o!==t&&se(e,o)&&x(e.pieces,o,e.dimensions).includes(t)}(e,o,t))return function(e,o,t){j(e),e.premovable.current=[o,t],$(e.premovable.events.set,o,t)}(e,o,t),ee(e),!0;return ee(e),!1}function Q(e,o,t=1){const n=e.hands.handMap.get(o.color);n&&e.hands.roles.includes(o.role)&&n.set(o.role,(n.get(o.role)||0)+t)}function V(e,o,t=1){const n=e.hands.handMap.get(o.color),r=null==n?void 0:n.get(o.role);n&&r&&n.set(o.role,Math.max(r-t,0))}function W(e,o,t){if($(e.events.select,o),(e.selectable.enabled||t)&&e.selectedPiece){if(U(e,e.selectedPiece,o))return}else if(e.selected){if(e.selected===o&&!e.draggable.enabled)return void ee(e);if((e.selectable.enabled||t)&&e.selected!==o&&I(e,e.selected,o))return}(oe(e,o)||se(e,o))&&_(e,o)}function Z(e,o,t){$(e.events.pieceSelect,o),!e.draggable.enabled&&e.selectedPiece&&u(e.selectedPiece,o)?ee(e):(te(e,o)||ie(e,o))&&(J(e,o),e.droppable.spare=!!t)}function _(e,o){ee(e),e.selected=o,se(e,o)&&(e.premovable.dests=x(e.pieces,o,e.dimensions))}function J(e,o){ee(e),e.selectedPiece=o,ie(e,o)&&(e.predroppable.dests=H(e.pieces,o,e.dimensions))}function ee(e){e.selected=e.selectedPiece=e.premovable.dests=e.predroppable.dests=void 0}function oe(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function te(e,o){return"both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color}function ne(e,o,t){var n,r;return o!==t&&oe(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function re(e,o,t){var n,r;return te(e,o)&&(e.droppable.free||!!(null===(r=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(o.role))||void 0===r?void 0:r.includes(t)))}function se(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function ie(e,o){return e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function ae(e,o){return e.draggable.enabled&&("both"===e.activeColor||e.activeColor===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function de(e){const o=e.premovable.current;if(!o)return!1;const t=o[0],n=o[1];let r=!1;if(ne(e,t,n)){const o=X(e,t,n);if(o){const s={premade:!0};!0!==o&&(s.captured=o),$(e.movable.events.after,t,n,s),r=!0}}return F(e),r}function ce(e){F(e),j(e),ee(e)}function le(e){e.activeColor=e.movable.dests=e.droppable.dests=e.draggable.current=e.animation.current=void 0,ce(e)}function ue(e){return"sente"===e.orientation}function pe(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const fe={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function ge(e,o){const t=new Map;let n=o.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return t;case"/":if(++r,r>o.ranks-1)return t;n=o.files-1;break;default:{const o=e[s].charCodeAt(0),a=e[s+1]&&e[s+1].charCodeAt(0);if(o<58&&o>47)a&&a<58&&a>47?(n-=10*(o-48)+(a-48),s++):n-=o-48;else{const o=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=pe(o);if(n>=0&&a){const d=e[s]===o||"+"+e[s]===o?"gote":"sente";t.set(i([n,r]),{role:a,color:d})}--n}}}return t}function he(e,o){o.animation&&(ve(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function me(e,o){var t,n,r,s,i;(null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),ve(e,o),(null===(s=o.sfen)||void 0===s?void 0:s.board)&&(e.dimensions=function(e){const o=e.split("/"),t=o[0].split("");let n=0,r=0;for(const e of t){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:"+"!==e&&(n+=r+1,r=0)}return n+=r,{files:n,ranks:o.length}}(o.sfen.board),e.pieces=ge(o.sfen.board,e.dimensions),e.drawable.shapes=[]),(null===(i=o.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const o=new Map,t=new Map;let n=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)n=10*n+i-48,r=n;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=pe(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):t.set(a,(t.get(a)||0)+r)),n=0,r=1}}return new Map([["sente",o],["gote",t]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)}(e,o.check||!1),"lastDests"in o&&!o.lastDests?e.lastDests=void 0:o.lastDests&&(e.lastDests=o.lastDests),e.selected&&_(e,e.selected),e.selectedPiece&&J(e,e.selectedPiece),he(e,o)}function ve(e,o){for(const t in o)be(e[t])&&be(o[t])?ve(e[t],o[t]):e[t]=o[t]}function be(e){return"object"==typeof e}function we(e,o){return o.animation.enabled?function(e,o){const n=new Map(o.pieces),r=new Map([["sente",new Map(o.hands.handMap.get("sente")||new Map)],["gote",new Map(o.hands.handMap.get("gote")||new Map)]]),i=e(o),a=function(e,o,n){const r=new Map,i=[],a=new Map,d=[],c=[],l=new Map;for(const[o,t]of e)l.set(o,ke(o,t));for(const e of s){const o=n.pieces.get(e),t=l.get(e);o?t?u(o,t.piece)||(d.push(t),c.push(ke(e,o))):c.push(ke(e,o)):t&&d.push(t)}if(n.animation.hands)for(const e of t){const t=n.hands.handMap.get(e),r=o.get(e);if(r&&t)for(const[o,s]of t){const t={role:o,color:e},i=r.get(o);if(i&&i>s){const e=n.dom.hands.pieceBounds().get(C(t));e&&d.push({pos:P(e.left,e.top,ue(n),n.dimensions,n.dom.board.bounds()),piece:t})}}}for(const e of c){const o=ye(e,d.filter((o=>u(e.piece,o.piece))));if(o){const t=[o.pos[0]-e.pos[0],o.pos[1]-e.pos[1]];r.set(e.key,t.concat(t)),o.key&&i.push(o.key)}}for(const e of d)e.key&&!i.includes(e.key)&&a.set(e.key,e.piece);return{anims:r,fadings:a}}(n,r,o);if(a.anims.size||a.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:a},e||Oe(o,performance.now())}else o.dom.redraw();return i}(e,o):Ce(e,o)}function Ce(e,o){const t=e(o);return o.dom.redraw(),t}function ke(e,o){return{key:e,pos:a(e),piece:o}}function ye(e,o){return o.sort(((o,t)=>l(e.pos,o.pos)-l(e.pos,t.pos)))[0]}function Oe(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>Oe(e,o)))}var r}function Se(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}const Me="outsideArrow";function Pe(e,o,t,n){const r=e.drawable,s=r.current,i=(null==s?void 0:s.dest)?s:void 0,d=!!s&&!i,c=new Map,l=new Map,u=()=>{const o=e.dom.board.bounds();return o.width.toString()+o.height};for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[])){const o=He(e.dest)?C(e.dest):e.dest;o&&!$e(e.dest,e.orig)&&c.set(o,(c.get(o)||0)+1)}for(const e of r.shapes.concat(i?[i]:[]).concat(r.autoShapes))e.piece&&!He(e.orig)&&l.set(e.orig,e);const p=[...l.values()].map((e=>({shape:e,hash:De(e,c,!1,u)}))),g=r.shapes.concat(r.autoShapes).map((e=>({shape:e,hash:De(e,c,!1,u)})));i&&g.push({shape:i,hash:De(i,c,!0,u),current:!0});const m=g.map((e=>e.hash)).join(";")+(d?Me:"");if(m===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=m;const v=o.querySelector("defs"),b=o.querySelector("g"),k=t.querySelector("g");if(function(e,o,t){const n=new Set;for(const o of e)$e(o.shape.dest,o.shape.orig)||n.add(o.shape.brush);o&&n.add(o.brush);const r=new Set;let s=t.firstElementChild;for(;s;)r.add(s.getAttribute("sgKey")),s=s.nextElementSibling;for(const e of n)r.has(e)||t.appendChild(Ae(e))}(g,d?s:void 0,v),Be(g.filter((e=>!e.shape.customSvg&&(!e.shape.piece||e.current))),b,(o=>Re(e,o,c)),d),Be(g.filter((e=>e.shape.customSvg)),k,(o=>Re(e,o,c))),Be(p,n,(o=>function(e,{shape:o,hash:t}){if(!o.piece||He(o.orig))return;const n=o.orig,r=(o.piece.scale||1)*(e.scaleDownPieces?.5:1),s=w("piece",C(o.piece));return s.setAttribute("sgHash",t),s.sgKey=n,s.sgScale=r,h(s,f(e.dimensions)(a(n),ue(e)),r),s}(e,o))),!d&&s&&(s.arrow=void 0),d&&!s.arrow){const o=je(s.orig,e);if(o){const t=Ee(s.brush,o,o,e.squareRatio,!0,!1,!0);t.setAttribute("sgHash",Me),s.arrow=t,b.appendChild(t)}}}function Be(e,o,t,n){const r=new Map,s=[];for(const o of e)r.set(o.hash,!1);n&&r.set(Me,!0);let i,a=o.firstElementChild;for(;a;)i=a.getAttribute("sgHash"),r.has(i)?r.set(i,!0):s.push(a),a=a.nextElementSibling;for(const e of s)o.removeChild(e);for(const n of e)if(!r.get(n.hash)){const e=t(n);e&&o.appendChild(e)}}function De({orig:e,dest:o,brush:t,piece:n,customSvg:r},s,i,a){return[i,(He(e)||He(o))&&a(),He(e)?Le(e):e,He(o)?Le(o):o,t,(s.get(He(o)?C(o):o)||0)>1,n&&Le(n),r&&qe(r)].filter((e=>e)).join(",")}function Le(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function qe(e){let o=0;for(let t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t)>>>0;return"custom-"+o.toString()}function Re(e,{shape:o,current:t,hash:n},r){const s=je(o.orig,e);if(!s)return;let i;if(o.customSvg)i=function(e,o){const[t,n]=o,r=xe(Se("g"),{transform:`translate(${t},${n})`}),s=xe(Se("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return r.appendChild(s),s.innerHTML=e,r}(o.customSvg,s);else{const n=!$e(o.orig,o.dest)&&je(o.dest,e);if(n)i=Ee(o.brush,s,n,e.squareRatio,!!t,(r.get(He(o.dest)?C(o.dest):o.dest)||0)>1,!1);else if($e(o.dest,o.orig)){let n=e.squareRatio;if(He(o.orig)){const t=e.dom.hands.pieceBounds().get(C(o.orig)),r=e.dom.board.bounds();if(t){const o=t.height/(r.height/e.dimensions.files);n=[o*e.squareRatio[0],o*e.squareRatio[1]]}}i=function(e,o,t,n){const r=o,s=function(e){return[3/64*Ne(e),4/64*Ne(e)]}(t);return xe(Se("ellipse"),{class:e,"stroke-width":s[n?0:1],fill:"none",cx:r[0],cy:r[1],rx:t[0]/2-s[1]/2,ry:t[1]/2-s[1]/2})}(o.brush,s,n,!!t)}}return i?(i.setAttribute("sgHash",n),i):void 0}function Ee(e,o,t,n,r,s,i){const a=function(e,o){return(e?20:10)/64*Ne(o)}(s&&!r,n),d=o,c=t,l=c[0]-d[0],u=c[1]-d[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return xe(Se("line"),{class:Ke(e,r,i),"stroke-width":Fe(r,n),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e+")",x1:d[0],y1:d[1],x2:c[0]-f,y2:c[1]-g})}function Ae(e){const o=xe(Se("marker"),{id:"arrowhead-"+e,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(xe(Se("path"),{d:"M0,0 V4 L3,2 Z"})),o.setAttribute("sgKey",e),o}function xe(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function Te(e,o,t,n){return"sente"===o?[(t.files-1-e[0])*n[0],e[1]*n[1]]:[e[0]*n[0],(t.ranks-1-e[1])*n[1]]}function He(e){return"object"==typeof e}function $e(e,o){return He(e)&&He(o)&&u(e,o)||e===o}function Ke(e,o,t){return e+(o?" current":"")+(t?" outside":"")}function Ne(e){return(e[0]+e[1])/2}function Fe(e,o){return(e?8.5:10)/64*Ne(o)}function je(e,o){if(He(e)){const t=o.dom.hands.pieceBounds().get(C(e)),n=ue(o)?[.5,-.5]:[-.5,.5],r=t&&P(t.left+t.width/2,t.top+t.height/2,ue(o),o.dimensions,o.dom.board.bounds());return r&&Te([r[0]+n[0],r[1]+n[1]],o.orientation,o.dimensions,o.squareRatio)}return Te(a(e),o.orientation,o.dimensions,o.squareRatio)}const ze=["primary","alternative0","alternative1","alternative2"];function Ge(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const t=e.dom.board.bounds(),n=S(o.pos,ue(e),e.dimensions,t)||M(o.pos,e.hands.roles,e.dom.hands.pieceBounds());if(o.dest===n||o.dest&&n&&$e(n,o.dest)||(o.dest=n,e.dom.redrawNow()),!o.dest&&o.arrow){const n=Te(P(o.pos[0],o.pos[1],ue(e),e.dimensions,t),e.orientation,e.dimensions,e.squareRatio);xe(o.arrow,{x2:n[0]-e.squareRatio[0]/2,y2:n[1]-e.squareRatio[1]/2})}Ge(e)}}))}function Xe(e,o){e.drawable.current&&(e.drawable.current.pos=v(o))}function Ye(e,o){const t=e.drawable.current;t&&(!function(e,o){if(!o.dest)return;const t=e=>$e(o.orig,e.orig)&&$e(o.dest,e.dest),n=o.piece;o.piece=void 0;const r=e.shapes.find(t),s=e.shapes.find((e=>t(e)&&n&&e.piece&&u(n,e.piece))),i=e.shapes.find((e=>t(e)&&n&&e.piece&&!u(n,e.piece)));r&&(e.shapes=e.shapes.filter((e=>!t(e))));He(o.orig)||!n||s||(e.shapes.push({orig:o.orig,dest:o.orig,piece:n,brush:o.brush}),$e(o.orig,o.dest)||e.shapes.push({orig:o.orig,dest:o.orig,brush:o.brush}));r&&!i&&r.brush===o.brush||e.shapes.push(o);Ve(e)}(e.drawable,t),Ue(e))}function Ue(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ie(e){const o=e.drawable.shapes.length;(o||e.drawable.piece)&&(e.drawable.shapes=[],e.drawable.piece=void 0,e.dom.redraw(),o&&Ve(e.drawable))}function Qe(e){var o;const t=(e.shiftKey||e.ctrlKey)&&b(e),n=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return ze[(t?1:0)+(n?2:0)]}function Ve(e){e.onChange&&e.onChange(e.shapes)}function We(e,o){const t=e.dom.board.bounds(),n=v(o),r=n&&S(n,ue(e),e.dimensions,t);if(!r)return;const s=e.pieces.get(r),i=e.selected;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||Ie(e),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||e.selectedPiece||s||i||function(e,o){const t=ue(e),n=e.dom.board.bounds(),r=Math.pow(n.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=k(s,t,e.dimensions,n);if(l(i,o)<=r)return!0}return!1}(e,n))&&o.preventDefault();const a=!!e.premovable.current,d=!!e.predroppable.current;var c,u;e.selectable.deleteOnTouch?(u=r,(c=e).pieces.delete(u)&&$(c.events.change)):e.selectedPiece&&re(e,e.selectedPiece,r)||e.selected&&ne(e,e.selected,r)?we((e=>W(e,r)),e):W(e,r);const p=e.selected===r,f=e.dom.board.elements.dragged;if(s&&f&&p&&ae(e,s)){const t="touchstart"===o.type;e.draggable.current={piece:s,pos:n,origPos:n,started:e.draggable.autoDistance&&!t,touch:t,originTarget:o.target,fromBoard:{orig:r,previouslySelected:i,keyHasChanged:!1}},f.sgColor=s.color,f.sgRole=s.role,f.className=`dragging ${C(s)}`,f.classList.toggle("touch",t),_e(e)}else a&&F(e),d&&j(e);e.dom.redraw()}function Ze(e,o,t,n){const r=e.selectedPiece,s=e.dom.board.elements.dragged,i=v(t),a="touchstart"===t.type;if(!s)return;!r&&!n&&e.drawable.enabled&&e.drawable.eraseOnClick&&Ie(e),Z(e,o,n);const d=!!e.premovable.current,c=!!e.predroppable.current;ae(e,o)?(e.draggable.current={piece:o,pos:i,origPos:i,touch:a,started:e.draggable.autoDistance&&!a,originTarget:t.target,fromOutside:{originBounds:n?void 0:e.dom.hands.pieceBounds().get(C(o)),leftOrigin:!1,previouslySelectedPiece:n?void 0:r}},s.sgColor=o.color,s.sgRole=o.role,s.className=`dragging ${C(o)}`,s.classList.toggle("touch",a),_e(e)):(d&&F(e),c&&j(e)),e.dom.redraw()}function _e(e){requestAnimationFrame((()=>{var o,t;const n=e.draggable.current,r=e.dom.board.elements.dragged;if(!n||!r)return;(null===(o=n.fromBoard)||void 0===o?void 0:o.orig)&&(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.fromBoard.orig))&&(e.animation.current=void 0);const s=n.fromBoard?e.pieces.get(n.fromBoard.orig):n.piece;if(s&&u(s,n.piece)){if(!n.started&&l(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0,e.dom.redraw()),n.started){const o=e.dom.board.bounds();g(r,[n.pos[0]-o.left-o.width/(2*e.dimensions.files),n.pos[1]-o.top-o.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),r.sgDragging||(r.sgDragging=!0,m(r,!0));const t=S(n.pos,ue(e),e.dimensions,o);if(n.fromBoard?n.fromBoard.keyHasChanged=n.fromBoard.keyHasChanged||n.fromBoard.orig!==t:n.fromOutside&&(n.fromOutside.leftOrigin=n.fromOutside.leftOrigin||!!n.fromOutside.originBounds&&!O(n.fromOutside.originBounds,n.pos)),t!==n.hovering){const r=n.hovering;n.hovering=t,function(e,o){var t;const n=ue(e),r=e.dom.board.elements.squares.children,s=(null===(t=e.draggable.current)||void 0===t?void 0:t.hovering)&&y(e.draggable.current.hovering,n,e.dimensions),i=s&&r[s];i&&i.classList.add("hover");const a=o&&y(o,n,e.dimensions),d=a&&r[a];d&&d.classList.remove("hover")}(e,r),n.touch&&e.dom.board.elements.squareOver&&(t&&e.draggable.showTouchSquareOverlay?(g(e.dom.board.elements.squareOver,((e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>p(o,e,r,t,n)})(e.dimensions,o)(a(t),ue(e)),1),m(e.dom.board.elements.squareOver,!0)):m(e.dom.board.elements.squareOver,!1))}}}else oo(e);_e(e)}))}function Je(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=v(o))}function eo(e,o){var t,n,r;const s=e.draggable.current;if(!s)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&s.originTarget!==o.target&&!s.fromOutside)return void(e.draggable.current=void 0);F(e),j(e);const i=S(v(o)||s.pos,ue(e),e.dimensions,e.dom.board.bounds());if(i&&s.started&&(null===(t=s.fromBoard)||void 0===t?void 0:t.orig)!==i)s.fromOutside?U(e,s.piece,i):s.fromBoard&&I(e,s.fromBoard.orig,i);else if(e.draggable.deleteOnDropOff&&!i){if(s.fromBoard?e.pieces.delete(s.fromBoard.orig):s.fromOutside&&V(e,s.piece),e.draggable.addToHandOnDropOff){const o=e.dom.hands.bounds(),t=o.get("top"),n=o.get("bottom");t&&O(t,s.pos)?Q(e,{color:c(e.orientation),role:s.piece.role}):n&&O(n,s.pos)&&Q(e,{color:e.orientation,role:s.piece.role})}$(e.events.change)}!s.fromBoard||s.fromBoard.orig!==s.fromBoard.previouslySelected&&!s.fromBoard.keyHasChanged||s.fromBoard.orig!==i&&i?(null===(n=s.fromOutside)||void 0===n?void 0:n.leftOrigin)||(null===(r=s.fromOutside)||void 0===r?void 0:r.originBounds)&&O(s.fromOutside.originBounds,s.pos)&&s.fromOutside.previouslySelectedPiece&&u(s.fromOutside.previouslySelectedPiece,s.piece)?ee(e):e.selectable.enabled||ee(e):ee(e),e.draggable.current=void 0,e.dom.redraw()}function oo(e){e.draggable.current&&(e.draggable.current=void 0,ee(e),e.dom.redraw())}function to(e){return!e.isTrusted||void 0!==e.button&&0!==e.button||!!e.touches&&e.touches.length>1}function no(e){e.promotion.active=!1,e.promotion.key=void 0,e.promotion.pieces=void 0}function ro(e,o){return{set(t){var n,r;let s=!1;t.orientation&&t.orientation!==e.orientation&&(K(e),s=!0),void 0!==t.viewOnly&&t.viewOnly!==e.viewOnly&&(e.viewOnly=t.viewOnly,N(e),s=!0),void 0!==t.viewOnly&&t.viewOnly!==e.viewOnly&&(e.viewOnly=t.viewOnly,N(e),s=!0),void 0!==(null===(n=t.hands)||void 0===n?void 0:n.roles)&&t.hands.roles!==e.hands.roles&&(e.hands.roles=t.hands.roles,s=!0),s&&o(),he(e,t),((null===(r=t.sfen)||void 0===r?void 0:r.board)?we:Ce)((e=>me(e,t)),e)},state:e,getBoardSfen:()=>function(e,o){const t=n.slice(0,o.files).reverse();return r.slice(0,o.ranks).map((o=>t.map((t=>{const n=e.get(t+o);if(n){const e=fe[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var t,n;let r="",s="";for(const i of o){const o=null===(t=e.get("sente"))||void 0===t?void 0:t.get(i),a=null===(n=e.get("gote"))||void 0===n?void 0:n.get(i);o&&(r+=o>1?o.toString()+fe[i]:fe[i]),a&&(s+=a>1?a.toString()+fe[i]:fe[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.roles),toggleOrientation:function(){K(e),o()},move(o,t){we((e=>z(e,o,t)),e)},drop(o,t,n){we((e=>{e.droppable.spare=!!n,G(e,o,t)}),e)},setPieces(o){we((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},addToHand(o,t){Ce((e=>Q(e,o,t)),e)},removeFromHand(o,t){Ce((e=>V(e,o,t)),e)},startPromotion(o,t){Ce((e=>function(e,o,t){e.promotion.active=!0,e.promotion.key=o,e.promotion.pieces=t}(e,o,t)),e)},stopPromotion(){Ce((e=>no(e)),e)},selectSquare(o,t){o?we((e=>W(e,o,t)),e):e.selected&&(ee(e),e.dom.redraw())},selectPiece(o,t){o?Ce((e=>Z(e,o,t)),e):e.selectedPiece&&(ee(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(we(de,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const o=function(e){const o=e.predroppable.current;let t=!1;return!!o&&(re(e,o.piece,o.key)&&Y(e,o.piece,o.key)&&($(e.droppable.events.after,o.piece,o.key,{premade:!0}),t=!0),j(e),t)}(e);return e.dom.redraw(),o}return!1},cancelPremove(){Ce(F,e)},cancelPredrop(){Ce(j,e)},cancelMove(){Ce((e=>{ce(e),oo(e)}),e)},stop(){Ce((e=>{le(e),oo(e)}),e)},setAutoShapes(o){Ce((e=>e.drawable.autoShapes=o),e)},setShapes(o){Ce((e=>e.drawable.shapes=o),e)},redrawAll:o,dragNewPiece(o,t,n){Ze(e,o,t,n)},destroy(){le(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function so(e,o){var n;const r=w("sg-board"),s=function(e,o){const t=w("sg-squares");for(let n=0;n<e.ranks*e.files;n++){const r=w("sq");r.sgKey=i("sente"===o?[e.files-1-n%e.files,Math.floor(n/e.files)]:[n%e.files,e.files-1-Math.floor(n/e.files)]),t.appendChild(r)}return t}(o.dimensions,o.orientation);r.appendChild(s);const a=w("sg-pieces");let d,c,l,u,p,f;if(r.appendChild(a),o.viewOnly||(d=w("piece"),m(d,!!o.draggable.current),r.appendChild(d),c=w("sg-promotion"),m(c,o.promotion.active),r.appendChild(c),l=w("sg-square-over"),m(l,!!(null===(n=o.draggable.current)||void 0===n?void 0:n.touch)),r.appendChild(l)),o.drawable.visible&&(u=xe(Se("svg"),{class:"sg-shapes",viewBox:`-${o.squareRatio[0]/2} -${o.squareRatio[1]/2} ${o.dimensions.files*o.squareRatio[0]} ${o.dimensions.ranks*o.squareRatio[1]}`}),u.appendChild(Se("defs")),u.appendChild(Se("g")),p=xe(Se("svg"),{class:"sg-custom-svgs",viewBox:`0 0 ${o.dimensions.files*o.squareRatio[0]} ${o.dimensions.ranks*o.squareRatio[1]}`}),p.appendChild(Se("g")),f=w("sg-free-pieces"),r.appendChild(u),r.appendChild(p),r.appendChild(f)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",t=function(e){switch(e){case 2:return["十二","十一","十","九","八","七","六","五","四","三","二","一"];case 3:return["l","k","j","i","h","g","f","e","d","c","b","a"];default:return["12","11","10","9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);r.appendChild(io(t,"ranks"+e,o.dimensions.ranks)),r.appendChild(io(["12","11","10","9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}e.board.innerHTML="",e.board.classList.add("sg-wrap",`d-${o.dimensions.files}x${o.dimensions.ranks}`);for(const n of t)e.board.classList.toggle("orientation-"+n,o.orientation===n);return e.board.classList.toggle("manipulable",!o.viewOnly),e.board.appendChild(r),{board:r,squares:s,pieces:a,promotion:c,squareOver:l,dragged:d,svg:u,customSvg:p,freePieces:f}}function io(e,o,t){const n=w("coords",o);let r;for(const o of e.slice(-t))r=w("coord"),r.textContent=o,n.appendChild(r);return n}function ao(e,o){const t=w("sg-hand");for(const n of o){const o=w("piece",C({role:n,color:e}));o.sgColor=e,o.sgRole=n,t.appendChild(o)}return t}function co(o,t){if("ResizeObserver"in window&&new ResizeObserver(t).observe(o.dom.board.elements.board),o.viewOnly)return;const n=o.dom.board.elements.pieces,r=o.dom.board.elements.promotion,s=function(e){return o=>{e.draggable.current?oo(e):e.drawable.current?Ue(e):o.shiftKey||b(o)?e.drawable.enabled&&function(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?ee(e):ce(e);const t=v(o),n=t&&S(t,ue(e),e.dimensions,e.dom.board.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,dest:void 0,pos:t,piece:r,brush:Qe(o)},Ge(e))}(e,o):e.viewOnly||to(o)||We(e,o)}}(o);if(n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("mousedown",s,{passive:!1}),(o.disableContextMenu||o.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault())),r){const t=t=>function(o,t){t.preventDefault();const n=o.promotion.key,r=t.target;if(o.promotion.active&&n&&r&&e(r)){const e={color:r.sgColor,role:r.sgRole};o.pieces.set(n,e),$(o.promotion.after,e)}else $(o.promotion.cancel);no(o),m(o.dom.board.elements.promotion,!1),o.dom.redraw()}(o,t);r.addEventListener("click",t,{passive:!1}),o.disableContextMenu&&r.addEventListener("contextmenu",(e=>e.preventDefault()))}}function lo(e,o,t){if("ResizeObserver"in window&&new ResizeObserver(t).observe(o),e.viewOnly)return;const n=function(e){return o=>{var t;if(e.promotion.active)return;const n=v(o),r=n&&M(n,e.hands.roles,e.dom.hands.pieceBounds());r&&(e.drawable.enabled&&(e=>4===e.buttons||1===e.button)(o)?(e.drawable.piece&&u(e.drawable.piece,r)?e.drawable.piece=void 0:e.drawable.piece=r,e.dom.redraw()):e.drawable.enabled&&(o.shiftKey||b(o))?function(e,o,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?ee(e):ce(e);const n=v(t);n&&(e.drawable.current={orig:o,dest:void 0,pos:n,brush:Qe(t)},Ge(e))}(e,r,o):e.viewOnly||to(o)||(e.selectable.deleteOnTouch?(V(e,r),e.dom.redraw()):"both"!==e.activeColor&&e.activeColor!==r.color||!(null===(t=e.hands.handMap.get(r.color))||void 0===t?void 0:t.get(r.role))||(!1!==o.cancelable&&o.preventDefault(),Ze(e,r,o))))}}(e);o.addEventListener("mousedown",n,{passive:!1}),o.addEventListener("touchstart",n,{passive:!1}),e.dom.board.elements.promotion&&o.addEventListener("click",(()=>function(e){e.promotion.active&&($(e.promotion.cancel),no(e),e.dom.board.elements.promotion&&m(e.dom.board.elements.promotion,!1),e.dom.redraw())}(e))),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function uo(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function po(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function fo(t){var n,r;const s=ue(t),i=t.scaleDownPieces?.5:1,d=f(t.dimensions),c=t.dom.board.elements.squares,l=t.dom.board.elements.pieces,u=t.dom.board.elements.dragged,p=t.dom.board.elements.squareOver,g=t.dom.hands.elements.top,v=t.dom.hands.elements.bottom,b=t.pieces,k=t.animation.current,y=k?k.plan.anims:new Map,O=k?k.plan.fadings:new Map,S=t.draggable.current,M=function(e){var o,t,n;const r=new Map;if(e.lastDests&&e.highlight.lastDests)for(const o of e.lastDests)ho(r,o,"last-dest");e.check&&e.highlight.check&&ho(r,e.check,"check");(null===(o=e.draggable.current)||void 0===o?void 0:o.hovering)&&ho(r,e.draggable.current.hovering,"hover");if(e.selected){if("both"===e.activeColor||e.activeColor===e.turnColor?ho(r,e.selected,"selected"):ho(r,e.selected,"preselected"),e.movable.showDests){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)ho(r,t,"dest"+(e.pieces.has(t)?" oc":""));const n=e.premovable.dests;if(n)for(const o of n)ho(r,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.selectedPiece&&e.droppable.showDests){const o=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(e.selectedPiece.role);if(o)for(const e of o)ho(r,e,"dest");const t=e.predroppable.dests;if(t)for(const o of t)ho(r,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}const s=e.premovable.current;if(s)for(const e of s)ho(r,e,"current-pre");else e.predroppable.current&&ho(r,e.predroppable.current.key,"current-pre");return r}(t),P=new Set,B=new Map;let D,L,q,R,E,A,x,T;for(!S&&(null==u?void 0:u.sgDragging)&&(u.sgDragging=!1,m(u,!1),p&&m(p,!1)),L=l.firstElementChild;L;){if(e(L))if(D=L.sgKey,q=b.get(D),E=y.get(D),A=O.get(D),R=C({color:L.sgColor,role:L.sgRole}),(null==S?void 0:S.started)&&(null===(n=S.fromBoard)||void 0===n?void 0:n.orig)===D?(L.classList.add("ghost"),L.sgGhost=!0):!L.sgGhost||S&&(null===(r=S.fromBoard)||void 0===r?void 0:r.orig)===D||(L.classList.remove("ghost"),L.sgDragging=!1),!A&&L.sgFading&&(L.sgFading=!1,L.classList.remove("fading")),q){if(E&&L.sgAnimating&&R===C(q)){const e=a(D);e[0]+=E[2],e[1]+=E[3],L.classList.add("anim"),h(L,d(e,s),i)}else L.sgAnimating&&(L.sgAnimating=!1,L.classList.remove("anim"),h(L,d(a(D),s),i));R!==C(q)||A&&L.sgFading?A&&R===C(A)?(L.classList.add("fading"),L.sgFading=!0):vo(B,R,L):P.add(D)}else vo(B,R,L);L=L.nextElementSibling}let H=c.firstElementChild;for(;H&&o(H);)H.className=M.get(H.sgKey)||"",H=H.nextElementSibling;for(const[e,o]of b)if(E=y.get(e),!P.has(e))if(x=B.get(C(o)),T=x&&x.pop(),T){T.sgKey=e,T.sgFading&&(T.classList.remove("fading"),T.sgFading=!1);const o=a(e);E&&(T.sgAnimating=!0,T.classList.add("anim"),o[0]+=E[2],o[1]+=E[3]),h(T,d(o,s),i)}else{const t=w("piece",C(o)),n=a(e);t.sgColor=o.color,t.sgRole=o.role,t.sgKey=e,E&&(t.sgAnimating=!0,n[0]+=E[2],n[1]+=E[3]),h(t,d(n,s),i),l.appendChild(t)}g&&mo(t,g),v&&mo(t,v);for(const e of B.values())go(t,e)}function go(e,o){for(const t of o)e.dom.board.elements.pieces.removeChild(t)}function ho(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function mo(e,o){var t;o.classList.toggle("promotion",e.promotion.active);let n=o.firstElementChild;for(;n;){const o={role:n.sgRole,color:n.sgColor},r=(null===(t=e.hands.handMap.get(o.color))||void 0===t?void 0:t.get(o.role))||0,s=!!e.selectedPiece&&u(o,e.selectedPiece)&&!e.droppable.spare;n.classList.toggle("selected",("both"===e.activeColor||e.activeColor===e.turnColor)&&s),n.classList.toggle("preselected","both"!==e.activeColor&&e.activeColor!==e.turnColor&&s),n.classList.toggle("drawing",!!e.drawable.piece&&u(e.drawable.piece,o)),n.classList.toggle("current-pre",!!e.predroppable.current&&u(e.predroppable.current.piece,o)),n.dataset.nb=r.toString(),n=n.nextElementSibling}}function vo(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function bo(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(e,o){const t={pieces:ge("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,squareRatio:[11,12],disableContextMenu:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,notation:0},highlight:{lastDests:!0,check:!0},animation:{enabled:!0,hands:!0,duration:250},hands:{inlined:!1,handMap:new Map,roles:["rook","bishop","gold","silver","knight","lance","pawn"]},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,spare:!1,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1,addToHandOnDropOff:!1},selectable:{enabled:!0,deleteOnTouch:!1},promotion:{active:!1},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],prevSvgHash:""}};function n(){const o="dom"in t?t.dom.unbind:void 0,n=so(e,t),r=function(e,o){let t,n;return(o.hands.inlined||e.handTop||e.handBottom)&&(t=ao(c(o.orientation),o.hands.roles),n=ao(o.orientation,o.hands.roles),o.hands.inlined&&e.board.firstElementChild?(e.board.insertBefore(t,e.board.firstElementChild),e.board.insertBefore(n,e.board.firstElementChild.nextElementSibling)):(e.handTop&&(e.handTop.innerHTML="",e.handTop.classList.add("hand-top"),e.handTop.appendChild(t)),e.handBottom&&(e.handBottom.innerHTML="",e.handBottom.classList.add("hand-bottom"),e.handBottom.appendChild(n)))),{top:t,bottom:n}}(e,t),s=d((()=>n.pieces.getBoundingClientRect())),i=d((()=>{const e=new Map;return r.top&&e.set("top",r.top.getBoundingClientRect()),r.bottom&&e.set("bottom",r.bottom.getBoundingClientRect()),e})),l=d((()=>{const e=new Map;if(r.top){let o=r.top.firstElementChild;for(;o;){const t={role:o.sgRole,color:o.sgColor};e.set(C(t),o.getBoundingClientRect()),o=o.nextElementSibling}}if(r.bottom){let o=r.bottom.firstElementChild;for(;o;){const t={role:o.sgRole,color:o.sgColor};e.set(C(t),o.getBoundingClientRect()),o=o.nextElementSibling}}return e})),u=e=>{fo(g),function(e){const o=e.dom.board.elements.promotion;if(!(e.promotion.active&&e.promotion.key&&e.promotion.pieces&&o))return;const t=ue(e),n=a(e.promotion.key),r=w("sg-promotion-square"),s=w("sg-promotion-choices");h(r,f(e.dimensions)(n,t),1),e.promotion.pieces.forEach((e=>{const o=w("piece",C(e));o.sgColor=e.color,o.sgRole=e.role,s.appendChild(o)})),o.innerHTML="",r.appendChild(s),o.appendChild(r),m(o,e.promotion.active)}(g),!e&&n.svg&&Pe(g,n.svg,n.customSvg,n.freePieces)},p=()=>{s.clear(),i.clear(),l.clear(),t.drawable.shapes.some((e=>He(e.orig)||He(e.dest)))&&n.svg&&Pe(g,n.svg,n.customSvg,n.freePieces)},g=t;return g.dom={board:{elements:n,bounds:s},hands:{elements:r,pieceBounds:l,bounds:i},wrapElements:e,redraw:bo(u),redrawNow:u,unbind:o},g.drawable.prevSvgHash="",u(!1),co(g,p),function(e,o){e.dom.hands.elements.top&&lo(e,e.dom.hands.elements.top,o),e.dom.hands.elements.bottom&&lo(e,e.dom.hands.elements.bottom,o)}(g,p),o||(g.dom.unbind=function(e,o){const t=[];if("ResizeObserver"in window||t.push(uo(document.body,"shogiground.resize",o)),!e.viewOnly){const o=po(e,Je,Xe),n=po(e,eo,Ye);for(const e of["touchmove","mousemove"])t.push(uo(document,e,o));for(const e of["touchend","mouseup"])t.push(uo(document,e,n));const r=()=>{e.dom.board.bounds.clear(),e.dom.hands.bounds.clear(),e.dom.hands.pieceBounds.clear()};t.push(uo(document,"scroll",r,{capture:!0,passive:!0})),t.push(uo(window,"resize",r,{passive:!0}))}return()=>t.forEach((e=>e()))}(g,p)),g.events.insert&&g.events.insert(n,r),g}return me(t,o||{}),ro(n(),n)}}();
