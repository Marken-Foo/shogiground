var Shogiground=function(){"use strict";function e(e){return r.includes(e)}function o(e){return s.includes(e)}function t(e){return"PIECE"===e.tagName}function n(e){return"SQ"===e.tagName}const r=["sente","gote"],s=["king","rook","bishop","gold","silver","knight","lance","pawn","dragon","horse","promotedsilver","promotedknight","promotedlance","tokin"],i=["1","2","3","4","5","6","7","8","9"],a=["a","b","c","d","e","f","g","h","i"],c=Array.prototype.concat(...a.map((e=>i.map((o=>o+e))))),d=e=>c[e[0]+9*e[1]],l=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];const u=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const o=performance.now()-e;return e=void 0,o}}},p=e=>"sente"===e?"gote":"sente",f=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},g=(e,o)=>e.role===o.role&&e.color===o.color,h=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],m=(e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>h(o,e,r,t,n)},v=(e,o,t)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${t}`},b=(e,o,t)=>{e.style.transform=`translate(${o[0]}%,${o[1]}%) scale(${t})`},w=(e,o)=>{e.style.display=o?"":"none"},k=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},y=e=>2===e.buttons||2===e.button,C=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t};function S(e){return`${e.color} ${e.role}`}function M(e,o,t,n){const r=l(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function P(e,o){return Math.abs(e-o)}const L=(e,o,t,n)=>P(e,t)===P(o,n),D=(e,o,t,n)=>e===t||o===n,E=(e,o,t,n)=>P(e,t)<2&&P(o,n)<2;const q=(e,o,t,n)=>E(e,o,t,n)||L(e,o,t,n),A=(e,o,t,n)=>E(e,o,t,n)||D(e,o,t,n),H=c.map(l);function O(e,o,t){const n=e.get(o);if(!n)return[];const r=l(o),s=n.role,i="pawn"===s?(a=n.color,(e,o,t,n)=>"sente"===a?e===t&&o-1===n:e===t&&o+1===n):"knight"===s?function(e){return(o,t,n,r)=>1===P(o,n)&&2===P(t,r)&&("sente"===e?r<t:r>t)}(n.color):"bishop"===s?L:"rook"===s?D:"king"===s?E:"silver"===s?function(e){return(o,t,n,r)=>P(o,n)<2&&P(t,r)<2&&t!==r&&("sente"===e?o!==n||r<t:o!==n||r>t)}(n.color):"lance"===s?function(e){return(o,t,n,r)=>"sente"===e?o===n&&r<t:o===n&&t<r}(n.color):"horse"===s?q:"dragon"===s?A:function(e){return(o,t,n,r)=>P(o,n)<2&&P(t,r)<2&&("sente"===e?r<=t||o===n:r>=t||o===n)}(n.color);var a;return H.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&i(r[0],r[1],e[0],e[1])&&e[0]<t.files&&e[1]<t.ranks)).map(d)}function K(e,o,t){return"sente"===t?0===o[1]:o[1]===e.ranks-1}function x(e,o,t){const n=o.color,r=o.role;return c.filter((o=>{const s=e.get(o),i=l(o);return(!s||s.color!==n)&&i[0]<t.files&&i[1]<t.ranks&&("pawn"===r||"lance"===r?!K(t,i,n):"knight"!==r||!function(e,o,t){return K(e,o,t)||("sente"===t?1===o[1]:o[1]===e.ranks-2)}(t,i,n))}))}function T(e,...o){e&&setTimeout((()=>e(...o)),1)}function $(e){e.premovable.current&&(e.premovable.current=void 0,T(e.premovable.events.unset))}function N(e){const o=e.predroppable;o.current&&(o.current=void 0,T(o.events.unset))}function W(e,o,t){const n=e.pieces.get(o),r=e.pieces.get(t);if(o===t||!n)return!1;const s=r&&r.color!==n.color?r:void 0;if(e.hands.enabled&&s){const o=e.hands.captureProcessing(s.role);o&&j(e,{color:p(s.color),role:o})}return t===e.selected&&I(e),T(e.events.move,o,t,s),e.pieces.set(t,n),e.pieces.delete(o),e.lastMove=[o,t],e.check=void 0,T(e.events.change),s||!0}function B(e,o,t,n){if(e.pieces.has(t)){if(!n)return!1;e.pieces.delete(t)}return T(e.events.drop,o,t),e.pieces.set(t,o),e.lastMove=[t],e.check=void 0,T(e.events.change),!0}function F(e,o,t){const n=W(e,o,t);return n&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=p(e.turnColor),e.animation.current=void 0),n}function z(e,o,t,n){const r=B(e,o,t,n);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=p(e.turnColor),e.animation.current=void 0),r}function R(e,o,t,n,r){_(e,o,t)||n?(z(e,o,t,n)&&r&&(X(e,o),Q(e)),T(e.droppable.events.after,o,t,{premove:!1,predrop:!1})):function(e,o,t){const n=e.pieces.get(t);return ee(e,o)&&(!n||n.color!==e.activeColor)&&x(e.pieces,o,e.dimensions).includes(t)}(e,o,t)?function(e,o,t){$(e),e.predroppable.current={piece:o,key:t},T(e.predroppable.events.set,o,t)}(e,o,t):($(e),N(e)),I(e)}function G(e,o,t){if(Z(e,o,t)){const n=F(e,o,t);if(n){const r=e.hold.stop();I(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),T(e.movable.events.after,o,t,s),!0}}else if(function(e,o,t){return o!==t&&J(e,o)&&O(e.pieces,o,e.dimensions).includes(t)}(e,o,t))return function(e,o,t,n){N(e),e.premovable.current=[o,t],T(e.premovable.events.set,o,t,n)}(e,o,t,{ctrlKey:e.stats.ctrlKey}),I(e),!0;return I(e),!1}function j(e,o,t=1){const n=e.hands.handMap.get(o.color);n&&n.set(o.role,(n.get(o.role)||0)+t)}function X(e,o,t=1){const n=e.hands.handMap.get(o.color),r=null==n?void 0:n.get(o.role);n&&r&&n.set(o.role,Math.max(r-t,0))}function Y(e,o,t){if(T(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled)return I(e),void e.hold.cancel();if((e.selectable.enabled||t)&&e.selected!==o&&G(e,e.selected,o))return void(e.stats.dragged=!1)}(V(e,o)||J(e,o))&&(U(e,o),e.hold.start())}function U(e,o){e.selected=o,J(e,o)?e.premovable.dests=O(e.pieces,o,e.dimensions):(e.premovable.dests=void 0,e.predroppable.dests=void 0)}function I(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dests=void 0,e.hold.cancel()}function Q(e){e.dropmode.active=!1,e.dropmode.piece=void 0}function V(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function Z(e,o,t){var n,r;return o!==t&&V(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function _(e,o,t){var n,r;return!e.pieces.has(t)&&("both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color)&&(e.droppable.free||!!(null===(r=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(o.role))||void 0===r?void 0:r.includes(t)))}function J(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function ee(e,o){var t;return(e.dropmode.active||!!(null===(t=e.draggable.current)||void 0===t?void 0:t.newPiece))&&e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function oe(e){const o=e.premovable.current;if(!o)return!1;const t=o[0],n=o[1];let r=!1;if(Z(e,t,n)){const o=F(e,t,n);if(o){const s={premove:!0};!0!==o&&(s.captured=o),T(e.movable.events.after,t,n,s),r=!0}}return $(e),r}function te(e){$(e),N(e),I(e),Q(e)}function ne(e){e.activeColor=e.movable.dests=e.droppable.dests=e.animation.current=void 0,te(e)}function re(e,o,t,n){let r=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(r=t.files-1-r);let s=t.ranks-1-Math.floor(t.ranks*(e[1]-n.top)/n.height);return o&&(s=t.ranks-1-s),r>=0&&r<t.files&&s>=0&&s<t.ranks?d([r,s]):void 0}function se(e){return"sente"===e.orientation}function ie(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const ae={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function ce(e,o){const t=new Map;let n=o.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return t;case"/":if(++r,r>o.ranks-1)return t;n=o.files-1;break;default:{const o=e[s].charCodeAt(0);if(o<58&&o>47)n-=o-48;else{const o=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),i=ie(o);if(n>=0&&i){const a=e[s]===o||"+"+e[s]===o?"gote":"sente";t.set(d([n,r]),{role:i,color:a})}--n}}}return t}function de(e,o){o.animation&&(ue(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function le(e,o){var t,n,r,s,i;(null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),ue(e,o),(null===(s=o.sfen)||void 0===s?void 0:s.board)&&(e.dimensions=function(e){const o=e.split("/"),t=o[0].split("");let n=0,r=0;for(const e of t){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:(n+=r+1,r=0)}return n+=r,{files:n,ranks:o.length}}(o.sfen.board),e.pieces=ce(o.sfen.board,e.dimensions),e.drawable.shapes=[]),(null===(i=o.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const o=new Map,t=new Map;let n=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)n=10*n+i-48,r=n;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=ie(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):t.set(a,(t.get(a)||0)+r)),n=0,r=1}}return new Map([["sente",o],["gote",t]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)}(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&U(e,e.selected),de(e,o)}function ue(e,o){for(const t in o)pe(e[t])&&pe(o[t])?ue(e[t],o[t]):e[t]=o[t]}function pe(e){return"object"==typeof e}function fe(e,o){return o.animation.enabled?function(e,o){const t=new Map(o.pieces),n=e(o),r=function(e,o){const t=new Map,n=[],r=new Map,s=[],i=[],a=new Map;let d,l,u;for(const[o,t]of e)a.set(o,he(o,t));for(const e of c)d=o.pieces.get(e),l=a.get(e),d?l?g(d,l.piece)||(s.push(l),i.push(he(e,d))):i.push(he(e,d)):l&&s.push(l);for(const e of i)l=me(e,s.filter((o=>g(e.piece,o.piece)))),l&&(u=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],t.set(e.key,u.concat(u)),n.push(l.key));for(const e of s)n.includes(e.key)||r.set(e.key,e.piece);return{anims:t,fadings:r}}(t,o);if(r.anims.size||r.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:r},e||ve(o,performance.now())}else o.dom.redraw();return n}(e,o):ge(e,o)}function ge(e,o){const t=e(o);return o.dom.redraw(),t}function he(e,o){return{key:e,pos:l(e),piece:o}}function me(e,o){return o.sort(((o,t)=>f(e.pos,o.pos)-f(e.pos,t.pos)))[0]}function ve(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>ve(e,o)))}var r}const be=["green","red","blue","yellow"];function we(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?I(e):te(e);const t=k(o),n=re(t,se(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,pos:t,piece:r,brush:Me(o)},ke(e))}function ke(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const t=re(o.pos,se(e),e.dimensions,e.dom.bounds());t!==o.mouseSq&&(o.mouseSq=t,o.dest=t!==o.orig?t:void 0,o.piece=o.dest?void 0:e.drawable.piece,e.dom.redrawNow()),ke(e)}}))}function ye(e,o){e.drawable.current&&(e.drawable.current.pos=k(o))}function Ce(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const t=e=>e.orig===o.orig&&e.dest===o.dest,n=e=>e.orig===o.orig&&e.piece&&o.piece&&(e.piece.color!==o.piece.color||e.piece.role!==o.piece.role),r=e.shapes.find(t),s=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!t(e))));r&&r.brush===o.brush&&!s||e.shapes.push(o);!o.piece||r&&r.brush===o.brush&&!s||e.shapes.push({orig:o.orig,brush:o.brush});Pe(e)}(e.drawable,o),Se(e))}function Se(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Me(e){var o;const t=(e.shiftKey||e.ctrlKey)&&y(e),n=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return be[(t?1:0)+(n?2:0)]}function Pe(e){e.onChange&&e.onChange(e.shapes)}function Le(e,o){if(!o.isTrusted||void 0!==o.button&&0!==o.button)return;if(o.touches&&o.touches.length>1)return;const t=e.dom.bounds(),n=k(o),r=n&&re(n,se(e),e.dimensions,t);if(!r||!n)return;const s=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Pe(a.drawable)),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||s||i||function(e,o){const t=se(e),n=e.dom.bounds(),r=Math.pow(n.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=M(s,t,e.dimensions,n);if(f(i,o)<=r)return!0}return!1}(e,n))&&o.preventDefault();const c=!!e.premovable.current,d=!!e.predroppable.current||!!e.predroppable.dests;e.stats.ctrlKey=o.ctrlKey,e.selected&&Z(e,e.selected,r)?fe((e=>Y(e,r)),e):Y(e,r);const l=e.selected===r;if(s&&l&&function(e,o){const t=e.pieces.get(o);return!!t&&e.draggable.enabled&&("both"===e.activeColor||e.activeColor===t.color&&(e.turnColor===t.color||e.premovable.enabled))}(e,r)){const t="touchstart"===o.type,a=S(s),c=e.dom.elements.dragged;e.draggable.current={orig:r,piece:s,touch:t,origPos:n,pos:n,started:e.draggable.autoDistance&&!t,previouslySelected:i,originTarget:o.target,keyHasChanged:!1},c.sgPiece=a,c.className=`dragging ${a}`,c.classList.toggle("touch",t),Ee(e)}else c&&$(e),d&&N(e);e.dom.redraw()}function De(e,o,t,n,r){var s;e.pieces.set("00",o),I(e),e.dom.redraw();const i=k(t),a=S(o),c="touchstart"===t.type,d=e.dom.elements.dragged;e.draggable.current={orig:"00",piece:o,touch:c,origPos:i,pos:i,started:!0,originTarget:t.target,newPiece:!0,fromHand:n,force:r,keyHasChanged:e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.role)===o.role&&e.dropmode.piece.color===o.color},d.sgPiece=a,d.className=`dragging ${a}`,d.classList.toggle("touch",c),ee(e,o)&&(e.predroppable.dests=x(e.pieces,o,e.dimensions)),n&&(e.dropmode.active=!0,e.dropmode.piece=o),Ee(e)}function Ee(e){requestAnimationFrame((()=>{var o;const t=e.draggable.current;if(!t)return;(null===(o=e.animation.current)||void 0===o?void 0:o.plan.anims.has(t.orig))&&(e.animation.current=void 0);const r=e.pieces.get(t.orig);if(r&&g(r,t.piece)){if(!t.started&&f(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0,e.dom.redraw()),t.started){const o=e.dom.elements.dragged,r=e.dom.bounds();v(o,[t.pos[0]-r.left-r.width/(2*e.dimensions.files),t.pos[1]-r.top-r.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),o.sgDragging||(o.sgDragging=!0,w(o,!0));const s=re(t.pos,se(e),e.dimensions,r);if(t.keyHasChanged=t.keyHasChanged||!t.newPiece&&t.orig!==s||!!t.fromHand&&f(t.pos,t.origPos)>=Math.pow(e.draggable.distance,4),s!==t.hovering){const o=t.hovering;t.hovering=s,function(e,o){var t;let r=e.dom.elements.squares.firstElementChild;for(;r&&n(r);){const n=r.sgKey;(null===(t=e.draggable.current)||void 0===t?void 0:t.hovering)===n?r.classList.add("hover"):o===n&&r.classList.remove("hover"),r=r.nextElementSibling}}(e,o),s&&t.touch&&e.draggable.showTouchSquareOverlay?(v(e.dom.elements.squareOver,m(e.dimensions,r)(l(s),se(e)),1),w(e.dom.elements.squareOver,!0)):t.touch&&w(e.dom.elements.squareOver,!1)}}}else He(e);Ee(e)}))}function qe(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=k(o))}function Ae(e,o){const t=e.draggable.current;if(!t)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&t.originTarget!==o.target&&!t.newPiece)return void(e.draggable.current=void 0);$(e),N(e);const n=re(k(o)||t.pos,se(e),e.dimensions,e.dom.bounds());n&&t.started&&t.orig!==n?t.newPiece?(R(e,t.piece,n,t.force,t.fromHand),e.pieces.delete("00")):(e.stats.ctrlKey=o.ctrlKey,G(e,t.orig,n)&&(e.stats.dragged=!0)):t.newPiece?(e.pieces.delete(t.orig),t.fromHand&&t.keyHasChanged&&Q(e)):e.draggable.deleteOnDropOff&&!n&&(e.draggable.lastDropOff=t,e.pieces.delete(t.orig),T(e.events.change)),(t.orig!==t.previouslySelected&&!t.keyHasChanged||t.orig!==n&&n)&&e.selectable.enabled||I(e),e.draggable.current=void 0,e.dom.redraw()}function He(e){const o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,I(e),e.dom.redraw())}function Oe(e){e.promotion.active=!1,e.promotion.key=void 0,e.promotion.pieces=void 0}function Ke(e){const o=e.dom.elements.promotion;if(w(o,e.promotion.active),!e.promotion.active||!e.promotion.key||!e.promotion.pieces||e.viewOnly)return;const t=se(e),n=l(e.promotion.key),r=C("promotion");v(r,m(e.dimensions,e.dom.bounds())(n,t),1),e.promotion.pieces.forEach((e=>{const o=C("piece",S(e));o.dataset.color=e.color,o.dataset.role=e.role,r.appendChild(o)})),o.innerHTML="",o.appendChild(r)}function xe(t,n){n.preventDefault();const r=t.promotion.key,s=function(t){const n=t.dataset.role,r=t.dataset.color;return o(n)&&e(r)?{role:n,color:r}:void 0}(n.target);t.promotion.active&&r&&s?(t.pieces.set(r,s),T(t.promotion.after,s)):T(t.promotion.cancel),Oe(t),w(t.dom.elements.promotion,!1),t.dom.redraw()}function Te(e,o){function t(){!function(e){e.orientation=p(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(o){var n;o.orientation&&o.orientation!==e.orientation&&t(),de(e,o),((null===(n=o.sfen)||void 0===n?void 0:n.board)?fe:ge)((e=>le(e,o)),e)},state:e,getBoardSfen:()=>function(e,o){const t=i.slice(o.files).reverse();return a.slice(o.ranks).map((o=>t.map((t=>{const n=e.get(t+o);if(n){const e=ae[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var t,n;let r="",s="";for(const i of o){const o=null===(t=e.get("sente"))||void 0===t?void 0:t.get(i),a=null===(n=e.get("gote"))||void 0===n?void 0:n.get(i);o&&(r+=o>1?o.toString()+ae[i]:ae[i]),a&&(s+=a>1?a.toString()+ae[i]:ae[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.handRoles),toggleOrientation:t,move(o,t){fe((e=>W(e,o,t)),e)},drop(o,t){fe((e=>B(e,o,t)),e)},setPieces(o){fe((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},addToHand(o,t){ge((e=>j(e,o,t)),e)},removeFromHand(o,t){ge((e=>X(e,o,t)),e)},startPromotion(o,t){ge((e=>function(e,o,t){e.promotion.active=!0,e.promotion.key=o,e.promotion.pieces=t}(e,o,t)),e)},stopPromotion(){ge((e=>Oe(e)),e)},selectSquare(o,t){o?fe((e=>Y(e,o,t)),e):e.selected&&(I(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(fe(oe,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const o=function(e){const o=e.predroppable.current;let t=!1;return!!o&&(_(e,o.piece,o.key)&&z(e,o.piece,o.key)&&(T(e.droppable.events.after,o.piece,o.key,{premove:!1,predrop:!0}),t=!0),N(e),t)}(e);return e.dom.redraw(),o}return!1},cancelPremove(){ge($,e)},cancelPredrop(){ge(N,e)},cancelMove(){ge((e=>{te(e),He(e)}),e)},stop(){ge((e=>{ne(e),He(e)}),e)},setAutoShapes(o){ge((e=>e.drawable.autoShapes=o),e)},setShapes(o){ge((e=>e.drawable.shapes=o),e)},getKeyAtDomPos:o=>re(o,se(e),e.dimensions,e.dom.bounds()),redrawAll:o,dragNewPiece(o,t,n,r){De(e,o,t,n,r)},destroy(){ne(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function $e(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ne(e,o,t,n){const r=e.drawable,s=r.current,i=s&&s.mouseSq?s:void 0,a=new Map,c=e.dom.bounds();for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[]))e.dest&&a.set(e.dest,(a.get(e.dest)||0)+1);const d=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:Be(e,a,!1,c)})));i&&d.push({shape:i,current:!0,hash:Be(i,a,!0,c)});const u=d.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const p=o.querySelector("defs"),f=o.querySelector("g"),g=t.querySelector("g");!function(e,o,t){const n=new Map;let r;for(const t of o)t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=Ye(r,t.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=t.firstElementChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextElementSibling;for(const[e,o]of n.entries())s.has(e)||t.appendChild(Ge(o))}(r,d,p),We(d.filter((e=>!e.shape.customSvg&&!e.shape.piece)),f,(o=>Re(e,o,r.brushes,a,c))),We(d.filter((e=>e.shape.customSvg)),g,(o=>Re(e,o,r.brushes,a,c))),We(d.filter((e=>e.shape.piece)),n,(o=>function(e,{shape:o,hash:t},n){var r;const s=o.orig,i=((null===(r=o.piece)||void 0===r?void 0:r.scale)||1)*(e.scaleDownPieces?.5:1),a=C("piece",S(o.piece));return a.setAttribute("sgHash",t),a.sgKey=s,a.sgScale=i,v(a,m(e.dimensions,n)(l(s),se(e)),i),a}(e,o,c)))}function We(e,o,t){const n=new Map,r=[];for(const o of e)n.set(o.hash,!1);let s,i=o.firstElementChild;for(;i;)s=i.getAttribute("sgHash"),n.has(s)?n.set(s,!0):r.push(i),i=i.nextElementSibling;for(const e of r)o.removeChild(e);for(const r of e)n.get(r.hash)||o.appendChild(t(r))}function Be({orig:e,dest:o,brush:t,piece:n,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,o,t,o&&(i.get(o)||0)>1,n&&Fe(n),r&&(d=r,""+(d.lineWidth||"")),s&&ze(s)].filter((e=>e)).join(",");var d}function Fe(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function ze(e){let o=0;for(let t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t)>>>0;return"custom-"+o.toString()}function Re(e,{shape:o,current:t,hash:n},r,s,i){const a=e.dimensions;let c;if(o.customSvg){const t=Xe(l(o.orig),e.orientation,a);c=function(e,o,t,n){const{width:r,height:s}=n,i=r/t.files,a=s/t.ranks,c=o[0]*i,d=(t.ranks-1-o[1])*a,l=je($e("g"),{transform:`translate(${c},${d})`}),u=je($e("svg"),{width:i,height:i,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(o.customSvg,t,a,i)}else{const n=Xe(l(o.orig),e.orientation,a);if(o.dest){let d=r[o.brush];o.modifiers&&(d=Ye(d,o.modifiers)),c=function(e,o,t,n,r,s,i){const a=function(e,o,t){return(t?20:10)/(55*e.files)*o.width}(s,i,r&&!n),c=Qe(o,i,s),d=Qe(t,i,s),l=d[0]-c[0],u=d[1]-c[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return je($e("line"),{stroke:e.color,"stroke-width":Ue(e,s,n,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Ie(e,n),x1:c[0],y1:c[1],x2:d[0]-f,y2:d[1]-g})}(d,n,Xe(l(o.dest),e.orientation,a),t,(s.get(o.dest)||0)>1,a,i)}else c=function(e,o,t,n,r){const s=Qe(o,r,n),i=function(e,o){const t=o.width/(55*e.files);return[3*t,4*t]}(n,r),a=(r.width+r.height)/(4*n.files);return je($e("circle"),{stroke:e.color,"stroke-width":i[t?0:1],fill:"none",opacity:Ie(e,t),cx:s[0],cy:s[1],r:a-i[1]/2})}(r[o.brush],n,t,a,i)}return c.setAttribute("sgHash",n),c}function Ge(e){const o=je($e("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(je($e("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("sgKey",e.key),o}function je(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function Xe(e,o,t){return"sente"===o?[t.files-1-e[0],t.ranks-1-e[1]]:e}function Ye(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter((e=>e)).join("")}}function Ue(e,o,t,n){return(e.lineWidth||10)*(t?.85:1)/(55*o.files)*n.width}function Ie(e,o){return(e.opacity||1)*(o?.9:1)}function Qe(e,o,t){return[(e[0]+.5)*o.width/t.files,(t.ranks-.5-e[1])*o.height/t.ranks]}function Ve(e,o,t){var n;e.innerHTML="",e.classList.add("sg-wrap",`d-${o.dimensions.files}x${o.dimensions.ranks}`);for(const t of r)e.classList.toggle("orientation-"+t,o.orientation===t);e.classList.toggle("manipulable",!o.viewOnly);const s=C("sg-board");e.appendChild(s);const i=function(e,o){const t=C("sg-squares");for(let n=0;n<e.ranks*e.files;n++){const r=C("sq");r.sgKey=d("sente"===o?[e.files-1-n%e.files,Math.floor(n/e.files)]:[n%e.files,e.files-1-Math.floor(n/e.files)]),t.appendChild(r)}return t}(o.dimensions,o.orientation);s.appendChild(i);const a=C("sg-pieces");s.appendChild(a);const c=C("sg-promotion");s.appendChild(c);const l=C("sg-square-over");w(l,!!(null===(n=o.draggable.current)||void 0===n?void 0:n.touch)),s.appendChild(l);const u=C("piece");let p,f,g,h,m;if(w(u,!!o.draggable.current),s.appendChild(u),o.hands.enabled&&(p=C("sg-hand","hand-top"),f=C("sg-hand","hand-bot"),e.insertBefore(p,s),e.insertBefore(f,s.nextElementSibling)),o.drawable.visible&&!t&&(g=je($e("svg"),{class:"sg-shapes"}),g.appendChild($e("defs")),g.appendChild($e("g")),h=je($e("svg"),{class:"sg-custom-svgs"}),h.appendChild($e("g")),m=C("sg-free-pieces"),s.appendChild(g),s.appendChild(h),s.appendChild(m)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",t=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);s.appendChild(Ze(t,"ranks"+e,o.dimensions.ranks)),s.appendChild(Ze(["9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}return{board:s,squares:i,pieces:a,promotion:c,squareOver:l,dragged:u,svg:g,customSvg:h,freePieces:m,handTop:p,handBot:f}}function Ze(e,o,t){const n=C("coords",o);let r;for(const o of e.slice(-t))r=C("coord"),r.textContent=o,n.appendChild(r);return n}function _e(e,o){const t=e.dom.elements.pieces,n=e.dom.elements.promotion;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(o).observe(t),e.viewOnly)return;const r=function(e){return o=>{e.draggable.current?He(e):e.drawable.current?Se(e):o.shiftKey||y(o)?e.drawable.enabled&&we(e,o):e.viewOnly||(e.dropmode.active&&!function(e,o){const t=k(o),n=t&&re(t,se(e),e.dimensions,e.dom.bounds());return!(!n||!e.pieces.has(n))}(e,o)?function(e,o){if(!e.dropmode.active)return;o.cancelable&&o.preventDefault(),$(e),N(e);const t=e.dropmode.piece;if(t){const n=k(o),r=n&&re(n,se(e),e.dimensions,e.dom.bounds());r&&(R(e,t,r,!1,!0),e.dropmode.fromHand&&Q(e))}e.dom.redraw()}(e,o):(Q(e),Le(e,o)))}}(e);t.addEventListener("touchstart",r,{passive:!1}),t.addEventListener("mousedown",r,{passive:!1});n.addEventListener("click",(o=>xe(e,o)),{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&(t.addEventListener("contextmenu",(e=>e.preventDefault())),n.addEventListener("contextmenu",(e=>e.preventDefault())))}function Je(e,o){o.addEventListener("mousedown",to(e),{passive:!1}),o.addEventListener("touchstart",to(e),{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function eo(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function oo(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function to(t){return n=>{var r;n.preventDefault();const s=function(t){const n=t.dataset.role,r=t.dataset.color;if(o(n)&&e(r))return{role:n,color:r}}(n.target);s&&("both"===t.activeColor||t.activeColor===s.color)&&(null===(r=t.hands.handMap.get(s.color))||void 0===r?void 0:r.get(s.role))&&De(t,s,n,!0,!1)}}function no(e){const o=se(e),r=e.scaleDownPieces?.5:1,s=e.dom.relative?(A=e.dimensions,(e,o)=>h(e,A,o,50,50)):m(e.dimensions,e.dom.bounds()),i=e.dom.relative?b:v,a=e.dom.elements.squares,c=e.dom.elements.pieces,d=e.dom.elements.dragged,u=e.dom.elements.squareOver,f=e.dom.elements.handTop,g=e.dom.elements.handBot,k=e.pieces,y=e.animation.current,M=y?y.plan.anims:new Map,P=y?y.plan.fadings:new Map,L=e.draggable.current,D=function(e){var o,t,n,r,s;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const o of e.lastMove)so(i,o,"last-move");e.check&&e.highlight.check&&so(i,e.check,"check");(null===(o=e.draggable.current)||void 0===o?void 0:o.hovering)&&so(i,e.draggable.current.hovering,"hover");if(e.selected){if(so(i,e.selected,"selected"),e.movable.showDests){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)so(i,t,"move-dest"+(e.pieces.has(t)?" oc":""));const n=e.premovable.dests;if(n)for(const o of n)so(i,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.dropmode.active||(null===(n=e.draggable.current)||void 0===n?void 0:n.newPiece)){const o=e.dropmode.active?e.dropmode.piece:null===(r=e.draggable.current)||void 0===r?void 0:r.piece;if(o&&e.droppable.showDests){const t=null===(s=e.droppable.dests)||void 0===s?void 0:s.get(o.role);if(t)for(const e of t)so(i,e,"move-dest");const n=e.predroppable.dests;if(n&&e.turnColor!==o.color)for(const o of n)so(i,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}const a=e.premovable.current;if(a)for(const e of a)so(i,e,"current-premove");else e.predroppable.current&&so(i,e.predroppable.current.key,"current-premove");return i}(e),E=new Set,q=new Map;var A;let H,O,K,x,T,$,N,W;for(!L&&d.sgDragging&&(d.sgDragging=!1,w(d,!1),w(u,!1)),O=c.firstElementChild;O;){if(t(O))if(H=O.sgKey,K=k.get(H),T=M.get(H),$=P.get(H),x=O.sgPiece,L&&L.orig===H?(O.classList.add("ghost"),O.sgGhost=!0):!O.sgGhost||L&&L.orig===H||(O.classList.remove("ghost"),O.sgDragging=!1),!$&&O.sgFading&&(O.sgFading=!1,O.classList.remove("fading")),K){if(T&&O.sgAnimating&&x===S(K)){const e=l(H);e[0]+=T[2],e[1]+=T[3],O.classList.add("anim"),i(O,s(e,o),r)}else O.sgAnimating&&(O.sgAnimating=!1,O.classList.remove("anim"),i(O,s(l(H),o),r));x!==S(K)||$&&O.sgFading?$&&x===S($)?(O.classList.add("fading"),O.sgFading=!0):co(q,x,O):E.add(H)}else co(q,x,O);O=O.nextElementSibling}let B=a.firstElementChild;for(;B&&n(B);){const e=D.get(B.sgKey)||"";B.className=e,B=B.nextElementSibling}for(const[e,t]of k)if(T=M.get(e),!E.has(e))if(N=q.get(S(t)),W=N&&N.pop(),W){W.sgKey=e,W.sgFading&&(W.classList.remove("fading"),W.sgFading=!1);const t=l(e);T&&(W.sgAnimating=!0,W.classList.add("anim"),t[0]+=T[2],t[1]+=T[3]),i(W,s(t,o),r)}else{const n=S(t),a=C("piece",n),d=l(e);a.sgPiece=n,a.sgKey=e,T&&(a.sgAnimating=!0,d[0]+=T[2],d[1]+=T[3]),i(a,s(d,o),r),c.appendChild(a)}e.hands.enabled&&f&&g&&(ao(e,p(e.orientation),f),ao(e,e.orientation,g));for(const o of q.values())ro(e,o)}function ro(e,o){for(const t of o)e.dom.elements.pieces.removeChild(t)}function so(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function io(e,o,t){var n;const r=C("piece",S(e)),s=(null===(n=o.get(e.color))||void 0===n?void 0:n.get(e.role))||0;return r.dataset.role=e.role,r.dataset.color=e.color,r.dataset.nb=s.toString(),r.classList.toggle("selected",t),r}function ao(e,o,t){var n,r,s;if(t.children.length!==e.hands.handRoles.length){t.innerHTML="";for(const r of e.hands.handRoles)t.appendChild(io({role:r,color:o},e.hands.handMap,e.dropmode.active&&(null===(n=e.dropmode.piece)||void 0===n?void 0:n.color)===o&&e.dropmode.piece.role===r))}else{let n=t.firstElementChild;for(;n;){const t=n.dataset.role,i=(null===(r=e.hands.handMap.get(o))||void 0===r?void 0:r.get(t))||0;n.classList.toggle("selected",e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.color)===o&&e.dropmode.piece.role===t),n.dataset.nb=i.toString(),n=n.nextElementSibling}}}function co(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function lo(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(e,o){const n={pieces:ce("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,notation:0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:250},hands:{enabled:!1,handMap:new Map,handRoles:["rook","bishop","gold","silver","knight","lance","pawn"],captureProcessing:e=>{switch(e){case"tokin":return"pawn";case"promotedlance":return"lance";case"promotedknight":return"knight";case"promotedsilver":return"silver";case"dragon":return"rook";case"horse":return"bishop";case"king":return;default:return e}}},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1},dropmode:{active:!1,fromHand:!0},selectable:{enabled:!0},promotion:{active:!1},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:u()};function r(){const o="dom"in n?n.dom.unbind:void 0,r=n.viewOnly&&!n.drawable.visible,s=Ve(e,n,r),i=function(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}((()=>s.pieces.getBoundingClientRect())),a=e=>{no(d),Ke(d),!e&&s.svg&&s.customSvg&&s.freePieces&&Ne(d,s.svg,s.customSvg,s.freePieces)},c=()=>{i.clear(),function(e){if(e.dom.relative)return;const o=se(e),n=e.scaleDownPieces?.5:1,r=m(e.dimensions,e.dom.bounds());let s=e.dom.elements.pieces.firstElementChild;for(;s;)t(s)&&!s.sgAnimating&&v(s,r(l(s.sgKey),o),n),s=s.nextElementSibling}(d),Ke(d),s.svg&&s.customSvg&&s.freePieces&&Ne(d,s.svg,s.customSvg,s.freePieces)},d=n;var u;return d.dom={elements:s,bounds:i,redraw:lo(a),redrawNow:a,unbind:o,relative:r},d.drawable.prevSvgHash="",a(!1),_e(d,c),(u=d).hands.enabled&&!u.viewOnly&&u.dom.elements.handTop&&u.dom.elements.handBot&&(Je(u,u.dom.elements.handBot),Je(u,u.dom.elements.handTop)),o||(d.dom.unbind=function(e,o){const t=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||t.push(eo(document.body,"shogiground.resize",o)),!e.viewOnly){const o=oo(e,qe,ye),n=oo(e,Ae,Ce);for(const e of["touchmove","mousemove"])t.push(eo(document,e,o));for(const e of["touchend","mouseup"])t.push(eo(document,e,n));const r=()=>e.dom.bounds.clear();t.push(eo(document,"scroll",r,{capture:!0,passive:!0})),t.push(eo(window,"resize",r,{passive:!0}))}return()=>t.forEach((e=>e()))}(d,c)),d.events.insert&&d.events.insert(s),d}return le(n,o||{}),Te(r(),r)}}();
