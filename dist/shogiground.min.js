var Shogiground=function(){"use strict";const e=["sente","gote"],t=["king","rook","bishop","gold","silver","knight","lance","pawn","dragon","horse","promotedsilver","promotedknight","promotedlance","tokin"],o=["1","2","3","4","5","6","7","8","9"],n=["a","b","c","d","e","f","g","h","i"],r=Array.prototype.concat(...o.map((e=>n.map((t=>e+t))))),s=e=>r[9*e[0]+e[1]],i=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];const a=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},c=e=>"sente"===e?"gote":"sente",d=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},l=(e,t)=>e.role===t.role&&e.color===t.color,u=(e,t,o,n,r)=>[(o?t.files-1-e[0]:e[0])*n,(o?e[1]:t.ranks-1-e[1])*r],p=(e,t)=>{const o=t.width/e.files,n=t.height/e.ranks;return(t,r)=>u(t,e,r,o,n)},f=(e,t,o=!0)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) ${o?"scale(0.5)":""}`},g=(e,t,o=!0)=>{const n=o?1:2;e.style.transform=`translate(${n*t[0]}%,${n*t[1]}%) ${o?"scale(0.5)":""}`},h=(e,t)=>{e.style.visibility=t?"visible":"hidden"},v=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},m=e=>2===e.buttons||2===e.button,b=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function w(e,t,o,n){const r=i(e);return t&&(r[0]=o.files-1-r[0],r[1]=o.ranks-1-r[1]),[n.left+n.width*r[0]/o.files+n.width/(2*o.files),n.top+n.height*(o.ranks-1-r[1])/o.ranks+n.height/(2*o.ranks)]}function k(e,t){return Math.abs(e-t)}const y=(e,t,o,n)=>k(e,o)===k(t,n),C=(e,t,o,n)=>e===o||t===n,M=(e,t,o,n)=>k(e,o)<2&&k(t,n)<2;const S=(e,t,o,n)=>M(e,t,o,n)||y(e,t,o,n),P=(e,t,o,n)=>M(e,t,o,n)||C(e,t,o,n),L=r.map(i);function x(e,t,o){const n=e.get(t);if(!n)return[];const r=i(t),a=n.role,c="pawn"===a?(d=n.color,(e,t,o,n)=>"sente"===d?e===o&&t-1===n:e===o&&t+1===n):"knight"===a?function(e){return(t,o,n,r)=>1===k(t,n)&&2===k(o,r)&&("sente"===e?r<o:r>o)}(n.color):"bishop"===a?y:"rook"===a?C:"king"===a?M:"silver"===a?function(e){return(t,o,n,r)=>k(t,n)<2&&k(o,r)<2&&o!==r&&("sente"===e?t!==n||r<o:t!==n||r>o)}(n.color):"lance"===a?function(e){return(t,o,n,r)=>"sente"===e?t===n&&r<o:t===n&&o<r}(n.color):"horse"===a?S:"dragon"===a?P:function(e){return(t,o,n,r)=>k(t,n)<2&&k(o,r)<2&&("sente"===e?r<=o||t===n:r>=o||t===n)}(n.color);var d;return L.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&c(r[0],r[1],e[0],e[1])&&e[0]<o.files&&e[1]<o.ranks)).map(s)}function D(e,t,o){return"sente"===o?0===t[1]:t[1]===e.ranks-1}function A(e,t,o){const n=t.color,s=t.role;return r.filter((t=>{const r=e.get(t),a=i(t);return(!r||r.color!==n)&&a[0]<o.files&&a[1]<o.ranks&&("pawn"===s||"lance"===s?!D(o,a,n):"knight"!==s||!function(e,t,o){return D(e,t,o)||("sente"===o?1===t[1]:t[1]===e.ranks-2)}(o,a,n))}))}function K(e,...t){e&&setTimeout((()=>e(...t)),1)}function H(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function $(e){const t=e.predroppable;t.current&&(t.current=void 0,K(t.events.unset))}function O(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const s=r&&r.color!==n.color?r:void 0;if(e.hands.enabled&&s){const t=e.hands.captureProcessing(s.role);t&&q(e,{color:c(s.color),role:t})}return o===e.selected&&z(e),K(e.events.move,t,o,s),e.pieces.set(o,n),e.pieces.delete(t),e.lastMove=[t,o],e.check=void 0,K(e.events.change),s||!0}function T(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return K(e.events.drop,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,K(e.events.change),e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),!0}function E(e,t,o){const n=O(e,t,o);return n&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),e.animation.current=void 0),n}function B(e,t,o,n,r){t&&(X(e,t,o)||n)?(T(e,t,o,n)&&r&&(W(e,t),e.dropmode.active=!1,e.dropmode.piece=void 0),K(e.droppable.events.after,t,o,{premove:!1,predrop:!1})):t&&function(e,t,o){const n=e.pieces.get(o);return Y(e,t)&&(!n||n.color!==e.activeColor)}(e,t,o)?function(e,t,o){H(e),e.predroppable.current={piece:t,key:o},K(e.predroppable.events.set,t,o)}(e,t,o):(H(e),$(e)),z(e)}function N(e,t,o){if(G(e,t,o)){const n=E(e,t,o);if(n){const r=e.hold.stop();z(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),K(e.movable.events.after,t,o,s),!0}}else if(function(e,t,o){return t!==o&&U(e,t)&&x(e.pieces,t,e.dimensions).includes(o)}(e,t,o))return function(e,t,o,n){$(e),e.premovable.current=[t,o],K(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),z(e),!0;return z(e),!1}function q(e,t,o=1){const n=e.hands.handMap.get(t.color);n&&n.set(t.role,(n.get(t.role)||0)+o)}function W(e,t,o=1){const n=e.hands.handMap.get(t.color),r=null==n?void 0:n.get(t.role);n&&r&&n.set(t.role,Math.max(r-o,0))}function R(e,t,o){if(K(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return z(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&N(e,e.selected,t))return void(e.stats.dragged=!1)}(j(e,t)||U(e,t))&&(F(e,t),e.hold.start())}function F(e,t){e.selected=t,U(e,t)?e.premovable.dests=x(e.pieces,t,e.dimensions):(e.premovable.dests=void 0,e.predroppable.dropDests=void 0)}function z(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dropDests=void 0,e.hold.cancel()}function j(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color)}function G(e,t,o){var n,r;return t!==o&&j(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))}function X(e,t,o){var n,r;return!!t&&!e.pieces.has(o)&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)&&(e.droppable.free||!!(null===(r=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(t.role))||void 0===r?void 0:r.includes(o)))}function U(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function Y(e,t){var o;return(e.dropmode.active||!!(null===(o=e.draggable.current)||void 0===o?void 0:o.newPiece))&&e.predroppable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function I(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(G(e,o,n)){const t=E(e,o,n);if(t){const s={premove:!0};!0!==t&&(s.captured=t),K(e.movable.events.after,o,n,s),r=!0}}return H(e),r}function Q(e){H(e),$(e),z(e)}function V(e){e.activeColor=e.movable.dests=e.droppable.dests=e.animation.current=void 0,Q(e)}function Z(e,t,o,n){let r=Math.floor(o.files*(e[0]-n.left)/n.width);t&&(r=o.files-1-r);let i=o.ranks-1-Math.floor(o.ranks*(e[1]-n.top)/n.height);return t&&(i=o.ranks-1-i),r>=0&&r<o.files&&i>=0&&i<o.ranks?s([r,i]):void 0}function _(e){return"sente"===e.orientation}function J(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const ee={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function te(e,t){const o=new Map;let n=t.files-1,r=0;for(let i=0;i<e.length;i++)switch(e[i]){case" ":case"_":return o;case"/":if(++r,r>t.ranks-1)return o;n=t.files-1;break;default:{const t=e[i].charCodeAt(0);if(t<58&&t>47)n-=t-48;else{const t=("+"===e[i]&&e.length>i+1?"+"+e[++i]:e[i]).toLowerCase(),a=J(t);if(n>=0&&a){const c=e[i]===t||"+"+e[i]===t?"gote":"sente";o.set(s([n,r]),{role:a,color:c})}--n}}}return o}function oe(e,t){t.animation&&(re(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ne(e,t){var o,n,r,s,i;if((null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(r=t.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),re(e,t),null===(s=t.sfen)||void 0===s?void 0:s.board){e.dimensions=function(e){const t=e.split("/"),o=t[0].split("");let n=0,r=0;for(const e of o){const t=e.charCodeAt(0);t<58&&t>47?r=10*r+t-48:(n+=r+1,r=0)}return n+=r,{files:n,ranks:t.length}}(t.sfen.board);const o=e.pieces.get("00");e.pieces=te(t.sfen.board,e.dimensions),o&&e.pieces.set("00",o),e.drawable.shapes=[]}(null===(i=t.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const t=new Map,o=new Map;let n=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)n=10*n+i-48,r=n;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=J(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?t.set(a,(t.get(a)||0)+r):o.set(a,(o.get(a)||0)+r)),n=0,r=1}}return new Map([["sente",t],["gote",o]])}(t.sfen.hands)),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&F(e,e.selected),oe(e,t)}function re(e,t){for(const o in t)se(e[o])&&se(t[o])?re(e[o],t[o]):e[o]=t[o]}function se(e){return"object"==typeof e}function ie(e,t){return t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),s=function(e,t){const o=new Map,n=[],s=new Map,i=[],a=[],c=new Map;let d,u,p;for(const[t,o]of e)c.set(t,ce(t,o));for(const e of r)d=t.pieces.get(e),u=c.get(e),d?u?l(d,u.piece)||(i.push(u),a.push(ce(e,d))):a.push(ce(e,d)):u&&i.push(u);for(const e of a)u=de(e,i.filter((t=>l(e.piece,t.piece)))),u&&(p=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],o.set(e.key,p.concat(p)),n.push(u.key));for(const e of i)n.includes(e.key)||s.set(e.key,e.piece);return{anims:o,fadings:s}}(o,t);if(s.anims.size||s.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:s},e||le(t,performance.now())}else t.dom.redraw();return n}(e,t):ae(e,t)}function ae(e,t){const o=e(t);return t.dom.redraw(),o}function ce(e,t){return{key:e,pos:i(e),piece:t}}function de(e,t){return t.sort(((t,o)=>d(e.pos,t.pos)-d(e.pos,o.pos)))[0]}function le(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>le(e,t)))}var r}const ue=["green","red","blue","yellow"];function pe(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?z(e):Q(e);const o=v(t),n=Z(o,_(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;n&&(e.drawable.current={orig:n,pos:o,piece:r,brush:me(t)},fe(e))}function fe(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const o=Z(t.pos,_(e),e.dimensions,e.dom.bounds());o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,t.piece=t.dest?void 0:e.drawable.piece,e.dom.redrawNow()),fe(e)}}))}function ge(e,t){e.drawable.current&&(e.drawable.current.pos=v(t))}function he(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e=>e.orig===t.orig&&e.piece&&t.piece&&(e.piece.color!==t.piece.color||e.piece.role!==t.piece.role),r=e.shapes.find(o),s=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!o(e))));r&&r.brush===t.brush&&!s||e.shapes.push(t);!t.piece||r&&r.brush===t.brush&&!s||e.shapes.push({orig:t.orig,brush:t.brush});be(e)}(e.drawable,t),ve(e))}function ve(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function me(e){var t;const o=(e.shiftKey||e.ctrlKey)&&m(e),n=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return ue[(o?1:0)+(n?2:0)]}function be(e){e.onChange&&e.onChange(e.shapes)}function we(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=v(t),r=Z(n,_(e),e.dimensions,o);if(!r)return;const s=e.pieces.get(r),a=e.selected;var c;a||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(c=e).drawable.shapes.length&&(c.drawable.shapes=[],c.dom.redraw(),be(c.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||s||a||function(e,t){const o=_(e),n=e.dom.bounds(),r=Math.pow(n.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=w(s,o,e.dimensions,n);if(d(i,t)<=r)return!0}return!1}(e,n))&&t.preventDefault();const l=!!e.premovable.current,u=!!e.predroppable.current||!!e.predroppable.dropDests;e.stats.ctrlKey=t.ctrlKey,e.selected&&G(e,e.selected,r)?ie((e=>R(e,r)),e):R(e,r);const g=e.selected===r,m=Le(e,r);if(s&&m&&g&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.activeColor||e.activeColor===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:m,previouslySelected:a,originTarget:t.target,keyHasChanged:!1},m.sgDragging=!0,m.classList.add("dragging");const c=e.dom.elements.ghost;c&&(c.className=`ghost ${s.color} ${s.role}`,f(c,p(e.dimensions,o)(i(r),_(e))),h(c,!0)),ye(e)}else l&&H(e),u&&$(e);e.dom.redraw()}function ke(e,t,o,n,r){const s="00";e.pieces.set(s,t),z(e),e.dom.redraw();const i=v(o);e.draggable.current={orig:s,piece:t,origPos:i,pos:i,started:!0,element:()=>Le(e,s),originTarget:o.target,newPiece:!0,fromHand:n,force:r,keyHasChanged:!1},Y(e,t)&&(e.predroppable.dropDests=A(e.pieces,t,e.dimensions)),ye(e)}function ye(e){requestAnimationFrame((()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&l(n,o.piece)){if(!o.started&&d(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.sgDragging=!0,e.classList.add("dragging"),o.element=e}const t=e.dom.bounds();f(o.element,[o.pos[0]-t.left-t.width/(2*e.dimensions.files),o.pos[1]-t.top-t.height/(2*e.dimensions.ranks)]),o.keyHasChanged||(o.keyHasChanged=o.orig!==Z(o.pos,_(e),e.dimensions,t))}}else Se(e);ye(e)}))}function Ce(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=v(t))}function Me(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);H(e),$(e);const n=Z(v(t)||o.pos,_(e),e.dimensions,e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?(B(e,o.piece,n,o.force,o.fromHand),e.pieces.delete("00")):(e.stats.ctrlKey=t.ctrlKey,N(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.draggable.lastDropOff=o,e.pieces.delete(o.orig),K(e.events.change)),(o.orig!==o.previouslySelected&&!o.keyHasChanged||o.orig!==n&&n)&&e.selectable.enabled||z(e),Pe(e),e.draggable.current=void 0,e.dom.redraw()}function Se(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,z(e),Pe(e),e.dom.redraw())}function Pe(e){const t=e.dom.elements;t.ghost&&h(t.ghost,!1)}function Le(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.sgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function xe(e){e.dropmode.active=!1,e.dropmode.piece=void 0}function De(e,t){function r(){!function(e){e.orientation=c(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&r(),oe(e,t),(t.sfen?ie:ae)((e=>ne(e,t)),e)},state:e,getBoardSfen:()=>function(e,t){const r=o.slice(t.files).reverse();return n.slice(t.ranks).map((t=>r.map((o=>{const n=e.get(o+t);if(n){const e=ee[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,t){var o,n;let r="",s="";for(const i of t){const t=null===(o=e.get("sente"))||void 0===o?void 0:o.get(i),a=null===(n=e.get("gote"))||void 0===n?void 0:n.get(i);t&&(r+=t>1?t.toString()+ee[i]:ee[i]),a&&(s+=a>1?a.toString()+ee[i]:ee[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.handRoles),toggleOrientation:r,move(t,o){ie((e=>O(e,t,o)),e)},drop(t,o){ie((e=>T(e,t,o)),e)},setPieces(t){ie((e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t)),e)},addToHand(t,o){ae((e=>q(e,t,o)),e)},removeFromHand(t,o){ae((e=>W(e,t,o)),e)},selectSquare(t,o){t?ie((e=>R(e,t,o)),e):e.selected&&(z(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(ie(I,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const t=function(e){const t=e.predroppable.current;let o=!1;return!!t&&(X(e,t.piece,t.key)&&T(e,t.piece,t.key)&&(K(e.droppable.events.after,t.piece,t.key,{premove:!1,predrop:!0}),o=!0),$(e),o)}(e);return e.dom.redraw(),t}return!1},cancelPremove(){ae(H,e)},cancelPredrop(){ae($,e)},cancelMove(){ae((e=>{Q(e),Se(e),xe(e)}),e)},stop(){ae((e=>{V(e),Se(e),xe(e)}),e)},setAutoShapes(t){ae((e=>e.drawable.autoShapes=t),e)},setShapes(t){ae((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>Z(t,_(e),e.dimensions,e.dom.bounds()),redrawAll:t,dragNewPiece(t,o,n,r){ke(e,t,o,n,r)},destroy(){V(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ae(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ke(e,t,o){const n=e.drawable,r=n.current,s=r&&r.mouseSq?r:void 0,i=new Map,a=e.dom.bounds();for(const e of n.shapes.concat(n.autoShapes).concat(s?[s]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const c=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:$e(e,i,!1,a)})));s&&c.push({shape:s,current:!0,hash:$e(s,i,!0,a)});const d=c.map((e=>e.hash)).join(";");if(d===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=d;const l=t.querySelector("defs"),u=t.querySelector("g"),p=o.querySelector("g");!function(e,t,o){const n=new Map;let r;for(const o of t)o.shape.dest&&(r=e.brushes[o.shape.brush],o.shape.modifiers&&(r=We(r,o.shape.modifiers)),n.set(r.key,r));const s=new Set;let i=o.firstChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextSibling;for(const[e,t]of n.entries())s.has(e)||o.appendChild(Be(t))}(n,c,l),He(e,c.filter((e=>!e.shape.customSvg)),n.brushes,i,u),He(e,c.filter((e=>e.shape.customSvg)),n.brushes,i,p)}function He(e,t,o,n,r){const s=e.dom.bounds(),i=new Map,a=[];for(const e of t)i.set(e.hash,!1);let c,d=r.firstChild;for(;d;)c=d.getAttribute("sgHash"),i.has(c)?i.set(c,!0):a.push(d),d=d.nextSibling;for(const e of a)r.removeChild(e);for(const a of t)i.get(a.hash)||r.appendChild(Ee(e,a,o,n,s))}function $e({orig:e,dest:t,brush:o,piece:n,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,t,o,t&&(i.get(t)||0)>1,n&&Oe(n),r&&(d=r,""+(d.lineWidth||"")),s&&Te(s)].filter((e=>e)).join(",");var d}function Oe(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Te(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function Ee(e,{shape:t,current:o,hash:n},r,s,a){const c=e.dimensions;let d;if(t.customSvg){const o=qe(i(t.orig),e.orientation,c);d=function(e,t,o,n){const{width:r,height:s}=n,i=r/o.files,a=s/o.ranks,c=t[0]*i,d=(o.ranks-1-t[1])*a,l=Ne(Ae("g"),{transform:`translate(${c},${d})`}),u=Ne(Ae("svg"),{width:i,height:i,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(t.customSvg,o,c,a)}else if(t.piece&&!t.dest)d=function(e,t,o,n){const r=ze(e,n,o),s=n.width/o.files*(t.scale||.8),i=Ne(Ae("foreignObject"),{className:`${t.role} ${t.color}`,x:r[0]-s/2,y:r[1]-s/2,width:s,height:s}),a=b("piece",`${t.color} ${t.role}`);return a.style.width="200%",a.style.height="200%",a.style.margin="-50%",a.style.transform="scale(0.5)",i.append(a),i}(qe(i(t.orig),e.orientation,c),t.piece,c,a);else{const n=qe(i(t.orig),e.orientation,c);if(t.dest){let l=r[t.brush];t.modifiers&&(l=We(l,t.modifiers)),d=function(e,t,o,n,r,s,i){const a=function(e,t,o){return(o?20:10)/(55*e.files)*t.width}(s,i,r&&!n),c=ze(t,i,s),d=ze(o,i,s),l=d[0]-c[0],u=d[1]-c[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return Ne(Ae("line"),{stroke:e.color,"stroke-width":Re(e,s,n,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Fe(e,n),x1:c[0],y1:c[1],x2:d[0]-f,y2:d[1]-g})}(l,n,qe(i(t.dest),e.orientation,c),o,(s.get(t.dest)||0)>1,c,a)}else d=function(e,t,o,n,r){const s=ze(t,r,n),i=function(e,t){const o=t.width/(55*e.files);return[3*o,4*o]}(n,r),a=(r.width+r.height)/(4*n.files);return Ne(Ae("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:Fe(e,o),cx:s[0],cy:s[1],r:a-i[1]/2})}(r[t.brush],n,o,c,a)}return d.setAttribute("sgHash",n),d}function Be(e){const t=Ne(Ae("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Ne(Ae("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("sgKey",e.key),t}function Ne(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function qe(e,t,o){return"sente"===t?[o.files-1-e[0],o.ranks-1-e[1]]:e}function We(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Re(e,t,o,n){return(e.lineWidth||10)*(o?.85:1)/(55*t.files)*n.width}function Fe(e,t){return(e.opacity||1)*(t?.9:1)}function ze(e,t,o){return[(e[0]+.5)*t.width/o.files,(o.ranks-.5-e[1])*t.height/o.ranks]}function je(t,o,n){t.innerHTML="",t.classList.add("sg-wrap",`d-${o.dimensions.files}x${o.dimensions.ranks}`);for(const n of e)t.classList.toggle("orientation-"+n,o.orientation===n);t.classList.toggle("manipulable",!o.viewOnly);const r=b("sg-container");t.appendChild(r);const s=b("sg-board");let i,a,c,d,l;if(r.appendChild(s),o.hands.enabled&&(i=b("sg-hand","hand-top"),a=b("sg-hand","hand-bot"),r.insertBefore(i,s),r.insertBefore(a,s.nextSibling)),o.grid&&r.insertBefore(function(e){const t=90,o=e.files*t,n=e.ranks*t,r=Ne(Ae("svg"),{class:"sg-grid",viewBox:`0 0 ${o} ${n}`,preserveAspectRatio:"none"});for(let n=0;n<=e.ranks;n++)r.appendChild(Ne(Ae("line"),{x1:0,x2:o,y1:t*n,y2:t*n}));for(let o=0;o<=e.files;o++)r.appendChild(Ne(Ae("line"),{x1:t*o,x2:t*o,y1:0,y2:n}));const s=Math.floor((o+n)/t/2),i=Math.floor(e.files/3)*t,a=Math.floor(e.ranks/3)*t;for(const e of[!1,!0])for(const t of[!1,!0])r.appendChild(Ne(Ae("line"),{x1:e?o-i:i,x2:e?o-i:i,y1:t?n-a:a,y2:t?n-a:a,"stroke-linecap":"round","stroke-width":s}));return r}(o.dimensions),s.nextSibling),o.drawable.visible&&!n&&(c=Ne(Ae("svg"),{class:"sg-shapes"}),c.appendChild(Ae("defs")),c.appendChild(Ae("g")),d=Ne(Ae("svg"),{class:"sg-custom-svgs"}),d.appendChild(Ae("g")),r.appendChild(c),r.appendChild(d)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",t=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);r.appendChild(Ge(t,"ranks"+e,o.dimensions.ranks)),r.appendChild(Ge(["9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}return o.draggable.showGhost&&!n&&(l=b("piece","ghost"),h(l,!1),r.appendChild(l)),{board:s,handTop:i,handBot:a,container:r,ghost:l,svg:c,customSvg:d}}function Ge(e,t,o){const n=b("coords",t);let r;for(const t of e.slice(-o))r=b("coord"),r.textContent=t,n.appendChild(r);return n}function Xe(e,t){const o=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(t).observe(o),e.viewOnly)return;const n=function(e){return t=>{e.draggable.current?Se(e):e.drawable.current?ve(e):t.shiftKey||m(t)?e.drawable.enabled&&pe(e,t):e.viewOnly||(e.dropmode.active&&!function(e,t){const o=v(t),n=o&&Z(o,_(e),e.dimensions,e.dom.bounds());return!(!n||!e.pieces.has(n))}(e,t)?function(e,t){if(!e.dropmode.active)return;t.cancelable&&t.preventDefault(),H(e),$(e);const o=e.dropmode.piece;if(o){const n=v(t),r=n&&Z(n,_(e),e.dimensions,e.dom.bounds());r&&(B(e,o,r,!1,!0),e.dropmode.fromHand&&(e.dropmode.active=!1))}e.dom.redraw()}(e,t):(xe(e),we(e,t)))}}(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ue(e,t){t.addEventListener("mousedown",Ve(e),{passive:!1}),t.addEventListener("touchstart",Ve(e),{passive:!1}),e.selectable.enabled&&(t.addEventListener("mouseup",Ze(e),{passive:!1}),t.addEventListener("touchend",Ze(e),{passive:!1})),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ye(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function Ie(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}function Qe(o){const n=o.dataset.role,r=o.dataset.color;if(s=n,t.includes(s)&&function(t){return e.includes(t)}(r))return{role:n,color:r};var s}function Ve(e){return t=>{var o;t.preventDefault();const n=Qe(t.target);n&&("both"===e.activeColor||e.activeColor===n.color)&&(null===(o=e.hands.handMap.get(n.color))||void 0===o?void 0:o.get(n.role))&&ke(e,n,t,!0,!1)}}function Ze(e){return t=>{var o;const n=Qe(t.target);n&&("both"===e.activeColor||e.activeColor===n.color)&&(null===(o=e.hands.handMap.get(n.color))||void 0===o?void 0:o.get(n.role))&&(!e.draggable.current||Math.abs(e.draggable.current.pos[0]-e.draggable.current.origPos[0])<20&&Math.abs(e.draggable.current.pos[1]-e.draggable.current.origPos[1])<20)&&(e.dropmode.active?xe(e):function(e,t,o){e.dropmode.active=!0,e.dropmode.piece=t,e.dropmode.fromHand=o,Se(e),z(e),Y(e,t)&&(e.predroppable.dropDests=A(e.pieces,t,e.dimensions))}(e,n,!0))}}function _e(e){const t=_(e),o=e.dom.relative?(S=e.dimensions,(e,t)=>u(e,S,t,50,50)):p(e.dimensions,e.dom.bounds()),n=e.dom.relative?g:f,r=e.dom.elements.board,s=e.dom.elements.handTop,a=e.dom.elements.handBot,d=e.pieces,l=e.animation.current,h=l?l.plan.anims:new Map,v=l?l.plan.fadings:new Map,m=e.draggable.current,w=function(e){var t,o,n,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)t.includes("*")||nt(s,t,"last-move");e.check&&e.highlight.check&&nt(s,e.check,"check");if(e.selected){if(nt(s,e.selected,"selected"),e.movable.showDests){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)nt(s,t,"move-dest"+(e.pieces.has(t)?" oc":""));const n=e.premovable.dests;if(n)for(const t of n)nt(s,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}}else if(e.dropmode.active||(null===(o=e.draggable.current)||void 0===o?void 0:o.newPiece)){const t=e.dropmode.active?e.dropmode.piece:null===(n=e.draggable.current)||void 0===n?void 0:n.piece;if(t&&e.droppable.showDests){const o=null===(r=e.droppable.dests)||void 0===r?void 0:r.get(t.role);if(o)for(const e of o)nt(s,e,"move-dest");const n=e.predroppable.dropDests;if(n&&e.turnColor!==t.color)for(const t of n)nt(s,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)nt(s,e,"current-premove");else e.predroppable.current&&nt(s,e.predroppable.current.key,"current-premove");return s}(e),k=new Set,y=new Set,C=new Map,M=new Map;var S;let P,L,x,D,A,K,H,$,O,T;for(L=r.firstChild;L;){if(P=L.sgKey,Je(L))if(x=d.get(P),A=h.get(P),K=v.get(P),D=L.sgPiece,!L.sgDragging||m&&m.orig===P||(L.classList.remove("dragging"),n(L,o(i(P),t)),L.sgDragging=!1),!K&&L.sgFading&&(L.sgFading=!1,L.classList.remove("fading")),x){if(A&&L.sgAnimating&&D===ot(x)){const e=i(P);e[0]+=A[2],e[1]+=A[3],L.classList.add("anim"),n(L,o(e,t))}else L.sgAnimating&&(L.sgAnimating=!1,L.classList.remove("anim"),n(L,o(i(P),t)));D!==ot(x)||K&&L.sgFading?K&&D===ot(K)?(L.classList.add("fading"),L.sgFading=!0):it(C,D,L):k.add(P)}else it(C,D,L);else if(et(L)){const e=L.className;w.get(P)===e?y.add(P):it(M,e,L)}L=L.nextSibling}for(const[e,s]of w)if(!y.has(e)){O=M.get(s),T=O&&O.pop();const a=o(i(e),t);if(T)T.sgKey=e,n(T,a,!1);else{const t=b("square",s);t.sgKey=e,n(t,a,!1),r.insertBefore(t,r.firstChild)}}for(const[e,s]of d)if(A=h.get(e),!k.has(e))if(H=C.get(ot(s)),$=H&&H.pop(),$){$.sgKey=e,$.sgFading&&($.classList.remove("fading"),$.sgFading=!1);const r=i(e);A&&($.sgAnimating=!0,$.classList.add("anim"),r[0]+=A[2],r[1]+=A[3]),n($,o(r,t))}else{const a=ot(s),c=b("piece",a),d=i(e);c.sgPiece=a,c.sgKey=e,A&&(c.sgAnimating=!0,d[0]+=A[2],d[1]+=A[3]),n(c,o(d,t)),r.appendChild(c)}e.hands.enabled&&s&&a&&(st(e,c(e.orientation),s),st(e,e.orientation,a));for(const t of C.values())tt(e,t);for(const t of M.values())tt(e,t)}function Je(e){return"PIECE"===e.tagName}function et(e){return"SQUARE"===e.tagName}function tt(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function ot(e){return`${e.color} ${e.role}`}function nt(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function rt(e,t){var o;const n=b("piece",ot(e)),r=(null===(o=t.get(e.color))||void 0===o?void 0:o.get(e.role))||0;return n.dataset.role=e.role,n.dataset.color=e.color,n.dataset.nb=r.toString(),n}function st(e,t,o){var n,r;if(o.children.length!==e.hands.handRoles.length){o.innerHTML="";for(const n of e.hands.handRoles)o.appendChild(rt({role:n,color:t},e.hands.handMap))}else{let t=o.firstChild;for(;t;){const o=t.dataset.color,s=t.dataset.role,i=(null===(n=e.hands.handMap.get(o))||void 0===n?void 0:n.get(s))||0;t.classList.toggle("selected",e.dropmode.active&&(null===(r=e.dropmode.piece)||void 0===r?void 0:r.color)===o&&e.dropmode.piece.role===s),t.dataset.nb=i.toString(),t=t.nextSibling}}}function it(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function at(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}return function(e,t){const o={pieces:te("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",grid:!1,viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,coordinates:{enabled:!0,notation:0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},hands:{handMap:new Map,enabled:!0,handRoles:["rook","bishop","gold","silver","knight","lance","pawn"],captureProcessing:e=>{switch(e){case"tokin":return"pawn";case"promotedlance":return"lance";case"promotedknight":return"knight";case"promotedsilver":return"silver";case"dragon":return"rook";case"horse":return"bishop";case"king":return;default:return e}}},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDropDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,fromHand:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:a()};function n(){const t="dom"in o?o.dom.unbind:void 0,n=o.viewOnly&&!o.drawable.visible,r=je(e,o,n),s=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}((()=>r.board.getBoundingClientRect())),a=e=>{_e(d),!e&&r.svg&&r.customSvg&&Ke(d,r.svg,r.customSvg)},c=()=>{s.clear(),function(e){if(e.dom.relative)return;const t=_(e),o=p(e.dimensions,e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)Je(n)&&!n.sgAnimating?f(n,o(i(n.sgKey),t)):et(n)&&f(n,o(i(n.sgKey),t),!1),n=n.nextSibling}(d),r.svg&&r.customSvg&&Ke(d,r.svg,r.customSvg)},d=o;var l;return d.dom={elements:r,bounds:s,redraw:at(a),redrawNow:a,unbind:t,relative:n},d.drawable.prevSvgHash="",a(!1),Xe(d,c),(l=d).hands.enabled&&!l.viewOnly&&l.dom.elements.handTop&&l.dom.elements.handBot&&(Ue(l,l.dom.elements.handBot),Ue(l,l.dom.elements.handTop)),t||(d.dom.unbind=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(Ye(document.body,"shogiground.resize",t)),!e.viewOnly){const t=Ie(e,Ce,ge),n=Ie(e,Me,he);for(const e of["touchmove","mousemove"])o.push(Ye(document,e,t));for(const e of["touchend","mouseup"])o.push(Ye(document,e,n));const r=()=>e.dom.bounds.clear();o.push(Ye(document,"scroll",r,{capture:!0,passive:!0})),o.push(Ye(window,"resize",r,{passive:!0}))}return()=>o.forEach((e=>e()))}(d,c)),d.events.insert&&d.events.insert(r),d}return ne(o,t||{}),De(n(),n)}}();
