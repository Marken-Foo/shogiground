var Shogiground=function(){"use strict";function e(e){return"PIECE"===e.tagName}function n(e){return"SQ"===e.tagName}const t=["sente","gote"],o=["king","rook","bishop","gold","silver","knight","lance","pawn","dragon","horse","promotedsilver","promotedknight","promotedlance","tokin"],r=["1","2","3","4","5","6","7","8","9"],s=["a","b","c","d","e","f","g","h","i"],i=Array.prototype.concat(...s.map((e=>r.map((n=>n+e))))),a=e=>i[e[0]+9*e[1]],c=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];const d=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const n=performance.now()-e;return e=void 0,n}}},l=e=>"sente"===e?"gote":"sente",u=(e,n)=>{const t=e[0]-n[0],o=e[1]-n[1];return t*t+o*o},p=(e,n)=>e.role===n.role&&e.color===n.color,f=(e,n,t,o,r)=>[(t?n.files-1-e[0]:e[0])*o,(t?e[1]:n.ranks-1-e[1])*r],g=(e,n)=>{const t=n.width/e.files,o=n.height/e.ranks;return(n,r)=>f(n,e,r,t,o)},h=(e,n,t=1)=>{e.style.transform=`translate(${n[0]}px,${n[1]}px) scale(${.5*t}`},m=(e,n,t=1)=>{e.style.transform=`translate(${n[0]}%,${n[1]}%) scale(${.5*t})`},v=(e,n)=>{e.style.visibility=n?"visible":"hidden"},b=e=>{var n;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(n=e.targetTouches)||void 0===n?void 0:n[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},w=e=>2===e.buttons||2===e.button,k=(e,n)=>{const t=document.createElement(e);return n&&(t.className=n),t};function y(e,n,t,o){const r=c(e);return n&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[o.left+o.width*r[0]/t.files+o.width/(2*t.files),o.top+o.height*(t.ranks-1-r[1])/t.ranks+o.height/(2*t.ranks)]}function C(e,n){return Math.abs(e-n)}const M=(e,n,t,o)=>C(e,t)===C(n,o),S=(e,n,t,o)=>e===t||n===o,P=(e,n,t,o)=>C(e,t)<2&&C(n,o)<2;const L=(e,n,t,o)=>P(e,n,t,o)||M(e,n,t,o),E=(e,n,t,o)=>P(e,n,t,o)||S(e,n,t,o),A=i.map(c);function H(e,n,t){const o=e.get(n);if(!o)return[];const r=c(n),s=o.role,i="pawn"===s?(d=o.color,(e,n,t,o)=>"sente"===d?e===t&&n-1===o:e===t&&n+1===o):"knight"===s?function(e){return(n,t,o,r)=>1===C(n,o)&&2===C(t,r)&&("sente"===e?r<t:r>t)}(o.color):"bishop"===s?M:"rook"===s?S:"king"===s?P:"silver"===s?function(e){return(n,t,o,r)=>C(n,o)<2&&C(t,r)<2&&t!==r&&("sente"===e?n!==o||r<t:n!==o||r>t)}(o.color):"lance"===s?function(e){return(n,t,o,r)=>"sente"===e?n===o&&r<t:n===o&&t<r}(o.color):"horse"===s?L:"dragon"===s?E:function(e){return(n,t,o,r)=>C(n,o)<2&&C(t,r)<2&&("sente"===e?r<=t||n===o:r>=t||n===o)}(o.color);var d;return A.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&i(r[0],r[1],e[0],e[1])&&e[0]<t.files&&e[1]<t.ranks)).map(a)}function K(e,n,t){return"sente"===t?0===n[1]:n[1]===e.ranks-1}function D(e,n,t){const o=n.color,r=n.role;return i.filter((n=>{const s=e.get(n),i=c(n);return(!s||s.color!==o)&&i[0]<t.files&&i[1]<t.ranks&&("pawn"===r||"lance"===r?!K(t,i,o):"knight"!==r||!function(e,n,t){return K(e,n,t)||("sente"===t?1===n[1]:n[1]===e.ranks-2)}(t,i,o))}))}function x(e,...n){e&&setTimeout((()=>e(...n)),1)}function q(e){e.premovable.current&&(e.premovable.current=void 0,x(e.premovable.events.unset))}function O(e){const n=e.predroppable;n.current&&(n.current=void 0,x(n.events.unset))}function T(e,n,t){const o=e.pieces.get(n),r=e.pieces.get(t);if(n===t||!o)return!1;const s=r&&r.color!==o.color?r:void 0;if(e.hands.enabled&&s){const n=e.hands.captureProcessing(s.role);n&&z(e,{color:l(s.color),role:n})}return t===e.selected&&X(e),x(e.events.move,n,t,s),e.pieces.set(t,o),e.pieces.delete(n),e.lastMove=[n,t],e.check=void 0,x(e.events.change),s||!0}function $(e,n,t,o){if(e.pieces.has(t)){if(!o)return!1;e.pieces.delete(t)}return x(e.events.drop,n,t),e.pieces.set(t,n),e.lastMove=[t],e.check=void 0,x(e.events.change),!0}function W(e,n,t){const o=T(e,n,t);return o&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),o}function N(e,n,t,o){const r=$(e,n,t,o);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),r}function B(e,n,t,o,r){Q(e,n,t)||o?(N(e,n,t,o)&&r&&(R(e,n),Y(e)),x(e.droppable.events.after,n,t,{premove:!1,predrop:!1})):function(e,n,t){const o=e.pieces.get(t);return Z(e,n)&&(!o||o.color!==e.activeColor)&&D(e.pieces,n,e.dimensions).includes(t)}(e,n,t)?function(e,n,t){q(e),e.predroppable.current={piece:n,key:t},x(e.predroppable.events.set,n,t)}(e,n,t):(q(e),O(e)),X(e)}function F(e,n,t){if(I(e,n,t)){const o=W(e,n,t);if(o){const r=e.hold.stop();X(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(s.captured=o),x(e.movable.events.after,n,t,s),!0}}else if(function(e,n,t){return n!==t&&V(e,n)&&H(e.pieces,n,e.dimensions).includes(t)}(e,n,t))return function(e,n,t,o){O(e),e.premovable.current=[n,t],x(e.premovable.events.set,n,t,o)}(e,n,t,{ctrlKey:e.stats.ctrlKey}),X(e),!0;return X(e),!1}function z(e,n,t=1){const o=e.hands.handMap.get(n.color);o&&o.set(n.role,(o.get(n.role)||0)+t)}function R(e,n,t=1){const o=e.hands.handMap.get(n.color),r=null==o?void 0:o.get(n.role);o&&r&&o.set(n.role,Math.max(r-t,0))}function j(e,n,t){if(x(e.events.select,n),e.selected){if(e.selected===n&&!e.draggable.enabled)return X(e),void e.hold.cancel();if((e.selectable.enabled||t)&&e.selected!==n&&F(e,e.selected,n))return void(e.stats.dragged=!1)}(U(e,n)||V(e,n))&&(G(e,n),e.hold.start())}function G(e,n){e.selected=n,V(e,n)?e.premovable.dests=H(e.pieces,n,e.dimensions):(e.premovable.dests=void 0,e.predroppable.dests=void 0)}function X(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dests=void 0,e.hold.cancel()}function Y(e){e.dropmode.active=!1,e.dropmode.piece=void 0}function U(e,n){const t=e.pieces.get(n);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function I(e,n,t){var o,r;return n!==t&&U(e,n)&&(e.movable.free||!!(null===(r=null===(o=e.movable.dests)||void 0===o?void 0:o.get(n))||void 0===r?void 0:r.includes(t)))}function Q(e,n,t){var o,r;return!e.pieces.has(t)&&("both"===e.activeColor||e.activeColor===n.color&&e.turnColor===n.color)&&(e.droppable.free||!!(null===(r=null===(o=e.droppable.dests)||void 0===o?void 0:o.get(n.role))||void 0===r?void 0:r.includes(t)))}function V(e,n){const t=e.pieces.get(n);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function Z(e,n){var t;return(e.dropmode.active||!!(null===(t=e.draggable.current)||void 0===t?void 0:t.newPiece))&&e.predroppable.enabled&&e.activeColor===n.color&&e.turnColor!==n.color}function _(e){const n=e.premovable.current;if(!n)return!1;const t=n[0],o=n[1];let r=!1;if(I(e,t,o)){const n=W(e,t,o);if(n){const s={premove:!0};!0!==n&&(s.captured=n),x(e.movable.events.after,t,o,s),r=!0}}return q(e),r}function J(e){q(e),O(e),X(e),Y(e)}function ee(e){e.activeColor=e.movable.dests=e.droppable.dests=e.animation.current=void 0,J(e)}function ne(e,n,t,o){let r=Math.floor(t.files*(e[0]-o.left)/o.width);n&&(r=t.files-1-r);let s=t.ranks-1-Math.floor(t.ranks*(e[1]-o.top)/o.height);return n&&(s=t.ranks-1-s),r>=0&&r<t.files&&s>=0&&s<t.ranks?a([r,s]):void 0}function te(e){return"sente"===e.orientation}function oe(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const re={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function se(e,n){const t=new Map;let o=n.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return t;case"/":if(++r,r>n.ranks-1)return t;o=n.files-1;break;default:{const n=e[s].charCodeAt(0);if(n<58&&n>47)o-=n-48;else{const n=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),i=oe(n);if(o>=0&&i){const c=e[s]===n||"+"+e[s]===n?"gote":"sente";t.set(a([o,r]),{role:i,color:c})}--o}}}return t}function ie(e,n){n.animation&&(ce(e.animation,n.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ae(e,n){var t,o,r,s,i;if((null===(t=n.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(o=n.droppable)||void 0===o?void 0:o.dests)&&(e.droppable.dests=void 0),(null===(r=n.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),ce(e,n),null===(s=n.sfen)||void 0===s?void 0:s.board){e.dimensions=function(e){const n=e.split("/"),t=n[0].split("");let o=0,r=0;for(const e of t){const n=e.charCodeAt(0);n<58&&n>47?r=10*r+n-48:(o+=r+1,r=0)}return o+=r,{files:o,ranks:n.length}}(n.sfen.board);const t=e.pieces.get("00");e.pieces=se(n.sfen.board,e.dimensions),t&&e.pieces.set("00",t),e.drawable.shapes=[]}(null===(i=n.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const n=new Map,t=new Map;let o=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)o=10*o+i-48,r=o;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=oe(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?n.set(a,(n.get(a)||0)+r):t.set(a,(t.get(a)||0)+r)),o=0,r=1}}return new Map([["sente",n],["gote",t]])}(n.sfen.hands)),"check"in n&&function(e,n){if(e.check=void 0,!0===n&&(n=e.turnColor),n)for(const[t,o]of e.pieces)"king"===o.role&&o.color===n&&(e.check=t)}(e,n.check||!1),"lastMove"in n&&!n.lastMove?e.lastMove=void 0:n.lastMove&&(e.lastMove=n.lastMove),e.selected&&G(e,e.selected),ie(e,n)}function ce(e,n){for(const t in n)de(e[t])&&de(n[t])?ce(e[t],n[t]):e[t]=n[t]}function de(e){return"object"==typeof e}function le(e,n){return n.animation.enabled?function(e,n){const t=new Map(n.pieces),o=e(n),r=function(e,n){const t=new Map,o=[],r=new Map,s=[],a=[],c=new Map;let d,l,u;for(const[n,t]of e)c.set(n,pe(n,t));for(const e of i)d=n.pieces.get(e),l=c.get(e),d?l?p(d,l.piece)||(s.push(l),a.push(pe(e,d))):a.push(pe(e,d)):l&&s.push(l);for(const e of a)l=fe(e,s.filter((n=>p(e.piece,n.piece)))),l&&(u=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],t.set(e.key,u.concat(u)),o.push(l.key));for(const e of s)o.includes(e.key)||r.set(e.key,e.piece);return{anims:t,fadings:r}}(t,n);if(r.anims.size||r.fadings.size){const e=n.animation.current&&n.animation.current.start;n.animation.current={start:performance.now(),frequency:1/n.animation.duration,plan:r},e||ge(n,performance.now())}else n.dom.redraw();return o}(e,n):ue(e,n)}function ue(e,n){const t=e(n);return n.dom.redraw(),t}function pe(e,n){return{key:e,pos:c(e),piece:n}}function fe(e,n){return n.sort(((n,t)=>u(e.pos,n.pos)-u(e.pos,t.pos)))[0]}function ge(e,n){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||e.dom.redrawNow());const o=1-(n-t.start)*t.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const n=(r=o)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*n,e[3]=e[1]*n;e.dom.redrawNow(!0),requestAnimationFrame(((n=performance.now())=>ge(e,n)))}var r}const he=["green","red","blue","yellow"];function me(e,n){if(n.touches&&n.touches.length>1)return;n.stopPropagation(),n.preventDefault(),n.ctrlKey?X(e):J(e);const t=b(n),o=ne(t,te(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;o&&(e.drawable.current={orig:o,pos:t,piece:r,brush:ye(n)},ve(e))}function ve(e){requestAnimationFrame((()=>{const n=e.drawable.current;if(n){const t=ne(n.pos,te(e),e.dimensions,e.dom.bounds());t!==n.mouseSq&&(n.mouseSq=t,n.dest=t!==n.orig?t:void 0,n.piece=n.dest?void 0:e.drawable.piece,e.dom.redrawNow()),ve(e)}}))}function be(e,n){e.drawable.current&&(e.drawable.current.pos=b(n))}function we(e){const n=e.drawable.current;n&&(n.mouseSq&&function(e,n){const t=e=>e.orig===n.orig&&e.dest===n.dest,o=e=>e.orig===n.orig&&e.piece&&n.piece&&(e.piece.color!==n.piece.color||e.piece.role!==n.piece.role),r=e.shapes.find(t),s=e.shapes.find(o);r&&(e.shapes=e.shapes.filter((e=>!t(e))));r&&r.brush===n.brush&&!s||e.shapes.push(n);!n.piece||r&&r.brush===n.brush&&!s||e.shapes.push({orig:n.orig,brush:n.brush});Ce(e)}(e.drawable,n),ke(e))}function ke(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ye(e){var n;const t=(e.shiftKey||e.ctrlKey)&&w(e),o=e.altKey||e.metaKey||(null===(n=e.getModifierState)||void 0===n?void 0:n.call(e,"AltGraph"));return he[(t?1:0)+(o?2:0)]}function Ce(e){e.onChange&&e.onChange(e.shapes)}function Me(e,n){if(!n.isTrusted||void 0!==n.button&&0!==n.button)return;if(n.touches&&n.touches.length>1)return;const t=e.dom.bounds(),o=b(n),r=ne(o,te(e),e.dimensions,t);if(!r)return;const s=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Ce(a.drawable)),!1!==n.cancelable&&(!n.touches||e.blockTouchScroll||s||i||function(e,n){const t=te(e),o=e.dom.bounds(),r=Math.pow(o.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=y(s,t,e.dimensions,o);if(u(i,n)<=r)return!0}return!1}(e,o))&&n.preventDefault();const d=!!e.premovable.current,l=!!e.predroppable.current||!!e.predroppable.dests;e.stats.ctrlKey=n.ctrlKey,e.selected&&I(e,e.selected,r)?le((e=>j(e,r)),e):j(e,r);const p=e.selected===r,f=Ke(e,r);if(s&&f&&p&&function(e,n){const t=e.pieces.get(n);return!!t&&e.draggable.enabled&&("both"===e.activeColor||e.activeColor===t.color&&(e.turnColor===t.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:f,previouslySelected:i,originTarget:n.target,keyHasChanged:!1},f.sgDragging=!0,f.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,h(a,g(e.dimensions,t)(c(r),te(e))),v(a,!0)),Pe(e)}else d&&q(e),l&&O(e);e.dom.redraw()}function Se(e,n,t,o,r){var s;const i="00";e.pieces.set(i,n),X(e),e.dom.redraw();const a=b(t);e.draggable.current={orig:i,piece:n,origPos:a,pos:a,started:!0,element:()=>Ke(e,i),originTarget:t.target,newPiece:!0,fromHand:o,force:r,keyHasChanged:e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.role)===n.role&&e.dropmode.piece.color===n.color},Z(e,n)&&(e.predroppable.dests=D(e.pieces,n,e.dimensions)),o&&(e.dropmode.active=!0,e.dropmode.piece=n),Pe(e)}function Pe(e){requestAnimationFrame((()=>{var n;const t=e.draggable.current;if(!t)return;(null===(n=e.animation.current)||void 0===n?void 0:n.plan.anims.has(t.orig))&&(e.animation.current=void 0);const o=e.pieces.get(t.orig);if(o&&p(o,t.piece)){if(!t.started&&u(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.sgDragging=!0,e.classList.add("dragging"),t.element=e}const n=e.dom.bounds();h(t.element,[t.pos[0]-n.left-n.width/(2*e.dimensions.files),t.pos[1]-n.top-n.height/(2*e.dimensions.ranks)]),t.keyHasChanged=t.keyHasChanged||!t.newPiece&&t.orig!==ne(t.pos,te(e),e.dimensions,n)||!!t.fromHand&&u(t.pos,t.origPos)>=Math.pow(e.draggable.distance,4)}}else Ae(e);Pe(e)}))}function Le(e,n){e.draggable.current&&(!n.touches||n.touches.length<2)&&(e.draggable.current.pos=b(n))}function Ee(e,n){const t=e.draggable.current;if(!t)return;if("touchend"===n.type&&!1!==n.cancelable&&n.preventDefault(),"touchend"===n.type&&t.originTarget!==n.target&&!t.newPiece)return void(e.draggable.current=void 0);q(e),O(e);const o=ne(b(n)||t.pos,te(e),e.dimensions,e.dom.bounds());o&&t.started&&t.orig!==o?t.newPiece?(B(e,t.piece,o,t.force,t.fromHand),e.pieces.delete("00")):(e.stats.ctrlKey=n.ctrlKey,F(e,t.orig,o)&&(e.stats.dragged=!0)):t.newPiece?(e.pieces.delete(t.orig),t.fromHand&&t.keyHasChanged&&Y(e)):e.draggable.deleteOnDropOff&&!o&&(e.draggable.lastDropOff=t,e.pieces.delete(t.orig),x(e.events.change)),(t.orig!==t.previouslySelected&&!t.keyHasChanged||t.orig!==o&&o)&&e.selectable.enabled||X(e),He(e),e.draggable.current=void 0,e.dom.redraw()}function Ae(e){const n=e.draggable.current;n&&(n.newPiece&&e.pieces.delete(n.orig),e.draggable.current=void 0,X(e),He(e),e.dom.redraw())}function He(e){const n=e.dom.elements;n.ghost&&v(n.ghost,!1)}function Ke(n,t){let o=n.dom.elements.pieces.firstElementChild;for(;o;){if(e(o)&&o.sgKey===t)return o;o=o.nextElementSibling}}function De(e,n){function t(){!function(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),n()}return{set(n){n.orientation&&n.orientation!==e.orientation&&t(),ie(e,n),(n.sfen?le:ue)((e=>ae(e,n)),e)},state:e,getBoardSfen:()=>function(e,n){const t=r.slice(n.files).reverse();return s.slice(n.ranks).map((n=>t.map((t=>{const o=e.get(t+n);if(o){const e=re[o.role];return"sente"===o.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,n){var t,o;let r="",s="";for(const i of n){const n=null===(t=e.get("sente"))||void 0===t?void 0:t.get(i),a=null===(o=e.get("gote"))||void 0===o?void 0:o.get(i);n&&(r+=n>1?n.toString()+re[i]:re[i]),a&&(s+=a>1?a.toString()+re[i]:re[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.handRoles),toggleOrientation:t,move(n,t){le((e=>T(e,n,t)),e)},drop(n,t){le((e=>$(e,n,t)),e)},setPieces(n){le((e=>function(e,n){for(const[t,o]of n)o?e.pieces.set(t,o):e.pieces.delete(t)}(e,n)),e)},addToHand(n,t){ue((e=>z(e,n,t)),e)},removeFromHand(n,t){ue((e=>R(e,n,t)),e)},selectSquare(n,t){n?le((e=>j(e,n,t)),e):e.selected&&(X(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(le(_,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const n=function(e){const n=e.predroppable.current;let t=!1;return!!n&&(Q(e,n.piece,n.key)&&N(e,n.piece,n.key)&&(x(e.droppable.events.after,n.piece,n.key,{premove:!1,predrop:!0}),t=!0),O(e),t)}(e);return e.dom.redraw(),n}return!1},cancelPremove(){ue(q,e)},cancelPredrop(){ue(O,e)},cancelMove(){ue((e=>{J(e),Ae(e)}),e)},stop(){ue((e=>{ee(e),Ae(e)}),e)},setAutoShapes(n){ue((e=>e.drawable.autoShapes=n),e)},setShapes(n){ue((e=>e.drawable.shapes=n),e)},getKeyAtDomPos:n=>ne(n,te(e),e.dimensions,e.dom.bounds()),redrawAll:n,dragNewPiece(n,t,o,r){Se(e,n,t,o,r)},destroy(){ee(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function xe(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function qe(e,n,t,o){const r=e.drawable,s=r.current,i=s&&s.mouseSq?s:void 0,a=new Map,d=e.dom.bounds();for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[]))e.dest&&a.set(e.dest,(a.get(e.dest)||0)+1);const l=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:Te(e,a,!1,d)})));i&&l.push({shape:i,current:!0,hash:Te(i,a,!0,d)});const u=l.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const p=n.querySelector("defs"),f=n.querySelector("g"),m=t.querySelector("g");!function(e,n,t){const o=new Map;let r;for(const t of n)t.shape.dest&&(r=e.brushes[t.shape.brush],t.shape.modifiers&&(r=Re(r,t.shape.modifiers)),o.set(r.key,r));const s=new Set;let i=t.firstElementChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextElementSibling;for(const[e,n]of o.entries())s.has(e)||t.appendChild(Be(n))}(r,l,p),Oe(l.filter((e=>!e.shape.customSvg&&!e.shape.piece)),f,(n=>Ne(e,n,r.brushes,a,d))),Oe(l.filter((e=>e.shape.customSvg)),m,(n=>Ne(e,n,r.brushes,a,d))),Oe(l.filter((e=>e.shape.piece)),o,(n=>function(e,{shape:n,hash:t},o){var r,s,i;const a=n.orig,d=null===(r=n.piece)||void 0===r?void 0:r.role,l=null===(s=n.piece)||void 0===s?void 0:s.color,u=null===(i=n.piece)||void 0===i?void 0:i.scale,p=k("piece",`${d} ${l}`);return p.setAttribute("sgHash",t),p.sgKey=a,p.sgScale=u,h(p,g(e.dimensions,o)(c(a),te(e)),u),p}(e,n,d)))}function Oe(e,n,t){const o=new Map,r=[];for(const n of e)o.set(n.hash,!1);let s,i=n.firstElementChild;for(;i;)s=i.getAttribute("sgHash"),o.has(s)?o.set(s,!0):r.push(i),i=i.nextElementSibling;for(const e of r)n.removeChild(e);for(const r of e)o.get(r.hash)||n.appendChild(t(r))}function Te({orig:e,dest:n,brush:t,piece:o,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,n,t,n&&(i.get(n)||0)>1,o&&$e(o),r&&(d=r,""+(d.lineWidth||"")),s&&We(s)].filter((e=>e)).join(",");var d}function $e(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function We(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t)>>>0;return"custom-"+n.toString()}function Ne(e,{shape:n,current:t,hash:o},r,s,i){const a=e.dimensions;let d;if(n.customSvg){const t=ze(c(n.orig),e.orientation,a);d=function(e,n,t,o){const{width:r,height:s}=o,i=r/t.files,a=s/t.ranks,c=n[0]*i,d=(t.ranks-1-n[1])*a,l=Fe(xe("g"),{transform:`translate(${c},${d})`}),u=Fe(xe("svg"),{width:i,height:i,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(n.customSvg,t,a,i)}else{const o=ze(c(n.orig),e.orientation,a);if(n.dest){let l=r[n.brush];n.modifiers&&(l=Re(l,n.modifiers)),d=function(e,n,t,o,r,s,i){const a=function(e,n,t){return(t?20:10)/(55*e.files)*n.width}(s,i,r&&!o),c=Xe(n,i,s),d=Xe(t,i,s),l=d[0]-c[0],u=d[1]-c[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return Fe(xe("line"),{stroke:e.color,"stroke-width":je(e,s,o,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Ge(e,o),x1:c[0],y1:c[1],x2:d[0]-f,y2:d[1]-g})}(l,o,ze(c(n.dest),e.orientation,a),t,(s.get(n.dest)||0)>1,a,i)}else d=function(e,n,t,o,r){const s=Xe(n,r,o),i=function(e,n){const t=n.width/(55*e.files);return[3*t,4*t]}(o,r),a=(r.width+r.height)/(4*o.files);return Fe(xe("circle"),{stroke:e.color,"stroke-width":i[t?0:1],fill:"none",opacity:Ge(e,t),cx:s[0],cy:s[1],r:a-i[1]/2})}(r[n.brush],o,t,a,i)}return d.setAttribute("sgHash",o),d}function Be(e){const n=Fe(xe("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return n.appendChild(Fe(xe("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),n.setAttribute("sgKey",e.key),n}function Fe(e,n){for(const t in n)e.setAttribute(t,n[t]);return e}function ze(e,n,t){return"sente"===n?[t.files-1-e[0],t.ranks-1-e[1]]:e}function Re(e,n){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(n.lineWidth||e.lineWidth),key:[e.key,n.lineWidth].filter((e=>e)).join("")}}function je(e,n,t,o){return(e.lineWidth||10)*(t?.85:1)/(55*n.files)*o.width}function Ge(e,n){return(e.opacity||1)*(n?.9:1)}function Xe(e,n,t){return[(e[0]+.5)*n.width/t.files,(t.ranks-.5-e[1])*n.height/t.ranks]}function Ye(e,n,o){e.innerHTML="",e.classList.add("sg-wrap",`d-${n.dimensions.files}x${n.dimensions.ranks}`);for(const o of t)e.classList.toggle("orientation-"+o,n.orientation===o);e.classList.toggle("manipulable",!n.viewOnly);const r=k("sg-board");e.appendChild(r);const s=function(e,n){const t=k("sg-squares");for(let o=0;o<e.ranks*e.files;o++){const r=k("sq");r.sgKey=a("sente"===n?[e.files-1-o%e.files,Math.floor(o/e.files)]:[o%e.files,e.files-1-Math.floor(o/e.files)]),t.appendChild(r)}return t}(n.dimensions,n.orientation);r.appendChild(s);const i=k("sg-pieces");let c,d,l,u,p,f;if(r.appendChild(i),n.hands.enabled&&(c=k("sg-hand","hand-top"),d=k("sg-hand","hand-bot"),e.insertBefore(c,r),e.insertBefore(d,r.nextElementSibling)),n.drawable.visible&&!o&&(l=Fe(xe("svg"),{class:"sg-shapes"}),l.appendChild(xe("defs")),l.appendChild(xe("g")),u=Fe(xe("svg"),{class:"sg-custom-svgs"}),u.appendChild(xe("g")),p=k("sg-free-pieces"),r.appendChild(l),r.appendChild(u),r.appendChild(p)),n.coordinates.enabled){const e="gote"===n.orientation?" gote":"",t=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(n.coordinates.notation);r.appendChild(Ue(t,"ranks"+e,n.dimensions.ranks)),r.appendChild(Ue(["9","8","7","6","5","4","3","2","1"],"files"+e,n.dimensions.files))}return n.draggable.showGhost&&!o&&(f=k("piece","ghost"),v(f,!1),r.appendChild(f)),{board:r,squares:s,pieces:i,ghost:f,svg:l,customSvg:u,freePieces:p,handTop:c,handBot:d}}function Ue(e,n,t){const o=k("coords",n);let r;for(const n of e.slice(-t))r=k("coord"),r.textContent=n,o.appendChild(r);return o}function Ie(e,n){const t=e.dom.elements.squares;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window&&new ResizeObserver(n).observe(t),e.viewOnly)return;const o=function(e){return n=>{e.draggable.current?Ae(e):e.drawable.current?ke(e):n.shiftKey||w(n)?e.drawable.enabled&&me(e,n):e.viewOnly||(e.dropmode.active&&!function(e,n){const t=b(n),o=t&&ne(t,te(e),e.dimensions,e.dom.bounds());return!(!o||!e.pieces.has(o))}(e,n)?function(e,n){if(!e.dropmode.active)return;n.cancelable&&n.preventDefault(),q(e),O(e);const t=e.dropmode.piece;if(t){const o=b(n),r=o&&ne(o,te(e),e.dimensions,e.dom.bounds());r&&(B(e,t,r,!1,!0),e.dropmode.fromHand&&Y(e))}e.dom.redraw()}(e,n):(Y(e),Me(e,n)))}}(e);t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault()))}function Qe(e,n){n.addEventListener("mousedown",Je(e),{passive:!1}),n.addEventListener("touchstart",Je(e),{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ve(e,n,t,o){return e.addEventListener(n,t,o),()=>e.removeEventListener(n,t,o)}function Ze(e,n,t){return o=>{e.drawable.current?e.drawable.enabled&&t(e,o):e.viewOnly||n(e,o)}}function _e(e){const n=e.dataset.role,r=e.dataset.color;if(s=n,o.includes(s)&&function(e){return t.includes(e)}(r))return{role:n,color:r};var s}function Je(e){return n=>{var t;n.preventDefault();const o=_e(n.target);o&&("both"===e.activeColor||e.activeColor===o.color)&&(null===(t=e.hands.handMap.get(o.color))||void 0===t?void 0:t.get(o.role))&&Se(e,o,n,!0,!1)}}function en(t){const o=te(t),r=t.dom.relative?(P=t.dimensions,(e,n)=>f(e,P,n,50,50)):g(t.dimensions,t.dom.bounds()),s=t.dom.relative?m:h,i=t.dom.elements.squares,a=t.dom.elements.pieces,d=t.dom.elements.handTop,u=t.dom.elements.handBot,p=t.pieces,v=t.animation.current,b=v?v.plan.anims:new Map,w=v?v.plan.fadings:new Map,y=t.draggable.current,C=function(e){var n,t,o,r;const s=new Map;if(e.lastMove&&e.highlight.lastMove)for(const n of e.lastMove)n.includes("*")||on(s,n,"last-move");e.check&&e.highlight.check&&on(s,e.check,"check");if(e.selected){if(on(s,e.selected,"selected"),e.movable.showDests){const t=null===(n=e.movable.dests)||void 0===n?void 0:n.get(e.selected);if(t)for(const n of t)on(s,n,"move-dest"+(e.pieces.has(n)?" oc":""));const o=e.premovable.dests;if(o)for(const n of o)on(s,n,"premove-dest"+(e.pieces.has(n)?" oc":""))}}else if(e.dropmode.active||(null===(t=e.draggable.current)||void 0===t?void 0:t.newPiece)){const n=e.dropmode.active?e.dropmode.piece:null===(o=e.draggable.current)||void 0===o?void 0:o.piece;if(n&&e.droppable.showDests){const t=null===(r=e.droppable.dests)||void 0===r?void 0:r.get(n.role);if(t)for(const e of t)on(s,e,"move-dest");const o=e.predroppable.dests;if(o&&e.turnColor!==n.color)for(const n of o)on(s,n,"premove-dest"+(e.pieces.has(n)?" oc":""))}}const i=e.premovable.current;if(i)for(const e of i)on(s,e,"current-premove");else e.predroppable.current&&on(s,e.predroppable.current.key,"current-premove");return s}(t),M=new Set,S=new Map;var P;let L,E,A,H,K,D,x,q;for(E=a.firstElementChild;E;){if(e(E))if(L=E.sgKey,A=p.get(L),K=b.get(L),D=w.get(L),H=E.sgPiece,!E.sgDragging||y&&y.orig===L||(E.classList.remove("dragging"),s(E,r(c(L),o)),E.sgDragging=!1),!D&&E.sgFading&&(E.sgFading=!1,E.classList.remove("fading")),A){if(K&&E.sgAnimating&&H===tn(A)){const e=c(L);e[0]+=K[2],e[1]+=K[3],E.classList.add("anim"),s(E,r(e,o))}else E.sgAnimating&&(E.sgAnimating=!1,E.classList.remove("anim"),s(E,r(c(L),o)));H!==tn(A)||D&&E.sgFading?D&&H===tn(D)?(E.classList.add("fading"),E.sgFading=!0):an(S,H,E):M.add(L)}else an(S,H,E);E=E.nextElementSibling}let O=i.firstElementChild;for(;O&&n(O);){const e=C.get(O.sgKey)||"";O.className=e,O=O.nextElementSibling}for(const[e,n]of p)if(K=b.get(e),!M.has(e))if(x=S.get(tn(n)),q=x&&x.pop(),q){q.sgKey=e,q.sgFading&&(q.classList.remove("fading"),q.sgFading=!1);const n=c(e);K&&(q.sgAnimating=!0,q.classList.add("anim"),n[0]+=K[2],n[1]+=K[3]),s(q,r(n,o))}else{const t=tn(n),i=k("piece",t),d=c(e);i.sgPiece=t,i.sgKey=e,K&&(i.sgAnimating=!0,d[0]+=K[2],d[1]+=K[3]),s(i,r(d,o)),a.appendChild(i)}t.hands.enabled&&d&&u&&(sn(t,l(t.orientation),d),sn(t,t.orientation,u));for(const e of S.values())nn(t,e)}function nn(e,n){for(const t of n)e.dom.elements.pieces.removeChild(t)}function tn(e){return`${e.color} ${e.role}`}function on(e,n,t){const o=e.get(n);o?e.set(n,`${o} ${t}`):e.set(n,t)}function rn(e,n,t){var o;const r=k("piece",tn(e)),s=(null===(o=n.get(e.color))||void 0===o?void 0:o.get(e.role))||0;return r.dataset.role=e.role,r.dataset.color=e.color,r.dataset.nb=s.toString(),r.classList.toggle("selected",t),r}function sn(e,n,t){var o,r,s;if(t.children.length!==e.hands.handRoles.length){t.innerHTML="";for(const r of e.hands.handRoles)t.appendChild(rn({role:r,color:n},e.hands.handMap,e.dropmode.active&&(null===(o=e.dropmode.piece)||void 0===o?void 0:o.color)===n&&e.dropmode.piece.role===r))}else{let o=t.firstElementChild;for(;o;){const t=o.dataset.role,i=(null===(r=e.hands.handMap.get(n))||void 0===r?void 0:r.get(t))||0;o.classList.toggle("selected",e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.color)===n&&e.dropmode.piece.role===t),o.dataset.nb=i.toString(),o=o.nextElementSibling}}}function an(e,n,t){const o=e.get(n);o?o.push(t):e.set(n,[t])}function cn(e){let n=!1;return()=>{n||(n=!0,requestAnimationFrame((()=>{e(),n=!1})))}}return function(n,t){const o={pieces:se("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,coordinates:{enabled:!0,notation:0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},hands:{enabled:!1,handMap:new Map,handRoles:["rook","bishop","gold","silver","knight","lance","pawn"],captureProcessing:e=>{switch(e){case"tokin":return"pawn";case"promotedlance":return"lance";case"promotedknight":return"knight";case"promotedsilver":return"silver";case"dragon":return"rook";case"horse":return"bishop";case"king":return;default:return e}}},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1,fromHand:!0},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:d()};function r(){const t="dom"in o?o.dom.unbind:void 0,r=o.viewOnly&&!o.drawable.visible,s=Ye(n,o,r),i=function(e){let n;const t=()=>(void 0===n&&(n=e()),n);return t.clear=()=>{n=void 0},t}((()=>s.pieces.getBoundingClientRect())),a=e=>{en(l),!e&&s.svg&&s.customSvg&&s.freePieces&&qe(l,s.svg,s.customSvg,s.freePieces)},d=()=>{i.clear(),function(n){if(n.dom.relative)return;const t=te(n),o=g(n.dimensions,n.dom.bounds());let r=n.dom.elements.pieces.firstElementChild;for(;r;)e(r)&&!r.sgAnimating&&h(r,o(c(r.sgKey),t)),r=r.nextElementSibling}(l),s.svg&&s.customSvg&&s.freePieces&&qe(l,s.svg,s.customSvg,s.freePieces)},l=o;var u;return l.dom={elements:s,bounds:i,redraw:cn(a),redrawNow:a,unbind:t,relative:r},l.drawable.prevSvgHash="",a(!1),Ie(l,d),(u=l).hands.enabled&&!u.viewOnly&&u.dom.elements.handTop&&u.dom.elements.handBot&&(Qe(u,u.dom.elements.handBot),Qe(u,u.dom.elements.handTop)),t||(l.dom.unbind=function(e,n){const t=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||t.push(Ve(document.body,"shogiground.resize",n)),!e.viewOnly){const n=Ze(e,Le,be),o=Ze(e,Ee,we);for(const e of["touchmove","mousemove"])t.push(Ve(document,e,n));for(const e of["touchend","mouseup"])t.push(Ve(document,e,o));const r=()=>e.dom.bounds.clear();t.push(Ve(document,"scroll",r,{capture:!0,passive:!0})),t.push(Ve(window,"resize",r,{passive:!0}))}return()=>t.forEach((e=>e()))}(l,d)),l.events.insert&&l.events.insert(s),l}return ae(o,t||{}),De(r(),r)}}();
