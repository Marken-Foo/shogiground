var Shogiground=function(){"use strict";function e(e){return"PIECE"===e.tagName}function o(e){return"SQ"===e.tagName}const n=["sente","gote"],t=["1","2","3","4","5","6","7","8","9"],r=["a","b","c","d","e","f","g","h","i"],s=Array.prototype.concat(...r.map((e=>t.map((o=>o+e))))),i=e=>s[e[0]+9*e[1]],a=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];const c=e=>"sente"===e?"gote":"sente",l=(e,o)=>{const n=e[0]-o[0],t=e[1]-o[1];return n*n+t*t},d=(e,o)=>e.role===o.role&&e.color===o.color,u=(e,o,n,t,r)=>[(n?o.files-1-e[0]:e[0])*t,(n?e[1]:o.ranks-1-e[1])*r],p=(e,o)=>{const n=o.width/e.files,t=o.height/e.ranks;return(o,r)=>u(o,e,r,n,t)},g=(e,o,n)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${n}`},f=(e,o,n)=>{e.style.transform=`translate(${o[0]}%,${o[1]}%) scale(${n})`},h=(e,o)=>{e.style.display=o?"":"none"},m=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},v=e=>2===e.buttons||2===e.button,b=(e,o)=>{const n=document.createElement(e);return o&&(n.className=o),n};function w(e){return`${e.color} ${e.role}`}function k(e,o,n,t){const r=a(e);return o&&(r[0]=n.files-1-r[0],r[1]=n.ranks-1-r[1]),[t.left+t.width*r[0]/n.files+t.width/(2*n.files),t.top+t.height*(n.ranks-1-r[1])/n.ranks+t.height/(2*n.ranks)]}function y(e,o,n){const t=a(e);let r=n.files-1-t[0]+t[1]*n.files;return o||(r=n.files*n.ranks-1-r),r}function C(e,o){return Math.abs(e-o)}const M=(e,o,n,t)=>C(e,n)===C(o,t),S=(e,o,n,t)=>e===n||o===t,P=(e,o,n,t)=>C(e,n)<2&&C(o,t)<2;const L=(e,o,n,t)=>P(e,o,n,t)||M(e,o,n,t),D=(e,o,n,t)=>P(e,o,n,t)||S(e,o,n,t),E=s.map(a);function q(e,o,n){const t=e.get(o);if(!t)return[];const r=a(o),s=t.role,c="pawn"===s?(l=t.color,(e,o,n,t)=>"sente"===l?e===n&&o-1===t:e===n&&o+1===t):"knight"===s?function(e){return(o,n,t,r)=>1===C(o,t)&&2===C(n,r)&&("sente"===e?r<n:r>n)}(t.color):"bishop"===s?M:"rook"===s?S:"king"===s?P:"silver"===s?function(e){return(o,n,t,r)=>C(o,t)<2&&C(n,r)<2&&n!==r&&("sente"===e?o!==t||r<n:o!==t||r>n)}(t.color):"lance"===s?function(e){return(o,n,t,r)=>"sente"===e?o===t&&r<n:o===t&&n<r}(t.color):"horse"===s?L:"dragon"===s?D:function(e){return(o,n,t,r)=>C(o,t)<2&&C(n,r)<2&&("sente"===e?r<=n||o===t:r>=n||o===t)}(t.color);var l;return E.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&c(r[0],r[1],e[0],e[1])&&e[0]<n.files&&e[1]<n.ranks)).map(i)}function A(e,o,n){return"sente"===n?0===o[1]:o[1]===e.ranks-1}function O(e,o,n){const t=o.color,r=o.role;return s.filter((o=>{const s=e.get(o),i=a(o);return(!s||s.color!==t)&&i[0]<n.files&&i[1]<n.ranks&&("pawn"===r||"lance"===r?!A(n,i,t):"knight"!==r||!function(e,o,n){return A(e,o,n)||("sente"===n?1===o[1]:o[1]===e.ranks-2)}(n,i,t))}))}function H(e,...o){e&&setTimeout((()=>e(...o)),1)}function x(e){e.premovable.current&&(e.premovable.current=void 0,H(e.premovable.events.unset))}function T(e){const o=e.predroppable;o.current&&(o.current=void 0,H(o.events.unset))}function R(e,o,n){const t=e.pieces.get(o),r=e.pieces.get(n);if(o===n||!t)return!1;const s=r&&r.color!==t.color?r:void 0;return n===e.selected&&j(e),H(e.events.move,o,n,s),e.pieces.set(n,t),e.pieces.delete(o),e.lastMove=[o,n],e.check=void 0,H(e.events.change),s||!0}function K(e,o,n,t){if(e.pieces.has(n)){if(!t)return!1;e.pieces.delete(n)}return H(e.events.drop,o,n),e.pieces.set(n,o),e.lastMove=[n],e.check=void 0,H(e.events.change),!0}function $(e,o,n){const t=R(e,o,n);return t&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),e.animation.current=void 0),t}function N(e,o,n,t){const r=K(e,o,n,t);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=c(e.turnColor),e.animation.current=void 0),r}function W(e,o,n,t,r){I(e,o,n)||t?(N(e,o,n,t)&&r&&(F(e,o),X(e)),H(e.droppable.events.after,o,n,{premove:!1,predrop:!1})):function(e,o,n){const t=e.pieces.get(n);return V(e,o)&&(!t||t.color!==e.activeColor)&&O(e.pieces,o,e.dimensions).includes(n)}(e,o,n)?function(e,o,n){x(e),e.predroppable.current={piece:o,key:n},H(e.predroppable.events.set,o,n)}(e,o,n):(x(e),T(e)),j(e)}function B(e,o,n){if(U(e,o,n)){const t=$(e,o,n);if(t){j(e);const r={premove:!1,predrop:!1};return!0!==t&&(r.captured=t),H(e.movable.events.after,o,n,r),!0}}else if(function(e,o,n){return o!==n&&Q(e,o)&&q(e.pieces,o,e.dimensions).includes(n)}(e,o,n))return function(e,o,n){T(e),e.premovable.current=[o,n],H(e.premovable.events.set,o,n)}(e,o,n),j(e),!0;return j(e),!1}function F(e,o,n=1){const t=e.hands.handMap.get(o.color),r=null==t?void 0:t.get(o.role);t&&r&&t.set(o.role,Math.max(r-n,0))}function z(e,o,n){if(H(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled)return void j(e);if((e.selectable.enabled||n)&&e.selected!==o&&B(e,e.selected,o))return}(Y(e,o)||Q(e,o))&&G(e,o)}function G(e,o){e.selected=o,Q(e,o)?e.premovable.dests=q(e.pieces,o,e.dimensions):(e.premovable.dests=void 0,e.predroppable.dests=void 0)}function j(e){e.selected=void 0,e.premovable.dests=void 0,e.predroppable.dests=void 0}function X(e){e.dropmode.active=!1,e.dropmode.piece=void 0}function Y(e,o){const n=e.pieces.get(o);return!!n&&("both"===e.activeColor||e.activeColor===n.color&&e.turnColor===n.color)}function U(e,o,n){var t,r;return o!==n&&Y(e,o)&&(e.movable.free||!!(null===(r=null===(t=e.movable.dests)||void 0===t?void 0:t.get(o))||void 0===r?void 0:r.includes(n)))}function I(e,o,n){var t,r;return!e.pieces.has(n)&&("both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color)&&(e.droppable.free||!!(null===(r=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(o.role))||void 0===r?void 0:r.includes(n)))}function Q(e,o){const n=e.pieces.get(o);return!!n&&e.premovable.enabled&&e.activeColor===n.color&&e.turnColor!==n.color}function V(e,o){var n;return(e.dropmode.active||!!(null===(n=e.draggable.current)||void 0===n?void 0:n.newPiece))&&e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function Z(e){const o=e.premovable.current;if(!o)return!1;const n=o[0],t=o[1];let r=!1;if(U(e,n,t)){const o=$(e,n,t);if(o){const s={premove:!0,predrop:!1};!0!==o&&(s.captured=o),H(e.movable.events.after,n,t,s),r=!0}}return x(e),r}function _(e){x(e),T(e),j(e),X(e)}function J(e){e.activeColor=e.movable.dests=e.droppable.dests=e.animation.current=void 0,_(e)}function ee(e,o,n,t){let r=Math.floor(n.files*(e[0]-t.left)/t.width);o&&(r=n.files-1-r);let s=Math.floor(n.ranks*(e[1]-t.top)/t.height);return o||(s=n.ranks-1-s),r>=0&&r<n.files&&s>=0&&s<n.ranks?i([r,s]):void 0}function oe(e){return"sente"===e.orientation}function ne(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const te={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function re(e,o){const n=new Map;let t=o.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return n;case"/":if(++r,r>o.ranks-1)return n;t=o.files-1;break;default:{const o=e[s].charCodeAt(0);if(o<58&&o>47)t-=o-48;else{const o=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=ne(o);if(t>=0&&a){const c=e[s]===o||"+"+e[s]===o?"gote":"sente";n.set(i([t,r]),{role:a,color:c})}--t}}}return n}function se(e,o){o.animation&&(ae(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ie(e,o){var n,t,r,s,i;(null===(n=o.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(t=o.droppable)||void 0===t?void 0:t.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),ae(e,o),(null===(s=o.sfen)||void 0===s?void 0:s.board)&&(e.dimensions=function(e){const o=e.split("/"),n=o[0].split("");let t=0,r=0;for(const e of n){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:(t+=r+1,r=0)}return t+=r,{files:t,ranks:o.length}}(o.sfen.board),e.pieces=re(o.sfen.board,e.dimensions),e.drawable.shapes=[]),(null===(i=o.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const o=new Map,n=new Map;let t=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)t=10*t+i-48,r=t;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=ne(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):n.set(a,(n.get(a)||0)+r)),t=0,r=1}}return new Map([["sente",o],["gote",n]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[n,t]of e.pieces)"king"===t.role&&t.color===o&&(e.check=n)}(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&G(e,e.selected),se(e,o)}function ae(e,o){for(const n in o)ce(e[n])&&ce(o[n])?ae(e[n],o[n]):e[n]=o[n]}function ce(e){return"object"==typeof e}function le(e,o){return o.animation.enabled?function(e,o){const n=new Map(o.pieces),t=e(o),r=function(e,o){const n=new Map,t=[],r=new Map,i=[],a=[],c=new Map;let l,u,p;for(const[o,n]of e)c.set(o,ue(o,n));for(const e of s)l=o.pieces.get(e),u=c.get(e),l?u?d(l,u.piece)||(i.push(u),a.push(ue(e,l))):a.push(ue(e,l)):u&&i.push(u);for(const e of a)u=pe(e,i.filter((o=>d(e.piece,o.piece)))),u&&(p=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],n.set(e.key,p.concat(p)),t.push(u.key));for(const e of i)t.includes(e.key)||r.set(e.key,e.piece);return{anims:n,fadings:r}}(n,o);if(r.anims.size||r.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:r},e||ge(o,performance.now())}else o.dom.redraw();return t}(e,o):de(e,o)}function de(e,o){const n=e(o);return o.dom.redraw(),n}function ue(e,o){return{key:e,pos:a(e),piece:o}}function pe(e,o){return o.sort(((o,n)=>l(e.pos,o.pos)-l(e.pos,n.pos)))[0]}function ge(e,o){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const t=1-(o-n.start)*n.frequency;if(t<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=t)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>ge(e,o)))}var r}const fe=["green","red","blue","yellow"];function he(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?j(e):_(e);const n=m(o),t=ee(n,oe(e),e.dimensions,e.dom.bounds()),r=e.drawable.piece;t&&(e.drawable.current={orig:t,pos:n,piece:r,brush:ke(o)},me(e))}function me(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const n=ee(o.pos,oe(e),e.dimensions,e.dom.bounds());n!==o.mouseSq&&(o.mouseSq=n,o.dest=n!==o.orig?n:void 0,o.piece=o.dest?void 0:e.drawable.piece,e.dom.redrawNow()),me(e)}}))}function ve(e,o){e.drawable.current&&(e.drawable.current.pos=m(o))}function be(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const n=e=>e.orig===o.orig&&e.dest===o.dest,t=e=>e.orig===o.orig&&e.piece&&o.piece&&(e.piece.color!==o.piece.color||e.piece.role!==o.piece.role),r=e.shapes.find(n),s=e.shapes.find(t);r&&(e.shapes=e.shapes.filter((e=>!n(e))));r&&r.brush===o.brush&&!s||e.shapes.push(o);!o.piece||r&&r.brush===o.brush&&!s||e.shapes.push({orig:o.orig,brush:o.brush});ye(e)}(e.drawable,o),we(e))}function we(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ke(e){var o;const n=(e.shiftKey||e.ctrlKey)&&v(e),t=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return fe[(n?1:0)+(t?2:0)]}function ye(e){e.onChange&&e.onChange(e.shapes)}function Ce(e,o){if(!o.isTrusted||void 0!==o.button&&0!==o.button)return;if(o.touches&&o.touches.length>1)return;const n=e.dom.bounds(),t=m(o),r=t&&ee(t,oe(e),e.dimensions,n);if(!r)return;const s=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),ye(a.drawable)),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||s||i||function(e,o){const n=oe(e),t=e.dom.bounds(),r=Math.pow(t.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=k(s,n,e.dimensions,t);if(l(i,o)<=r)return!0}return!1}(e,t))&&o.preventDefault();const c=!!e.premovable.current,d=!!e.predroppable.current||!!e.predroppable.dests;e.selected&&U(e,e.selected,r)?le((e=>z(e,r)),e):z(e,r);const u=e.selected===r;if(s&&u&&function(e,o){const n=e.pieces.get(o);return!!n&&e.draggable.enabled&&("both"===e.activeColor||e.activeColor===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,r)){const n="touchstart"===o.type,a=e.dom.elements.dragged;e.draggable.current={piece:s,orig:r,touch:n,origPos:t,pos:t,started:e.draggable.autoDistance&&!n,previouslySelected:i,originTarget:o.target,keyHasChanged:!1},a.sgColor=s.color,a.sgRole=s.role,a.className=`dragging ${w(s)}`,a.classList.toggle("touch",n),Se(e)}else c&&x(e),d&&T(e);e.dom.redraw()}function Me(e,o,n,t,r){var s;j(e);const i=m(n),a="touchstart"===n.type,c=e.dom.elements.dragged;e.draggable.current={piece:o,touch:a,origPos:i,pos:i,started:!0,originTarget:n.target,newPiece:!0,fromHand:t,force:r,keyHasChanged:e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.role)===o.role&&e.dropmode.piece.color===o.color},c.sgColor=o.color,c.sgRole=o.role,c.className=`dragging ${w(o)}`,c.classList.toggle("touch",a),V(e,o)&&(e.predroppable.dests=O(e.pieces,o,e.dimensions)),t&&(e.dropmode.active=!0,e.dropmode.piece=o),e.dom.redraw(),Se(e)}function Se(e){requestAnimationFrame((()=>{var o;const n=e.draggable.current;if(!n)return;n.orig&&(null===(o=e.animation.current)||void 0===o?void 0:o.plan.anims.has(n.orig))&&(e.animation.current=void 0);const t=n.orig?e.pieces.get(n.orig):n.piece;if(t&&d(t,n.piece)){if(!n.started&&l(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0,e.dom.redraw()),n.started){const o=e.dom.elements.dragged,t=e.dom.bounds();g(o,[n.pos[0]-t.left-t.width/(2*e.dimensions.files),n.pos[1]-t.top-t.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),o.sgDragging||(o.sgDragging=!0,h(o,!0));const r=ee(n.pos,oe(e),e.dimensions,t);if(n.keyHasChanged=n.keyHasChanged||!n.newPiece&&n.orig!==r,r!==n.hovering){const o=n.hovering;n.hovering=r,function(e,o){var n,t;const r=oe(e),s=e.dom.elements.squares.children,i=(null===(n=e.draggable.current)||void 0===n?void 0:n.hovering)&&y(null===(t=e.draggable.current)||void 0===t?void 0:t.hovering,r,e.dimensions),a=i&&s[i];a&&a.classList.add("hover");const c=o&&y(o,r,e.dimensions),l=c&&s[c];l&&l.classList.remove("hover")}(e,o),r&&n.touch&&e.draggable.showTouchSquareOverlay?(g(e.dom.elements.squareOver,p(e.dimensions,t)(a(r),oe(e)),1),h(e.dom.elements.squareOver,!0)):n.touch&&h(e.dom.elements.squareOver,!1)}}}else De(e);Se(e)}))}function Pe(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=m(o))}function Le(e,o){const n=e.draggable.current;if(!n)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&n.originTarget!==o.target&&!n.newPiece)return void(e.draggable.current=void 0);x(e),T(e);const t=ee(m(o)||n.pos,oe(e),e.dimensions,e.dom.bounds());t&&n.started&&n.orig!==t?n.newPiece?W(e,n.piece,t,n.force,n.fromHand):n.orig&&B(e,n.orig,t):n.newPiece?n.fromHand&&l(n.pos,n.origPos)>=Math.pow(e.draggable.distance,4)&&X(e):n.orig&&e.draggable.deleteOnDropOff&&!t&&(e.draggable.lastDropOff=n,e.pieces.delete(n.orig),H(e.events.change)),(n.orig!==n.previouslySelected&&!n.keyHasChanged||n.orig!==t&&t)&&e.selectable.enabled||j(e),e.draggable.current=void 0,e.dom.redraw()}function De(e){e.draggable.current&&(e.draggable.current=void 0,j(e),e.dom.redraw())}function Ee(e){e.promotion.active=!1,e.promotion.key=void 0,e.promotion.pieces=void 0}function qe(e){const o=e.dom.elements.promotion;if(h(o,e.promotion.active),!e.promotion.active||!e.promotion.key||!e.promotion.pieces||e.viewOnly)return;const n=oe(e),t=a(e.promotion.key),r=b("promotion");g(r,p(e.dimensions,e.dom.bounds())(t,n),1),e.promotion.pieces.forEach((e=>{const o=b("piece",w(e));o.sgColor=e.color,o.sgRole=e.role,r.appendChild(o)})),o.innerHTML="",o.appendChild(r)}function Ae(e,o){function n(){!function(e){e.orientation=c(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(o){var t;o.orientation&&o.orientation!==e.orientation&&n(),se(e,o),((null===(t=o.sfen)||void 0===t?void 0:t.board)?le:de)((e=>ie(e,o)),e)},state:e,getBoardSfen:()=>function(e,o){const n=t.slice(o.files).reverse();return r.slice(o.ranks).map((o=>n.map((n=>{const t=e.get(n+o);if(t){const e=te[t.role];return"sente"===t.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var n,t;let r="",s="";for(const i of o){const o=null===(n=e.get("sente"))||void 0===n?void 0:n.get(i),a=null===(t=e.get("gote"))||void 0===t?void 0:t.get(i);o&&(r+=o>1?o.toString()+te[i]:te[i]),a&&(s+=a>1?a.toString()+te[i]:te[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.handRoles),toggleOrientation:n,move(o,n){le((e=>R(e,o,n)),e)},drop(o,n){le((e=>K(e,o,n)),e)},setPieces(o){le((e=>function(e,o){for(const[n,t]of o)t?e.pieces.set(n,t):e.pieces.delete(n)}(e,o)),e)},addToHand(o,n){de((e=>function(e,o,n=1){const t=e.hands.handMap.get(o.color);t&&t.set(o.role,(t.get(o.role)||0)+n)}(e,o,n)),e)},removeFromHand(o,n){de((e=>F(e,o,n)),e)},startPromotion(o,n){de((e=>function(e,o,n){e.promotion.active=!0,e.promotion.key=o,e.promotion.pieces=n}(e,o,n)),e)},stopPromotion(){de((e=>Ee(e)),e)},selectSquare(o,n){o?le((e=>z(e,o,n)),e):e.selected&&(j(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(le(Z,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const o=function(e){const o=e.predroppable.current;let n=!1;return!!o&&(I(e,o.piece,o.key)&&N(e,o.piece,o.key)&&(H(e.droppable.events.after,o.piece,o.key,{premove:!1,predrop:!0}),n=!0),T(e),n)}(e);return e.dom.redraw(),o}return!1},cancelPremove(){de(x,e)},cancelPredrop(){de(T,e)},cancelMove(){de((e=>{_(e),De(e)}),e)},stop(){de((e=>{J(e),De(e)}),e)},setAutoShapes(o){de((e=>e.drawable.autoShapes=o),e)},setShapes(o){de((e=>e.drawable.shapes=o),e)},getKeyAtDomPos:o=>ee(o,oe(e),e.dimensions,e.dom.bounds()),redrawAll:o,dragNewPiece(o,n,t,r){Me(e,o,n,t,r)},destroy(){J(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Oe(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function He(e,o,n,t){const r=e.drawable,s=r.current,i=s&&s.mouseSq?s:void 0,c=new Map,l=e.dom.bounds();for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[]))e.dest&&c.set(e.dest,(c.get(e.dest)||0)+1);const d=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:Te(e,c,!1,l)})));i&&d.push({shape:i,current:!0,hash:Te(i,c,!0,l)});const u=d.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const f=o.querySelector("defs"),h=o.querySelector("g"),m=n.querySelector("g");!function(e,o,n){const t=new Map;let r;for(const n of o)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=Fe(r,n.shape.modifiers)),t.set(r.key,r));const s=new Set;let i=n.firstElementChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextElementSibling;for(const[e,o]of t.entries())s.has(e)||n.appendChild(Ne(o))}(r,d,f),xe(d.filter((e=>!e.shape.customSvg&&!e.shape.piece)),h,(o=>$e(e,o,r.brushes,c,l))),xe(d.filter((e=>e.shape.customSvg)),m,(o=>$e(e,o,r.brushes,c,l))),xe(d.filter((e=>e.shape.piece)),t,(o=>function(e,{shape:o,hash:n},t){var r;const s=o.orig,i=((null===(r=o.piece)||void 0===r?void 0:r.scale)||1)*(e.scaleDownPieces?.5:1),c=b("piece",w(o.piece));return c.setAttribute("sgHash",n),c.sgKey=s,c.sgScale=i,g(c,p(e.dimensions,t)(a(s),oe(e)),i),c}(e,o,l)))}function xe(e,o,n){const t=new Map,r=[];for(const o of e)t.set(o.hash,!1);let s,i=o.firstElementChild;for(;i;)s=i.getAttribute("sgHash"),t.has(s)?t.set(s,!0):r.push(i),i=i.nextElementSibling;for(const e of r)o.removeChild(e);for(const r of e)t.get(r.hash)||o.appendChild(n(r))}function Te({orig:e,dest:o,brush:n,piece:t,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,o,n,o&&(i.get(o)||0)>1,t&&Re(t),r&&(l=r,""+(l.lineWidth||"")),s&&Ke(s)].filter((e=>e)).join(",");var l}function Re(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ke(e){let o=0;for(let n=0;n<e.length;n++)o=(o<<5)-o+e.charCodeAt(n)>>>0;return"custom-"+o.toString()}function $e(e,{shape:o,current:n,hash:t},r,s,i){const c=e.dimensions;let l;if(o.customSvg){const n=Be(a(o.orig),e.orientation,c);l=function(e,o,n,t){const{width:r,height:s}=t,i=r/n.files,a=s/n.ranks,c=o[0]*i,l=(n.ranks-1-o[1])*a,d=We(Oe("g"),{transform:`translate(${c},${l})`}),u=We(Oe("svg"),{width:i,height:i,viewBox:"0 0 100 100"});return d.appendChild(u),u.innerHTML=e,d}(o.customSvg,n,c,i)}else{const t=Be(a(o.orig),e.orientation,c);if(o.dest){let d=r[o.brush];o.modifiers&&(d=Fe(d,o.modifiers)),l=function(e,o,n,t,r,s,i){const a=function(e,o,n){return(n?20:10)/(55*e.files)*o.width}(s,i,r&&!t),c=je(o,i,s),l=je(n,i,s),d=l[0]-c[0],u=l[1]-c[1],p=Math.atan2(u,d),g=Math.cos(p)*a,f=Math.sin(p)*a;return We(Oe("line"),{stroke:e.color,"stroke-width":ze(e,s,t,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Ge(e,t),x1:c[0],y1:c[1],x2:l[0]-g,y2:l[1]-f})}(d,t,Be(a(o.dest),e.orientation,c),n,(s.get(o.dest)||0)>1,c,i)}else l=function(e,o,n,t,r){const s=je(o,r,t),i=function(e,o){const n=o.width/(55*e.files);return[3*n,4*n]}(t,r),a=(r.width+r.height)/(4*t.files);return We(Oe("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:Ge(e,n),cx:s[0],cy:s[1],r:a-i[1]/2})}(r[o.brush],t,n,c,i)}return l.setAttribute("sgHash",t),l}function Ne(e){const o=We(Oe("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(We(Oe("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("sgKey",e.key),o}function We(e,o){for(const n in o)e.setAttribute(n,o[n]);return e}function Be(e,o,n){return"sente"===o?[n.files-1-e[0],n.ranks-1-e[1]]:e}function Fe(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter((e=>e)).join("")}}function ze(e,o,n,t){return(e.lineWidth||10)*(n?.85:1)/(55*o.files)*t.width}function Ge(e,o){return(e.opacity||1)*(o?.9:1)}function je(e,o,n){return[(e[0]+.5)*o.width/n.files,(n.ranks-.5-e[1])*o.height/n.ranks]}function Xe(e,o,t){var r;e.innerHTML="",e.classList.add("sg-wrap",`d-${o.dimensions.files}x${o.dimensions.ranks}`);for(const t of n)e.classList.toggle("orientation-"+t,o.orientation===t);e.classList.toggle("manipulable",!o.viewOnly);const s=b("sg-board");e.appendChild(s);const a=function(e,o){const n=b("sg-squares");for(let t=0;t<e.ranks*e.files;t++){const r=b("sq");r.sgKey=i("sente"===o?[e.files-1-t%e.files,Math.floor(t/e.files)]:[t%e.files,e.files-1-Math.floor(t/e.files)]),n.appendChild(r)}return n}(o.dimensions,o.orientation);s.appendChild(a);const c=b("sg-pieces");s.appendChild(c);const l=b("sg-promotion");s.appendChild(l);const d=b("sg-square-over");h(d,!!(null===(r=o.draggable.current)||void 0===r?void 0:r.touch)),s.appendChild(d);const u=b("piece");let p,g,f,m,v;if(h(u,!!o.draggable.current),s.appendChild(u),o.hands.enabled&&(p=b("sg-hand","hand-top"),g=b("sg-hand","hand-bot"),e.insertBefore(p,s),e.insertBefore(g,s.nextElementSibling)),o.drawable.visible&&!t&&(f=We(Oe("svg"),{class:"sg-shapes"}),f.appendChild(Oe("defs")),f.appendChild(Oe("g")),m=We(Oe("svg"),{class:"sg-custom-svgs"}),m.appendChild(Oe("g")),v=b("sg-free-pieces"),s.appendChild(f),s.appendChild(m),s.appendChild(v)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",n=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);s.appendChild(Ye(n,"ranks"+e,o.dimensions.ranks)),s.appendChild(Ye(["9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}return{board:s,squares:a,pieces:c,promotion:l,squareOver:d,dragged:u,svg:f,customSvg:m,freePieces:v,handTop:p,handBot:g}}function Ye(e,o,n){const t=b("coords",o);let r;for(const o of e.slice(-n))r=b("coord"),r.textContent=o,t.appendChild(r);return t}function Ue(o,n){const t=o.dom.elements.pieces,r=o.dom.elements.promotion;if(!o.dom.relative&&o.resizable&&"ResizeObserver"in window&&new ResizeObserver(n).observe(t),o.viewOnly)return;const s=function(e){return o=>{e.draggable.current?De(e):e.drawable.current?we(e):o.shiftKey||v(o)?e.drawable.enabled&&he(e,o):e.viewOnly||(e.dropmode.active&&!function(e,o){const n=m(o),t=n&&ee(n,oe(e),e.dimensions,e.dom.bounds());return!(!t||!e.pieces.has(t))}(e,o)?function(e,o){if(!e.dropmode.active)return;o.cancelable&&o.preventDefault(),x(e),T(e);const n=e.dropmode.piece;if(n){const t=m(o),r=t&&ee(t,oe(e),e.dimensions,e.dom.bounds());r&&(W(e,n,r,!1,!0),e.dropmode.fromHand&&X(e))}e.dom.redraw()}(e,o):(X(e),Ce(e,o)))}}(o);t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("mousedown",s,{passive:!1});r.addEventListener("click",(n=>function(o,n){n.preventDefault();const t=o.promotion.key,r=n.target;if(o.promotion.active&&t&&e(r)){const e={color:r.sgColor,role:r.sgRole};o.pieces.set(t,e),H(o.promotion.after,e)}else H(o.promotion.cancel);Ee(o),h(o.dom.elements.promotion,!1),o.dom.redraw()}(o,n)),{passive:!1}),(o.disableContextMenu||o.drawable.enabled)&&(t.addEventListener("contextmenu",(e=>e.preventDefault())),r.addEventListener("contextmenu",(e=>e.preventDefault())))}function Ie(e,o){o.addEventListener("mousedown",Ze(e),{passive:!1}),o.addEventListener("touchstart",Ze(e),{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Qe(e,o,n,t){return e.addEventListener(o,n,t),()=>e.removeEventListener(o,n,t)}function Ve(e,o,n){return t=>{e.drawable.current?e.drawable.enabled&&n(e,t):e.viewOnly||o(e,t)}}function Ze(o){return n=>{var t;n.preventDefault();const r=n.target;if(e(r)){const e={color:r.sgColor,role:r.sgRole};"both"!==o.activeColor&&o.activeColor!==e.color||!(null===(t=o.hands.handMap.get(e.color))||void 0===t?void 0:t.get(e.role))||Me(o,e,n,!0,!1)}}}function _e(n){const t=oe(n),r=n.scaleDownPieces?.5:1,s=n.dom.relative?(A=n.dimensions,(e,o)=>u(e,A,o,50,50)):p(n.dimensions,n.dom.bounds()),i=n.dom.relative?f:g,l=n.dom.elements.squares,d=n.dom.elements.pieces,m=n.dom.elements.dragged,v=n.dom.elements.squareOver,k=n.dom.elements.handTop,y=n.dom.elements.handBot,C=n.pieces,M=n.animation.current,S=M?M.plan.anims:new Map,P=M?M.plan.fadings:new Map,L=n.draggable.current,D=function(e){var o,n,t,r,s;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const o of e.lastMove)eo(i,o,"last-move");e.check&&e.highlight.check&&eo(i,e.check,"check");(null===(o=e.draggable.current)||void 0===o?void 0:o.hovering)&&eo(i,e.draggable.current.hovering,"hover");if(e.selected){if("both"===e.activeColor||e.activeColor===e.turnColor?eo(i,e.selected,"selected"):eo(i,e.selected,"preselected"),e.movable.showDests){const o=null===(n=e.movable.dests)||void 0===n?void 0:n.get(e.selected);if(o)for(const n of o)eo(i,n,"move-dest"+(e.pieces.has(n)?" oc":""));const t=e.premovable.dests;if(t)for(const o of t)eo(i,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.dropmode.active||(null===(t=e.draggable.current)||void 0===t?void 0:t.newPiece)){const o=e.dropmode.active?e.dropmode.piece:null===(r=e.draggable.current)||void 0===r?void 0:r.piece;if(o&&e.droppable.showDests){const n=null===(s=e.droppable.dests)||void 0===s?void 0:s.get(o.role);if(n)for(const e of n)eo(i,e,"move-dest");const t=e.predroppable.dests;if(t&&e.turnColor!==o.color)for(const o of t)eo(i,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}}const a=e.premovable.current;if(a)for(const e of a)eo(i,e,"current-premove");else e.predroppable.current&&eo(i,e.predroppable.current.key,"current-premove");return i}(n),E=new Set,q=new Map;var A;let O,H,x,T,R,K,$,N;for(!L&&m.sgDragging&&(m.sgDragging=!1,h(m,!1),h(v,!1)),H=d.firstElementChild;H;){if(e(H))if(O=H.sgKey,x=C.get(O),R=S.get(O),K=P.get(O),T=w({color:H.sgColor,role:H.sgRole}),(null==L?void 0:L.started)&&L.orig===O?(H.classList.add("ghost"),H.sgGhost=!0):!H.sgGhost||L&&L.orig===O||(H.classList.remove("ghost"),H.sgDragging=!1),!K&&H.sgFading&&(H.sgFading=!1,H.classList.remove("fading")),x){if(R&&H.sgAnimating&&T===w(x)){const e=a(O);e[0]+=R[2],e[1]+=R[3],H.classList.add("anim"),i(H,s(e,t),r)}else H.sgAnimating&&(H.sgAnimating=!1,H.classList.remove("anim"),i(H,s(a(O),t),r));T!==w(x)||K&&H.sgFading?K&&T===w(K)?(H.classList.add("fading"),H.sgFading=!0):to(q,T,H):E.add(O)}else to(q,T,H);H=H.nextElementSibling}let W=l.firstElementChild;for(;W&&o(W);){const e=D.get(W.sgKey)||"";W.className=e,W=W.nextElementSibling}for(const[e,o]of C)if(R=S.get(e),!E.has(e))if($=q.get(w(o)),N=$&&$.pop(),N){N.sgKey=e,N.sgFading&&(N.classList.remove("fading"),N.sgFading=!1);const o=a(e);R&&(N.sgAnimating=!0,N.classList.add("anim"),o[0]+=R[2],o[1]+=R[3]),i(N,s(o,t),r)}else{const n=b("piece",w(o)),c=a(e);n.sgColor=o.color,n.sgRole=o.role,n.sgKey=e,R&&(n.sgAnimating=!0,c[0]+=R[2],c[1]+=R[3]),i(n,s(c,t),r),d.appendChild(n)}n.hands.enabled&&k&&y&&(no(n,c(n.orientation),k),no(n,n.orientation,y));for(const e of q.values())Je(n,e)}function Je(e,o){for(const n of o)e.dom.elements.pieces.removeChild(n)}function eo(e,o,n){const t=e.get(o);t?e.set(o,`${t} ${n}`):e.set(o,n)}function oo(e,o,n){var t;const r=b("piece",w(e)),s=(null===(t=o.get(e.color))||void 0===t?void 0:t.get(e.role))||0;return r.sgRole=e.role,r.sgColor=e.color,r.dataset.nb=s.toString(),r.classList.toggle("selected",n),r}function no(e,o,n){var t,r,s;if(n.children.length!==e.hands.handRoles.length){n.innerHTML="";for(const r of e.hands.handRoles)n.appendChild(oo({role:r,color:o},e.hands.handMap,e.dropmode.active&&(null===(t=e.dropmode.piece)||void 0===t?void 0:t.color)===o&&e.dropmode.piece.role===r))}else{let t=n.firstElementChild;for(;t;){const n=t.sgRole,i=(null===(r=e.hands.handMap.get(o))||void 0===r?void 0:r.get(n))||0;t.classList.toggle("selected",e.dropmode.active&&(null===(s=e.dropmode.piece)||void 0===s?void 0:s.color)===o&&e.dropmode.piece.role===n),t.dataset.nb=i.toString(),t=t.nextElementSibling}}}function to(e,o,n){const t=e.get(o);t?t.push(n):e.set(o,[n])}function ro(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(o,n){const t={pieces:re("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,notation:0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:250},hands:{enabled:!1,handMap:new Map,handRoles:["rook","bishop","gold","silver","knight","lance","pawn"]},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1},dropmode:{active:!1,fromHand:!0},selectable:{enabled:!0},promotion:{active:!1},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""}};function r(){const n="dom"in t?t.dom.unbind:void 0,r=t.viewOnly&&!t.drawable.visible,s=Xe(o,t,r),i=function(e){let o;const n=()=>(void 0===o&&(o=e()),o);return n.clear=()=>{o=void 0},n}((()=>s.pieces.getBoundingClientRect())),c=e=>{_e(d),qe(d),!e&&s.svg&&s.customSvg&&s.freePieces&&He(d,s.svg,s.customSvg,s.freePieces)},l=()=>{i.clear(),function(o){if(o.dom.relative)return;const n=oe(o),t=o.scaleDownPieces?.5:1,r=p(o.dimensions,o.dom.bounds());let s=o.dom.elements.pieces.firstElementChild;for(;s;)e(s)&&!s.sgAnimating&&g(s,r(a(s.sgKey),n),t),s=s.nextElementSibling}(d),qe(d),s.svg&&s.customSvg&&s.freePieces&&He(d,s.svg,s.customSvg,s.freePieces)},d=t;var u;return d.dom={elements:s,bounds:i,redraw:ro(c),redrawNow:c,unbind:n,relative:r},d.drawable.prevSvgHash="",c(!1),Ue(d,l),(u=d).hands.enabled&&!u.viewOnly&&u.dom.elements.handTop&&u.dom.elements.handBot&&(Ie(u,u.dom.elements.handBot),Ie(u,u.dom.elements.handTop)),n||(d.dom.unbind=function(e,o){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(Qe(document.body,"shogiground.resize",o)),!e.viewOnly){const o=Ve(e,Pe,ve),t=Ve(e,Le,be);for(const e of["touchmove","mousemove"])n.push(Qe(document,e,o));for(const e of["touchend","mouseup"])n.push(Qe(document,e,t));const r=()=>e.dom.bounds.clear();n.push(Qe(document,"scroll",r,{capture:!0,passive:!0})),n.push(Qe(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(d,l)),d.events.insert&&d.events.insert(s),d}return ie(t,n||{}),Ae(r(),r)}}();
