var Shogiground=function(){"use strict";function e(e){return"PIECE"===e.tagName}function o(e){return"SQ"===e.tagName}const n=["sente","gote"],t=["1","2","3","4","5","6","7","8","9"],r=["a","b","c","d","e","f","g","h","i"],s=Array.prototype.concat(...r.map((e=>t.map((o=>o+e))))),i=e=>s[e[0]+9*e[1]],a=e=>[e.charCodeAt(0)-49,e.charCodeAt(1)-97];function c(e){let o;const n=()=>(void 0===o&&(o=e()),o);return n.clear=()=>{o=void 0},n}const l=e=>"sente"===e?"gote":"sente",d=(e,o)=>{const n=e[0]-o[0],t=e[1]-o[1];return n*n+t*t},u=(e,o)=>e.role===o.role&&e.color===o.color,p=(e,o,n,t,r)=>[(n?o.files-1-e[0]:e[0])*t,(n?e[1]:o.ranks-1-e[1])*r],f=e=>(o,n)=>p(o,e,n,100,100),g=(e,o,n)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${n}`},h=(e,o,n)=>{e.style.transform=`translate(${o[0]*n}%,${o[1]*n}%) scale(${n})`},m=(e,o)=>{e.style.display=o?"":"none"},v=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},b=e=>2===e.buttons||2===e.button,w=(e,o)=>{const n=document.createElement(e);return o&&(n.className=o),n};function y(e){return`${e.color} ${e.role}`}function k(e,o,n,t){const r=a(e);return o&&(r[0]=n.files-1-r[0],r[1]=n.ranks-1-r[1]),[t.left+t.width*r[0]/n.files+t.width/(2*n.files),t.top+t.height*(n.ranks-1-r[1])/n.ranks+t.height/(2*n.ranks)]}function C(e,o,n){const t=a(e);let r=n.files-1-t[0]+t[1]*n.files;return o||(r=n.files*n.ranks-1-r),r}function B(e,o){return Math.abs(e-o)}const O=(e,o,n,t)=>B(e,n)===B(o,t),S=(e,o,n,t)=>e===n||o===t,M=(e,o,n,t)=>B(e,n)<2&&B(o,t)<2;const P=(e,o,n,t)=>M(e,o,n,t)||O(e,o,n,t),D=(e,o,n,t)=>M(e,o,n,t)||S(e,o,n,t),L=s.map(a);function T(e,o,n){const t=e.get(o);if(!t)return[];const r=a(o),s=t.role,c="pawn"===s?(l=t.color,(e,o,n,t)=>"sente"===l?e===n&&o-1===t:e===n&&o+1===t):"knight"===s?function(e){return(o,n,t,r)=>1===B(o,t)&&2===B(n,r)&&("sente"===e?r<n:r>n)}(t.color):"bishop"===s?O:"rook"===s?S:"king"===s?M:"silver"===s?function(e){return(o,n,t,r)=>B(o,t)<2&&B(n,r)<2&&n!==r&&("sente"===e?o!==t||r<n:o!==t||r>n)}(t.color):"lance"===s?function(e){return(o,n,t,r)=>"sente"===e?o===t&&r<n:o===t&&n<r}(t.color):"horse"===s?P:"dragon"===s?D:function(e){return(o,n,t,r)=>B(o,t)<2&&B(n,r)<2&&("sente"===e?r<=n||o===t:r>=n||o===t)}(t.color);var l;return L.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&c(r[0],r[1],e[0],e[1])&&e[0]<n.files&&e[1]<n.ranks)).map(i)}function E(e,o,n){return"sente"===n?0===o[1]:o[1]===e.ranks-1}function q(e,o,n){const t=o.color,r=o.role;return s.filter((o=>{const s=e.get(o),i=a(o);return(!s||s.color!==t)&&i[0]<n.files&&i[1]<n.ranks&&("pawn"===r||"lance"===r?!E(n,i,t):"knight"!==r||!function(e,o,n){return E(e,o,n)||("sente"===n?1===o[1]:o[1]===e.ranks-2)}(n,i,t))}))}function A(e,...o){e&&setTimeout((()=>e(...o)),1)}function R(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.selected=e.selectedPiece=void 0}function x(e){e.lastDests=void 0,e.animation.current=e.draggable.current=void 0,V(e),H(e),$(e)}function H(e){e.premovable.current&&(e.premovable.current=void 0,A(e.premovable.events.unset))}function $(e){e.predroppable.current&&(e.predroppable.current=void 0,A(e.predroppable.events.unset))}function K(e,o,n){const t=e.pieces.get(o),r=e.pieces.get(n);if(o===n||!t)return!1;const s=r&&r.color!==t.color?r:void 0;return n===e.selected&&V(e),A(e.events.move,o,n,s),e.pieces.set(n,t),e.pieces.delete(o),e.lastDests=[o,n],e.check=void 0,A(e.events.change),s||!0}function N(e,o,n,t){return!(e.pieces.has(n)&&!e.droppable.free)&&(A(e.events.drop,o,n),e.pieces.set(n,o),e.lastDests=[n],t||X(e,o),e.check=void 0,A(e.events.change),!0)}function W(e,o,n){const t=K(e,o,n);return t&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),t}function z(e,o,n,t){const r=N(e,o,n,t);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),r}function F(e,o,n,t){if(ee(e,o,n)){if(z(e,o,n,t))return V(e),A(e.droppable.events.after,o,n,{premove:!1,predrop:!1}),!0}else if(function(e,o,n){const t=e.pieces.get(n);return ne(e,o)&&(!t||t.color!==e.activeColor)&&q(e.pieces,o,e.dimensions).includes(n)}(e,o,n))return function(e,o,n){H(e),e.predroppable.current={piece:o,key:n},A(e.predroppable.events.set,o,n)}(e,o,n),V(e),!0;return V(e),!1}function G(e,o,n){if(J(e,o,n)){const t=W(e,o,n);if(t){V(e);const r={premove:!1,predrop:!1};return!0!==t&&(r.captured=t),A(e.movable.events.after,o,n,r),!0}}else if(function(e,o,n){return o!==n&&oe(e,o)&&T(e.pieces,o,e.dimensions).includes(n)}(e,o,n))return function(e,o,n){$(e),e.premovable.current=[o,n],A(e.premovable.events.set,o,n)}(e,o,n),V(e),!0;return V(e),!1}function j(e,o,n=1){const t=e.hands.handMap.get(o.color);t&&e.hands.roles.includes(o.role)&&t.set(o.role,(t.get(o.role)||0)+n)}function X(e,o,n=1){const t=e.hands.handMap.get(o.color),r=null==t?void 0:t.get(o.role);t&&r&&t.set(o.role,Math.max(r-n,0))}function Y(e,o,n,t){if(A(e.events.select,o),e.selectedPiece){if(F(e,e.selectedPiece,o,n))return}else if(e.selected){if(e.selected===o&&!e.draggable.enabled)return void V(e);if((e.selectable.enabled||t)&&e.selected!==o&&G(e,e.selected,o))return}(Z(e,o)||oe(e,o))&&I(e,o)}function U(e,o){A(e.events.pieceSelect,o),!e.draggable.enabled&&e.selectedPiece&&u(e.selectedPiece,o)?V(e):(_(e,o)||ne(e,o))&&Q(e,o)}function I(e,o){V(e),e.selected=o,oe(e,o)&&(e.premovable.dests=T(e.pieces,o,e.dimensions))}function Q(e,o){V(e),e.selectedPiece=o,ne(e,o)&&(e.predroppable.dests=q(e.pieces,o,e.dimensions))}function V(e){e.selected=void 0,e.selectedPiece=void 0,e.premovable.dests=void 0,e.predroppable.dests=void 0}function Z(e,o){const n=e.pieces.get(o);return!!n&&("both"===e.activeColor||e.activeColor===n.color&&e.turnColor===n.color)}function _(e,o){return"both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color}function J(e,o,n){var t,r;return o!==n&&Z(e,o)&&(e.movable.free||!!(null===(r=null===(t=e.movable.dests)||void 0===t?void 0:t.get(o))||void 0===r?void 0:r.includes(n)))}function ee(e,o,n){var t,r;return _(e,o)&&(e.droppable.free||!!(null===(r=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(o.role))||void 0===r?void 0:r.includes(n)))}function oe(e,o){const n=e.pieces.get(o);return!!n&&e.premovable.enabled&&e.activeColor===n.color&&e.turnColor!==n.color}function ne(e,o){return e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function te(e,o){return e.draggable.enabled&&("both"===e.activeColor||e.activeColor===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function re(e){const o=e.premovable.current;if(!o)return!1;const n=o[0],t=o[1];let r=!1;if(J(e,n,t)){const o=W(e,n,t);if(o){const s={premove:!0,predrop:!1};!0!==o&&(s.captured=o),A(e.movable.events.after,n,t,s),r=!0}}return H(e),r}function se(e){H(e),$(e),V(e)}function ie(e){e.activeColor=e.movable.dests=e.droppable.dests=e.draggable.current=e.animation.current=void 0,se(e)}function ae(e,o,n,t){let r=Math.floor(n.files*(e[0]-t.left)/t.width);o&&(r=n.files-1-r);let s=Math.floor(n.ranks*(e[1]-t.top)/t.height);return o||(s=n.ranks-1-s),r>=0&&r<n.files&&s>=0&&s<n.ranks?i([r,s]):void 0}function ce(e){return"sente"===e.orientation}function le(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const de={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function ue(e,o){const n=new Map;let t=o.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return n;case"/":if(++r,r>o.ranks-1)return n;t=o.files-1;break;default:{const o=e[s].charCodeAt(0);if(o<58&&o>47)t-=o-48;else{const o=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=le(o);if(t>=0&&a){const c=e[s]===o||"+"+e[s]===o?"gote":"sente";n.set(i([t,r]),{role:a,color:c})}--t}}}return n}function pe(e,o){o.animation&&(ge(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function fe(e,o){var n,t,r,s,i;(null===(n=o.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(t=o.droppable)||void 0===t?void 0:t.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),ge(e,o),(null===(s=o.sfen)||void 0===s?void 0:s.board)&&(e.dimensions=function(e){const o=e.split("/"),n=o[0].split("");let t=0,r=0;for(const e of n){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:(t+=r+1,r=0)}return t+=r,{files:t,ranks:o.length}}(o.sfen.board),e.pieces=ue(o.sfen.board,e.dimensions),e.drawable.shapes=[]),(null===(i=o.sfen)||void 0===i?void 0:i.hands)&&(e.hands.handMap=function(e){const o=new Map,n=new Map;let t=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)t=10*t+i-48,r=t;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=le(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):n.set(a,(n.get(a)||0)+r)),t=0,r=1}}return new Map([["sente",o],["gote",n]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[n,t]of e.pieces)"king"===t.role&&t.color===o&&(e.check=n)}(e,o.check||!1),"lastDests"in o&&!o.lastDests?e.lastDests=void 0:o.lastDests&&(e.lastDests=o.lastDests),e.selected&&I(e,e.selected),e.selectedPiece&&Q(e,e.selectedPiece),pe(e,o)}function ge(e,o){for(const n in o)he(e[n])&&he(o[n])?ge(e[n],o[n]):e[n]=o[n]}function he(e){return"object"==typeof e}function me(e,o){return o.animation.enabled?function(e,o){const t=new Map(o.pieces),r=new Map([["sente",new Map(o.hands.handMap.get("sente")||new Map)],["gote",new Map(o.hands.handMap.get("gote")||new Map)]]),i=e(o),a=function(e,o,t){const r=new Map,i=[],a=new Map,c=[],l=[],d=new Map;for(const[o,n]of e)d.set(o,be(o,n));for(const e of s){const o=t.pieces.get(e),n=d.get(e);o?n?u(o,n.piece)||(c.push(n),l.push(be(e,o))):l.push(be(e,o)):n&&c.push(n)}if(t.animation.hands){const e=t.dom.boardBounds(),r=t.dom.handPiecesBounds();for(const s of n){const n=t.hands.handMap.get(s),i=o.get(s);if(i&&n)for(const[o,a]of n){const n={role:o,color:s},l=r.get(y(n)),d=i.get(o);l&&d&&d>a&&c.push({pos:ye(l,ce(t),t.dimensions,e),piece:n})}}}for(const e of l){const o=we(e,c.filter((o=>u(e.piece,o.piece))));if(o){const n=[o.pos[0]-e.pos[0],o.pos[1]-e.pos[1]];r.set(e.key,n.concat(n)),o.key&&i.push(o.key)}}for(const e of c)e.key&&!i.includes(e.key)&&a.set(e.key,e.piece);return{anims:r,fadings:a}}(t,r,o);if(a.anims.size||a.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:a},e||ke(o,performance.now())}else o.dom.redraw();return i}(e,o):ve(e,o)}function ve(e,o){const n=e(o);return o.dom.redraw(),n}function be(e,o){return{key:e,pos:a(e),piece:o}}function we(e,o){return o.sort(((o,n)=>d(e.pos,o.pos)-d(e.pos,n.pos)))[0]}function ye(e,o,n,t){const r=t.width/n.files,s=t.height/n.ranks;let i=(e.left-t.left)/r;o&&(i=n.files-1-i);let a=(e.top-t.top)/s;return o||(a=n.ranks-1-a),[i,a]}function ke(e,o){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const t=1-(o-n.start)*n.frequency;if(t<=0)e.animation.current=void 0,e.dom.redrawNow();else{const o=(r=t)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;e.dom.redrawNow(!0),requestAnimationFrame(((o=performance.now())=>ke(e,o)))}var r}const Ce=["green","red","blue","yellow"];function Be(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?V(e):se(e);const n=v(o),t=ae(n,ce(e),e.dimensions,e.dom.boardBounds()),r=e.drawable.piece;t&&(e.drawable.current={orig:t,pos:n,piece:r,brush:De(o)},Oe(e))}function Oe(e){requestAnimationFrame((()=>{const o=e.drawable.current;if(o){const n=ae(o.pos,ce(e),e.dimensions,e.dom.boardBounds());n!==o.mouseSq&&(o.mouseSq=n,o.dest=n!==o.orig?n:void 0,e.dom.redrawNow()),Oe(e)}}))}function Se(e,o){e.drawable.current&&(e.drawable.current.pos=v(o))}function Me(e){const o=e.drawable.current;o&&(o.mouseSq&&function(e,o){const n=e=>e.orig===o.orig&&e.dest===o.dest,t=o.piece;o.dest&&(o.piece=void 0);const r=e.shapes.find(n),s=e.shapes.find((e=>e.orig===o.orig&&e.piece&&t&&!u(e.piece,t)));r&&(e.shapes=e.shapes.filter((e=>!n(e))));r&&r.brush===o.brush||e.shapes.push(o);(!!t!=!!o.piece||s)&&e.shapes.push({orig:o.orig,brush:o.brush,piece:t});Le(e)}(e.drawable,o),Pe(e))}function Pe(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function De(e){var o;const n=(e.shiftKey||e.ctrlKey)&&b(e),t=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return Ce[(n?1:0)+(t?2:0)]}function Le(e){e.onChange&&e.onChange(e.shapes)}function Te(e,o){const n=e.dom.boardBounds(),t=v(o),r=t&&ae(t,ce(e),e.dimensions,n);if(!r)return;const s=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Le(a.drawable)),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||e.selectedPiece||s||i||function(e,o){const n=ce(e),t=e.dom.boardBounds(),r=Math.pow(t.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=k(s,n,e.dimensions,t);if(d(i,o)<=r)return!0}return!1}(e,t))&&o.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.spares.deleteOnTouch&&s?e.pieces.delete(r):e.selectedPiece&&ee(e,e.selectedPiece,r)||e.selected&&J(e,e.selected,r)?me((o=>Y(o,r,e.spares.active)),e):Y(e,r,e.spares.active);const u=e.selected===r,p=e.dom.elements.dragged;if(s&&p&&u&&te(e,s)){const n="touchstart"===o.type;e.draggable.current={piece:s,pos:t,origPos:t,started:e.draggable.autoDistance&&!n,touch:n,originTarget:o.target,fromBoard:{orig:r,previouslySelected:i,keyHasChanged:!1}},p.sgColor=s.color,p.sgRole=s.role,p.className=`dragging ${y(s)}`,p.classList.toggle("touch",n),qe(e)}else c&&H(e),l&&$(e);e.dom.redraw()}function Ee(e,o,n,t){const r=e.selectedPiece,s=e.dom.elements.dragged,i=v(n),a="touchstart"===n.type;if(!s)return;U(e,o),e.dom.redraw();const c=!!e.premovable.current,l=!!e.predroppable.current;te(e,o)?(e.draggable.current={piece:o,pos:i,origPos:i,touch:a,started:e.draggable.autoDistance&&!a,originTarget:n.target,fromOutside:{originBounds:e.dom.handPiecesBounds().get(y(o)),leftOrigin:!1,previouslySelectedPiece:r,spare:t}},s.sgColor=o.color,s.sgRole=o.role,s.className=`dragging ${y(o)}`,s.classList.toggle("touch",a),qe(e)):(c&&H(e),l&&$(e))}function qe(e){requestAnimationFrame((()=>{var o,n;const t=e.draggable.current,r=e.dom.elements.dragged;if(!t||!r)return;(null===(o=t.fromBoard)||void 0===o?void 0:o.orig)&&(null===(n=e.animation.current)||void 0===n?void 0:n.plan.anims.has(t.fromBoard.orig))&&(e.animation.current=void 0);const s=t.fromBoard?e.pieces.get(t.fromBoard.orig):t.piece;if(s&&u(s,t.piece)){if(!t.started&&d(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0,e.dom.redraw()),t.started){const o=e.dom.boardBounds();g(r,[t.pos[0]-o.left-o.width/(2*e.dimensions.files),t.pos[1]-o.top-o.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),r.sgDragging||(r.sgDragging=!0,m(r,!0));const n=ae(t.pos,ce(e),e.dimensions,o);if(t.fromBoard?t.fromBoard.keyHasChanged=t.fromBoard.keyHasChanged||t.fromBoard.orig!==n:t.fromOutside&&(t.fromOutside.leftOrigin=t.fromOutside.leftOrigin||!!t.fromOutside.originBounds&&!$e(t.fromOutside.originBounds,t.pos)),n!==t.hovering){const r=t.hovering;t.hovering=n,function(e,o){var n;const t=ce(e),r=e.dom.elements.squares.children,s=(null===(n=e.draggable.current)||void 0===n?void 0:n.hovering)&&C(e.draggable.current.hovering,t,e.dimensions),i=s&&r[s];i&&i.classList.add("hover");const a=o&&C(o,t,e.dimensions),c=a&&r[a];c&&c.classList.remove("hover")}(e,r),t.touch&&e.dom.elements.squareOver&&(n&&e.draggable.showTouchSquareOverlay?(g(e.dom.elements.squareOver,((e,o)=>{const n=o.width/e.files,t=o.height/e.ranks;return(o,r)=>p(o,e,r,n,t)})(e.dimensions,o)(a(n),ce(e)),1),m(e.dom.elements.squareOver,!0)):m(e.dom.elements.squareOver,!1))}}}else xe(e);qe(e)}))}function Ae(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=v(o))}function Re(e,o){var n,t,r;const s=e.draggable.current;if(!s)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&s.originTarget!==o.target&&!s.fromOutside)return void(e.draggable.current=void 0);H(e),$(e);const i=ae(v(o)||s.pos,ce(e),e.dimensions,e.dom.boardBounds());if(i&&s.started&&(null===(n=s.fromBoard)||void 0===n?void 0:n.orig)!==i)s.fromOutside?F(e,s.piece,i,s.fromOutside.spare):s.fromBoard&&G(e,s.fromBoard.orig,i);else if(e.draggable.deleteOnDropOff&&!i){if(s.fromBoard?e.pieces.delete(s.fromBoard.orig):s.fromOutside&&X(e,s.piece),e.draggable.addToHandOnDropOff){const o=e.dom.handsBounds(),n=o.get("top"),t=o.get("bottom");n&&$e(n,s.pos)?j(e,{color:l(e.orientation),role:s.piece.role}):t&&$e(t,s.pos)&&j(e,{color:e.orientation,role:s.piece.role})}A(e.events.change)}!s.fromBoard||s.fromBoard.orig!==s.fromBoard.previouslySelected&&!s.fromBoard.keyHasChanged||s.fromBoard.orig!==i&&i?(null===(t=s.fromOutside)||void 0===t?void 0:t.leftOrigin)||(null===(r=s.fromOutside)||void 0===r?void 0:r.originBounds)&&$e(s.fromOutside.originBounds,s.pos)&&s.fromOutside.previouslySelectedPiece&&u(s.fromOutside.previouslySelectedPiece,s.piece)?V(e):e.selectable.enabled||V(e):V(e),e.draggable.current=void 0,e.dom.redraw()}function xe(e){e.draggable.current&&(e.draggable.current=void 0,V(e),e.dom.redraw())}function He(e){return!e.isTrusted||void 0!==e.button&&0!==e.button||!!e.touches&&e.touches.length>1}function $e(e,o){return e.left<=o[0]&&e.top<=o[1]&&e.left+e.width>o[0]&&e.top+e.height>o[1]}function Ke(e){e.promotion.active=!1,e.promotion.key=void 0,e.promotion.pieces=void 0}function Ne(e,o){return{set(n){var t,r;let s=!1;n.orientation&&n.orientation!==e.orientation&&(R(e),s=!0),void 0!==n.viewOnly&&n.viewOnly!==e.viewOnly&&(e.viewOnly=n.viewOnly,x(e),s=!0),void 0!==n.viewOnly&&n.viewOnly!==e.viewOnly&&(e.viewOnly=n.viewOnly,x(e),s=!0),void 0!==(null===(t=n.hands)||void 0===t?void 0:t.roles)&&n.hands.roles!==e.hands.roles&&(e.hands.roles=n.hands.roles,s=!0),s&&o(),pe(e,n),((null===(r=n.sfen)||void 0===r?void 0:r.board)?me:ve)((e=>fe(e,n)),e)},state:e,getBoardSfen:()=>function(e,o){const n=t.slice(o.files).reverse();return r.slice(o.ranks).map((o=>n.map((n=>{const t=e.get(n+o);if(t){const e=de[t.role];return"sente"===t.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var n,t;let r="",s="";for(const i of o){const o=null===(n=e.get("sente"))||void 0===n?void 0:n.get(i),a=null===(t=e.get("gote"))||void 0===t?void 0:t.get(i);o&&(r+=o>1?o.toString()+de[i]:de[i]),a&&(s+=a>1?a.toString()+de[i]:de[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.roles),toggleOrientation:function(){R(e),o()},move(o,n){me((e=>K(e,o,n)),e)},drop(o,n,t){me((e=>N(e,o,n,t)),e)},setPieces(o){me((e=>function(e,o){for(const[n,t]of o)t?e.pieces.set(n,t):e.pieces.delete(n)}(e,o)),e)},addToHand(o,n){ve((e=>j(e,o,n)),e)},removeFromHand(o,n){ve((e=>X(e,o,n)),e)},startPromotion(o,n){ve((e=>function(e,o,n){e.promotion.active=!0,e.promotion.key=o,e.promotion.pieces=n}(e,o,n)),e)},stopPromotion(){ve((e=>Ke(e)),e)},selectSquare(o,n,t){o?me((e=>Y(e,o,n,t)),e):e.selected&&(V(e),e.dom.redraw())},selectPiece(o){o?ve((e=>U(e,o)),e):e.selectedPiece&&(V(e),e.dom.redraw())},playPremove(){if(e.premovable.current){if(me(re,e))return!0;e.dom.redraw()}return!1},playPredrop(){if(e.predroppable.current){const o=function(e){const o=e.predroppable.current;let n=!1;return!!o&&(ee(e,o.piece,o.key)&&z(e,o.piece,o.key)&&(A(e.droppable.events.after,o.piece,o.key,{premove:!1,predrop:!0}),n=!0),$(e),n)}(e);return e.dom.redraw(),o}return!1},cancelPremove(){ve(H,e)},cancelPredrop(){ve($,e)},cancelMove(){ve((e=>{se(e),xe(e)}),e)},stop(){ve((e=>{ie(e),xe(e)}),e)},setAutoShapes(o){ve((e=>e.drawable.autoShapes=o),e)},setShapes(o){ve((e=>e.drawable.shapes=o),e)},getKeyAtDomPos:o=>ae(o,ce(e),e.dimensions,e.dom.boardBounds()),redrawAll:o,dragNewPiece(o,n,t){Ee(e,o,n,t)},destroy(){ie(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function We(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function ze(e,o,n,t){const r=e.drawable,s=r.current,i=s&&s.mouseSq?s:void 0,c=new Map,l=new Map;for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[]))e.dest&&c.set(e.dest,(c.get(e.dest)||0)+1);for(const e of r.shapes.concat(i?[i]:[]).concat(r.autoShapes))e.piece&&l.set(e.orig,e);const d=[...l.values()].map((e=>({shape:e,hash:Ge(e,c,!1)}))),u=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:Ge(e,c,!1)})));i&&u.push({shape:i,current:!0,hash:Ge(i,c,!0)});const p=u.map((e=>e.hash)).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;const g=o.querySelector("defs"),m=o.querySelector("g"),v=n.querySelector("g");!function(e,o,n){const t=new Map;let r;for(const n of o)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=Ve(r,n.shape.modifiers)),t.set(r.key,r));const s=new Set;let i=n.firstElementChild;for(;i;)s.add(i.getAttribute("sgKey")),i=i.nextElementSibling;for(const[e,o]of t.entries())s.has(e)||n.appendChild(Ue(o))}(r,u,g),Fe(u.filter((e=>!e.shape.customSvg)),m,(o=>Ye(e,o,r.brushes,c))),Fe(u.filter((e=>e.shape.customSvg)),v,(o=>Ye(e,o,r.brushes,c))),Fe(d,t,(o=>function(e,{shape:o,hash:n}){var t;if(!o.piece)return;const r=o.orig,s=((null===(t=o.piece)||void 0===t?void 0:t.scale)||1)*(e.scaleDownPieces?.5:1),i=w("piece",y(o.piece));return i.setAttribute("sgHash",n),i.sgKey=r,i.sgScale=s,h(i,f(e.dimensions)(a(r),ce(e)),s),i}(e,o)))}function Fe(e,o,n){const t=new Map,r=[];for(const o of e)t.set(o.hash,!1);let s,i=o.firstElementChild;for(;i;)s=i.getAttribute("sgHash"),t.has(s)?t.set(s,!0):r.push(i),i=i.nextElementSibling;for(const e of r)o.removeChild(e);for(const r of e)if(!t.get(r.hash)){const e=n(r);e&&o.appendChild(e)}}function Ge({orig:e,dest:o,brush:n,piece:t,modifiers:r,customSvg:s},i,a){return[a,e,o,n,o&&(i.get(o)||0)>1,t&&je(t),r&&(c=r,""+(c.lineWidth||"")),s&&Xe(s)].filter((e=>e)).join(",");var c}function je(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Xe(e){let o=0;for(let n=0;n<e.length;n++)o=(o<<5)-o+e.charCodeAt(n)>>>0;return"custom-"+o.toString()}function Ye(e,{shape:o,current:n,hash:t},r,s){const i=e.dimensions;let c;if(o.customSvg){const n=Qe(a(o.orig),e.orientation,i);c=function(e,o,n){const[t,r]=Je(o,n),s=Ie(We("g"),{transform:`translate(${t},${r})`}),i=Ie(We("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return s.appendChild(i),i.innerHTML=e,s}(o.customSvg,n,i)}else{const t=Qe(a(o.orig),e.orientation,i);if(o.dest){let l=r[o.brush];o.modifiers&&(l=Ve(l,o.modifiers)),c=function(e,o,n,t,r,s){const i=function(e){return(e?20:10)/64}(r&&!t),a=Je(o,s),c=Je(n,s),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),p=Math.cos(u)*i,f=Math.sin(u)*i;return Ie(We("line"),{stroke:e.color,"stroke-width":Ze(e,t),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:_e(e,t),x1:a[0],y1:a[1],x2:c[0]-p,y2:c[1]-f})}(l,t,Qe(a(o.dest),e.orientation,i),!!n,(s.get(o.dest)||0)>1,i)}else c=function(e,o,n,t){const r=Je(o,t),s=[3/64,4/64],i=.5;return Ie(We("circle"),{stroke:e.color,"stroke-width":s[n?0:1],fill:"none",opacity:_e(e,n),cx:r[0],cy:r[1],r:i-s[1]/2})}(r[o.brush],t,!!n,i)}return c.setAttribute("sgHash",t),c}function Ue(e){const o=Ie(We("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(Ie(We("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("sgKey",e.key),o}function Ie(e,o){for(const n in o)e.setAttribute(n,o[n]);return e}function Qe(e,o,n){return"sente"===o?[n.files-1-e[0],n.ranks-1-e[1]]:e}function Ve(e,o){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter((e=>e)).join("")}}function Ze(e,o){return(e.lineWidth||10)*(o?.85:1)/64}function _e(e,o){return(e.opacity||1)*(o?.9:1)}function Je(e,o){return[e[0],o.ranks-1-e[1]]}function eo(e,o){var t;e.board.innerHTML="",e.board.classList.add("sg-wrap",`d-${o.dimensions.files}x${o.dimensions.ranks}`);for(const t of n)e.board.classList.toggle("orientation-"+t,o.orientation===t);e.board.classList.toggle("manipulable",!o.viewOnly);const r=w("sg-board");e.board.appendChild(r);const s=function(e,o){const n=w("sg-squares");for(let t=0;t<e.ranks*e.files;t++){const r=w("sq");r.sgKey=i("sente"===o?[e.files-1-t%e.files,Math.floor(t/e.files)]:[t%e.files,e.files-1-Math.floor(t/e.files)]),n.appendChild(r)}return n}(o.dimensions,o.orientation);r.appendChild(s);const a=w("sg-pieces");let c,d,u,p,f,g,h,v;if(r.appendChild(a),o.viewOnly||(c=w("piece"),m(c,!!o.draggable.current),r.appendChild(c),d=w("sg-promotion"),m(d,o.promotion.active),r.appendChild(d),u=w("sg-square-over"),m(u,!!(null===(t=o.draggable.current)||void 0===t?void 0:t.touch)),r.appendChild(u)),(o.hands.inlined||e.handTop||e.handBottom)&&(p=no(l(o.orientation),o.hands.roles,"top"),f=no(o.orientation,o.hands.roles,"bottom"),o.hands.inlined?(e.board.insertBefore(p,r),e.board.insertBefore(f,r.nextElementSibling)):(e.handTop&&(e.handTop.innerHTML="",e.handTop.appendChild(p)),e.handBottom&&(e.handBottom.innerHTML="",e.handBottom.appendChild(f)))),o.drawable.visible&&(g=Ie(We("svg"),{class:"sg-shapes",viewBox:`-0.5 -0.5 ${o.dimensions.files} ${o.dimensions.ranks}`,preserveAspectRatio:"none"}),g.appendChild(We("defs")),g.appendChild(We("g")),h=Ie(We("svg"),{class:"sg-custom-svgs",viewBox:`0 0 ${o.dimensions.files} ${o.dimensions.ranks}`}),h.appendChild(We("g")),v=w("sg-free-pieces"),r.appendChild(g),r.appendChild(h),r.appendChild(v)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",n=function(e){switch(e){case 2:return["九","八","七","六","五","四","三","二","一"];case 3:return["i","h","g","f","e","d","c","b","a"];default:return["9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);r.appendChild(oo(n,"ranks"+e,o.dimensions.ranks)),r.appendChild(oo(["9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}return{board:r,squares:s,pieces:a,promotion:d,squareOver:u,dragged:c,svg:g,customSvg:h,freePieces:v,handTop:p,handBottom:f}}function oo(e,o,n){const t=w("coords",o);let r;for(const o of e.slice(-n))r=w("coord"),r.textContent=o,t.appendChild(r);return t}function no(e,o,n){const t=w("sg-hand",`hand-${n}`);for(const n of o){const o=w("piece",y({role:n,color:e}));o.sgColor=e,o.sgRole=n,t.appendChild(o)}return t}function to(o,n){if(o.resizable&&"ResizeObserver"in window&&new ResizeObserver(n).observe(o.dom.elements.board),o.viewOnly)return;const t=o.dom.elements.pieces,r=o.dom.elements.promotion,s=function(e){return o=>{e.draggable.current?xe(e):e.drawable.current?Pe(e):o.shiftKey||b(o)?e.drawable.enabled&&Be(e,o):e.viewOnly||He(o)||Te(e,o)}}(o);if(t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("mousedown",s,{passive:!1}),(o.disableContextMenu||o.drawable.enabled)&&t.addEventListener("contextmenu",(e=>e.preventDefault())),r){const n=n=>function(o,n){n.preventDefault();const t=o.promotion.key,r=n.target;if(o.promotion.active&&t&&r&&e(r)){const e={color:r.sgColor,role:r.sgRole};o.pieces.set(t,e),A(o.promotion.after,e)}else A(o.promotion.cancel);Ke(o),m(o.dom.elements.promotion,!1),o.dom.redraw()}(o,n);r.addEventListener("click",n,{passive:!1}),o.disableContextMenu&&r.addEventListener("contextmenu",(e=>e.preventDefault()))}}function ro(e,o){e.resizable&&"ResizeObserver"in window&&new ResizeObserver((()=>{e.dom.boardBounds.clear(),e.dom.handPiecesBounds.clear(),e.dom.handsBounds.clear()})).observe(o),o.addEventListener("mousedown",ao(e),{passive:!1}),o.addEventListener("touchstart",ao(e),{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function so(e,o,n,t){return e.addEventListener(o,n,t),()=>e.removeEventListener(o,n,t)}function io(e,o,n){return t=>{e.drawable.current?e.drawable.enabled&&n(e,t):e.viewOnly||o(e,t)}}function ao(o){return n=>{var t;const r=n.target;if(e(r)){const e={color:r.sgColor,role:r.sgRole};n.shiftKey||b(n)?(o.drawable.piece&&u(o.drawable.piece,e)?o.drawable.piece=void 0:o.drawable.piece=e,o.dom.redraw()):o.viewOnly||He(n)||(o.spares.deleteOnTouch?(X(o,e),o.dom.redraw()):"both"!==o.activeColor&&o.activeColor!==e.color||!(null===(t=o.hands.handMap.get(e.color))||void 0===t?void 0:t.get(e.role))||(!1!==n.cancelable&&n.preventDefault(),Ee(o,e,n)))}}}function co(n){var t,r;const s=ce(n),i=n.scaleDownPieces?.5:1,c=f(n.dimensions),l=n.dom.elements.squares,d=n.dom.elements.pieces,u=n.dom.elements.dragged,p=n.dom.elements.squareOver,g=n.dom.elements.handTop,v=n.dom.elements.handBottom,b=n.pieces,k=n.animation.current,C=k?k.plan.anims:new Map,B=k?k.plan.fadings:new Map,O=n.draggable.current,S=function(e){var o,n,t;const r=new Map;if(e.lastDests&&e.highlight.lastDests)for(const o of e.lastDests)uo(r,o,"last-dest");e.check&&e.highlight.check&&uo(r,e.check,"check");(null===(o=e.draggable.current)||void 0===o?void 0:o.hovering)&&uo(r,e.draggable.current.hovering,"hover");if(e.selected){if("both"===e.activeColor||e.activeColor===e.turnColor?uo(r,e.selected,"selected"):uo(r,e.selected,"preselected"),e.movable.showDests){const o=null===(n=e.movable.dests)||void 0===n?void 0:n.get(e.selected);if(o)for(const n of o)uo(r,n,"dest"+(e.pieces.has(n)?" oc":""));const t=e.premovable.dests;if(t)for(const o of t)uo(r,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.selectedPiece&&e.droppable.showDests){const o=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(e.selectedPiece.role);if(o)for(const e of o)uo(r,e,"dest");const n=e.predroppable.dests;if(n)for(const o of n)uo(r,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}const s=e.premovable.current;if(s)for(const e of s)uo(r,e,"current-pre");else e.predroppable.current&&uo(r,e.predroppable.current.key,"current-pre");return r}(n),M=new Set,P=new Map;let D,L,T,E,q,A,R,x;for(!O&&(null==u?void 0:u.sgDragging)&&(u.sgDragging=!1,m(u,!1),p&&m(p,!1)),L=d.firstElementChild;L;){if(e(L))if(D=L.sgKey,T=b.get(D),q=C.get(D),A=B.get(D),E=y({color:L.sgColor,role:L.sgRole}),(null==O?void 0:O.started)&&(null===(t=O.fromBoard)||void 0===t?void 0:t.orig)===D?(L.classList.add("ghost"),L.sgGhost=!0):!L.sgGhost||O&&(null===(r=O.fromBoard)||void 0===r?void 0:r.orig)===D||(L.classList.remove("ghost"),L.sgDragging=!1),!A&&L.sgFading&&(L.sgFading=!1,L.classList.remove("fading")),T){if(q&&L.sgAnimating&&E===y(T)){const e=a(D);e[0]+=q[2],e[1]+=q[3],L.classList.add("anim"),h(L,c(e,s),i)}else L.sgAnimating&&(L.sgAnimating=!1,L.classList.remove("anim"),h(L,c(a(D),s),i));E!==y(T)||A&&L.sgFading?A&&E===y(A)?(L.classList.add("fading"),L.sgFading=!0):fo(P,E,L):M.add(D)}else fo(P,E,L);L=L.nextElementSibling}let H=l.firstElementChild;for(;H&&o(H);){const e=S.get(H.sgKey)||"";H.className=e,H=H.nextElementSibling}for(const[e,o]of b)if(q=C.get(e),!M.has(e))if(R=P.get(y(o)),x=R&&R.pop(),x){x.sgKey=e,x.sgFading&&(x.classList.remove("fading"),x.sgFading=!1);const o=a(e);q&&(x.sgAnimating=!0,x.classList.add("anim"),o[0]+=q[2],o[1]+=q[3]),h(x,c(o,s),i)}else{const n=w("piece",y(o)),t=a(e);n.sgColor=o.color,n.sgRole=o.role,n.sgKey=e,q&&(n.sgAnimating=!0,t[0]+=q[2],t[1]+=q[3]),h(n,c(t,s),i),d.appendChild(n)}g&&po(n,g),v&&po(n,v);for(const e of P.values())lo(n,e)}function lo(e,o){for(const n of o)e.dom.elements.pieces.removeChild(n)}function uo(e,o,n){const t=e.get(o);t?e.set(o,`${t} ${n}`):e.set(o,n)}function po(e,o){var n;let t=o.firstElementChild;for(;t;){const o={role:t.sgRole,color:t.sgColor},r=(null===(n=e.hands.handMap.get(o.color))||void 0===n?void 0:n.get(o.role))||0,s=!!e.selectedPiece&&u(o,e.selectedPiece);t.classList.toggle("selected",("both"===e.activeColor||e.activeColor===e.turnColor)&&s),t.classList.toggle("preselected","both"!==e.activeColor&&e.activeColor!==e.turnColor&&s),t.classList.toggle("drawing",!!e.drawable.piece&&u(e.drawable.piece,o)),t.classList.toggle("current-pre",!!e.predroppable.current&&u(e.predroppable.current.piece,o)),t.dataset.nb=r.toString(),t=t.nextElementSibling}}function fo(e,o,n){const t=e.get(o);t?t.push(n):e.set(o,[n])}function go(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame((()=>{e(),o=!1})))}}return function(e,o){const n={pieces:ue("lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL",{files:9,ranks:9}),dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,disableContextMenu:!1,resizable:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,notation:0},highlight:{lastDests:!0,check:!0},animation:{enabled:!0,hands:!0,duration:250},hands:{inlined:!1,handMap:new Map,roles:["rook","bishop","gold","silver","knight","lance","pawn"]},spares:{roles:["king","rook","bishop","gold","silver","knight","lance","pawn","dragon","horse","promotedsilver","promotedknight","promotedlance","tokin"],deleteOnTouch:!1,active:!1},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1,addToHandOnDropOff:!1},selectable:{enabled:!0},promotion:{active:!1},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""}};function t(){const o="dom"in n?n.dom.unbind:void 0,t=eo(e,n),r=c((()=>(console.log("getBoundingClientRect"),t.pieces.getBoundingClientRect()))),s=c((()=>{console.log("getBoundingClientRect2");const e=new Map;return t.handTop&&e.set("top",t.handTop.getBoundingClientRect()),t.handBottom&&e.set("bottom",t.handBottom.getBoundingClientRect()),e})),i=c((()=>{console.log("getBoundingClientRect3");const e=new Map;if(t.handTop){let o=t.handTop.firstElementChild;for(;o;){const n={role:o.sgRole,color:o.sgColor};e.set(y(n),o.getBoundingClientRect()),o=o.nextElementSibling}}if(t.handBottom){let o=t.handBottom.firstElementChild;for(;o;){const n={role:o.sgRole,color:o.sgColor};e.set(y(n),o.getBoundingClientRect()),o=o.nextElementSibling}}return e})),l=e=>{co(u),function(e){const o=e.dom.elements.promotion;if(!(e.promotion.active&&e.promotion.key&&e.promotion.pieces&&o))return;const n=ce(e),t=a(e.promotion.key),r=w("sg-promotion-square"),s=w("sg-promotion-choices");h(r,f(e.dimensions)(t,n),1),e.promotion.pieces.forEach((e=>{const o=w("piece",y(e));o.sgColor=e.color,o.sgRole=e.role,s.appendChild(o)})),o.innerHTML="",r.appendChild(s),o.appendChild(r),m(o,e.promotion.active)}(u),!e&&t.svg&&t.customSvg&&t.freePieces&&ze(u,t.svg,t.customSvg,t.freePieces)},d=()=>{r.clear(),s.clear(),i.clear()},u=n;var p;return u.dom={elements:t,boardBounds:r,handsBounds:s,handPiecesBounds:i,redraw:go(l),redrawNow:l,unbind:o},u.drawable.prevSvgHash="",l(!1),to(u,d),!(p=u).viewOnly&&p.dom.elements.handTop&&p.dom.elements.handBottom&&(ro(p,p.dom.elements.handTop),ro(p,p.dom.elements.handBottom)),o||(u.dom.unbind=function(e,o){const n=[];if(e.resizable&&!("ResizeObserver"in window)&&n.push(so(document.body,"shogiground.resize",o)),!e.viewOnly){const o=io(e,Ae,Se),t=io(e,Re,Me);for(const e of["touchmove","mousemove"])n.push(so(document,e,o));for(const e of["touchend","mouseup"])n.push(so(document,e,t));const r=()=>{e.dom.boardBounds.clear(),e.dom.handsBounds.clear(),e.dom.handPiecesBounds.clear()};n.push(so(document,"scroll",r,{capture:!0,passive:!0})),n.push(so(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(u,d)),u.events.insert&&u.events.insert(t),u}return fe(n,o||{}),Ne(t(),t)}}();
